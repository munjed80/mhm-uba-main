// enhanced-tasks.js ‚Äî Advanced task management with due date reminders, details popup, priority coding, and smart search
(function() {
  'use strict';
  
  // Enhanced tasks state
  let enhancedTasksState = {
    reminderInterval: null,
    lastReminderCheck: null,
    searchQuery: '',
    priorityFilter: 'all',
    dueDateFilter: 'all',
    tasksData: [],
    overdueNotified: new Set(),
    upcomingNotified: new Set()
  };
  
  /**
   * Initialize enhanced tasks system
   */
  function initEnhancedTasks() {
    console.log('üìã Initializing enhanced tasks with reminders, details, and smart search');
    
    // Setup due date reminder system
    setupDueDateReminders();
    
    // Setup task details popup
    setupTaskDetailsPopup();
    
    // Setup priority color coding
    setupPriorityColorCoding();
    
    // Setup smart search system
    setupSmartSearch();
    
    // Initial render
    renderEnhancedTasks();
    
    // Start reminder monitoring
    startReminderMonitoring();
    
    console.log('‚úì Enhanced tasks system initialized');
  }
  
  /**
   * Setup due date reminder system
   */
  function setupDueDateReminders() {
    // Check for due date reminders every minute
    enhancedTasksState.reminderInterval = setInterval(checkDueDateReminders, 60000);
    
    // Initial check
    setTimeout(checkDueDateReminders, 1000);
  }
  
  /**
   * Check for due date reminders
   */
  function checkDueDateReminders() {
    const store = window.ubaStore;
    if (!store || !store.tasks) return;
    
    const tasks = store.tasks.getAll();
    const now = new Date();
    
    tasks.forEach(task => {
      if (!task.due || task.status === 'done') return;
      
      const dueDate = new Date(task.due);
      const timeDiff = dueDate.getTime() - now.getTime();
      const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));
      
      // Check for overdue tasks
      if (timeDiff < 0 && !enhancedTasksState.overdueNotified.has(task.id)) {
        showDueDateReminder(task, 'overdue', Math.abs(daysDiff));
        enhancedTasksState.overdueNotified.add(task.id);
      }
      
      // Check for tasks due today
      else if (daysDiff === 0 && !enhancedTasksState.upcomingNotified.has(task.id)) {
        showDueDateReminder(task, 'today', 0);
        enhancedTasksState.upcomingNotified.add(task.id);
      }
      
      // Check for tasks due tomorrow
      else if (daysDiff === 1 && !enhancedTasksState.upcomingNotified.has(task.id)) {
        showDueDateReminder(task, 'tomorrow', 1);
        enhancedTasksState.upcomingNotified.add(task.id);
      }
      
      // Check for tasks due in 3 days (weekly reminder)
      else if (daysDiff === 3 && !enhancedTasksState.upcomingNotified.has(task.id)) {
        showDueDateReminder(task, 'upcoming', 3);
        enhancedTasksState.upcomingNotified.add(task.id);
      }\n    });\n    \n    enhancedTasksState.lastReminderCheck = now;\n  }\n  \n  /**\n   * Show due date reminder notification\n   */\n  function showDueDateReminder(task, type, days) {\n    let message, notificationType, title;\n    \n    switch (type) {\n      case 'overdue':\n        message = `Task \"${task.title}\" is ${days} day${days !== 1 ? 's' : ''} overdue`;\n        notificationType = 'error';\n        title = 'Overdue Task';\n        break;\n      case 'today':\n        message = `Task \"${task.title}\" is due today`;\n        notificationType = 'warning';\n        title = 'Task Due Today';\n        break;\n      case 'tomorrow':\n        message = `Task \"${task.title}\" is due tomorrow`;\n        notificationType = 'warning';\n        title = 'Task Due Tomorrow';\n        break;\n      case 'upcoming':\n        message = `Task \"${task.title}\" is due in ${days} days`;\n        notificationType = 'info';\n        title = 'Upcoming Task';\n        break;\n    }\n    \n    // Show notification\n    if (window.showToast) {\n      window.showToast(message, notificationType, {\n        title: title,\n        duration: type === 'overdue' ? 10000 : 5000,\n        action: {\n          text: 'View Task',\n          callback: () => showTaskDetails(task.id)\n        }\n      });\n    }\n    \n    // Create persistent notification for important reminders\n    if (type === 'overdue' || type === 'today') {\n      createDueDateNotificationBadge(task, type);\n    }\n  }\n  \n  /**\n   * Create due date notification badge\n   */\n  function createDueDateNotificationBadge(task, type) {\n    // Add visual indicators to task cards\n    const taskCards = document.querySelectorAll(`[data-task-id=\"${task.id}\"]`);\n    \n    taskCards.forEach(card => {\n      // Remove existing badges\n      const existingBadge = card.querySelector('.uba-due-badge');\n      if (existingBadge) existingBadge.remove();\n      \n      // Create new badge\n      const badge = document.createElement('div');\n      badge.className = `uba-due-badge uba-due-${type}`;\n      badge.innerHTML = `\n        <span class=\"uba-due-icon\">${type === 'overdue' ? 'üö®' : '‚ö†Ô∏è'}</span>\n        <span class=\"uba-due-text\">${type === 'overdue' ? 'Overdue' : 'Due Today'}</span>\n      `;\n      \n      // Add to card header\n      const header = card.querySelector('.uba-card-header, .uba-task-header');\n      if (header) {\n        header.appendChild(badge);\n      } else {\n        card.insertBefore(badge, card.firstChild);\n      }\n    });\n  }\n  \n  /**\n   * Start reminder monitoring\n   */\n  function startReminderMonitoring() {\n    // Check reminders when page becomes visible\n    document.addEventListener('visibilitychange', () => {\n      if (!document.hidden) {\n        checkDueDateReminders();\n      }\n    });\n    \n    // Check reminders when window gains focus\n    window.addEventListener('focus', checkDueDateReminders);\n  }\n  \n  /**\n   * Setup task details popup\n   */\n  function setupTaskDetailsPopup() {\n    createTaskDetailsModal();\n  }\n  \n  /**\n   * Create task details modal\n   */\n  function createTaskDetailsModal() {\n    if (document.getElementById('task-details-modal')) return;\n    \n    const modal = document.createElement('div');\n    modal.id = 'task-details-modal';\n    modal.className = 'uba-modal';\n    modal.style.display = 'none';\n    \n    modal.innerHTML = `\n      <div class=\"uba-modal-overlay\" onclick=\"closeTaskDetailsModal()\"></div>\n      <div class=\"uba-modal-content uba-modal-large\">\n        <div class=\"uba-modal-header\">\n          <h3 id=\"task-details-title\">Task Details</h3>\n          <button type=\"button\" class=\"uba-modal-close\" onclick=\"closeTaskDetailsModal()\">√ó</button>\n        </div>\n        <div class=\"uba-modal-body\">\n          <div class=\"uba-task-details\">\n            <!-- Task details will be rendered here -->\n          </div>\n        </div>\n        <div class=\"uba-modal-footer\">\n          <button type=\"button\" class=\"uba-btn-ghost\" onclick=\"closeTaskDetailsModal()\">Close</button>\n          <button type=\"button\" class=\"uba-btn-secondary\" onclick=\"editTaskFromDetails()\">Edit Task</button>\n          <button type=\"button\" class=\"uba-btn-primary\" onclick=\"completeTaskFromDetails()\">Mark Complete</button>\n        </div>\n      </div>\n    `;\n    \n    document.body.appendChild(modal);\n  }\n  \n  /**\n   * Show task details in modal\n   */\n  function showTaskDetails(taskId) {\n    const task = getTaskById(taskId);\n    if (!task) return;\n    \n    const modal = document.getElementById('task-details-modal');\n    const title = document.getElementById('task-details-title');\n    const detailsContainer = modal.querySelector('.uba-task-details');\n    \n    if (!modal || !detailsContainer) return;\n    \n    // Set title\n    if (title) {\n      title.textContent = task.title || 'Task Details';\n    }\n    \n    // Get linked project\n    const linkedProject = getTaskProject(task);\n    \n    // Calculate time information\n    const timeInfo = calculateTaskTimeInfo(task);\n    \n    // Render task details\n    detailsContainer.innerHTML = `\n      <div class=\"uba-task-overview\">\n        <div class=\"uba-overview-section\">\n          <h4>Task Information</h4>\n          <div class=\"uba-task-info-grid\">\n            <div><strong>Status:</strong> <span class=\"uba-status uba-status-${task.status}\">${formatTaskStatus(task.status)}</span></div>\n            <div><strong>Priority:</strong> <span class=\"uba-priority uba-priority-${task.priority || 'medium'}\">${formatPriority(task.priority || 'medium')}</span></div>\n            <div><strong>Created:</strong> ${formatDate(task.created_at)}</div>\n            <div><strong>Due Date:</strong> ${task.due ? formatDueDate(task.due) : 'Not set'}</div>\n          </div>\n          ${task.description ? `<div class=\"uba-task-description\"><h5>Description</h5><p>${task.description}</p></div>` : ''}\n        </div>\n        \n        ${timeInfo.html ? `<div class=\"uba-overview-section\">\n          <h4>Time Information</h4>\n          ${timeInfo.html}\n        </div>` : ''}\n        \n        ${linkedProject ? `<div class=\"uba-overview-section\">\n          <h4>Linked Project</h4>\n          <div class=\"uba-linked-project\" onclick=\"showProjectDetails('${linkedProject.id}')\">\n            <div class=\"uba-project-info\">\n              <h5>${linkedProject.name}</h5>\n              <p>Stage: <span class=\"uba-stage-badge uba-stage-${linkedProject.stage}\">${formatStage(linkedProject.stage)}</span></p>\n              ${linkedProject.client ? `<p>Client: ${linkedProject.client}</p>` : ''}\n            </div>\n            <button class=\"uba-btn-sm uba-btn-ghost\">View Project</button>\n          </div>\n        </div>` : ''}\n        \n        <div class=\"uba-overview-section\">\n          <h4>Task Actions</h4>\n          <div class=\"uba-task-actions-grid\">\n            <button class=\"uba-action-btn uba-action-edit\" onclick=\"editTaskFromDetails()\">\n              <span class=\"uba-action-icon\">‚úèÔ∏è</span>\n              <span>Edit Task</span>\n            </button>\n            <button class=\"uba-action-btn uba-action-duplicate\" onclick=\"duplicateTask('${task.id}')\">\n              <span class=\"uba-action-icon\">üìã</span>\n              <span>Duplicate</span>\n            </button>\n            <button class=\"uba-action-btn uba-action-move\" onclick=\"moveTaskToColumn('${task.id}')\">\n              <span class=\"uba-action-icon\">üîÑ</span>\n              <span>Move Status</span>\n            </button>\n            <button class=\"uba-action-btn uba-action-delete\" onclick=\"deleteTaskFromDetails('${task.id}')\">\n              <span class=\"uba-action-icon\">üóëÔ∏è</span>\n              <span>Delete</span>\n            </button>\n          </div>\n        </div>\n        \n        <div class=\"uba-overview-section\">\n          <h4>Activity Log</h4>\n          <div class=\"uba-activity-log\">\n            ${generateTaskActivityLog(task)}\n          </div>\n        </div>\n      </div>\n    `;\n    \n    // Show modal\n    modal.style.display = 'block';\n    modal.dataset.taskId = taskId;\n  }\n  \n  /**\n   * Calculate task time information\n   */\n  function calculateTaskTimeInfo(task) {\n    if (!task.due) return { html: null };\n    \n    const now = new Date();\n    const dueDate = new Date(task.due);\n    const timeDiff = dueDate.getTime() - now.getTime();\n    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));\n    \n    let statusClass, statusText, statusIcon;\n    \n    if (timeDiff < 0) {\n      statusClass = 'overdue';\n      statusText = `Overdue by ${Math.abs(daysDiff)} day${Math.abs(daysDiff) !== 1 ? 's' : ''}`;\n      statusIcon = 'üö®';\n    } else if (daysDiff === 0) {\n      statusClass = 'due-today';\n      statusText = 'Due today';\n      statusIcon = '‚ö†Ô∏è';\n    } else if (daysDiff === 1) {\n      statusClass = 'due-soon';\n      statusText = 'Due tomorrow';\n      statusIcon = 'üìÖ';\n    } else if (daysDiff <= 7) {\n      statusClass = 'due-week';\n      statusText = `Due in ${daysDiff} days`;\n      statusIcon = 'üìÖ';\n    } else {\n      statusClass = 'due-future';\n      statusText = `Due in ${daysDiff} days`;\n      statusIcon = 'üìÖ';\n    }\n    \n    return {\n      html: `\n        <div class=\"uba-time-status uba-time-${statusClass}\">\n          <span class=\"uba-time-icon\">${statusIcon}</span>\n          <span class=\"uba-time-text\">${statusText}</span>\n          <span class=\"uba-time-date\">${formatDate(task.due)}</span>\n        </div>\n      `\n    };\n  }\n  \n  /**\n   * Generate task activity log\n   */\n  function generateTaskActivityLog(task) {\n    const activities = [];\n    \n    // Created\n    if (task.created_at) {\n      activities.push({\n        action: 'created',\n        timestamp: task.created_at,\n        icon: '‚ú®',\n        text: 'Task created'\n      });\n    }\n    \n    // Updated\n    if (task.updated_at && task.updated_at !== task.created_at) {\n      activities.push({\n        action: 'updated',\n        timestamp: task.updated_at,\n        icon: '‚úèÔ∏è',\n        text: 'Task updated'\n      });\n    }\n    \n    // Status changes\n    if (task.status === 'done' && task.completed_at) {\n      activities.push({\n        action: 'completed',\n        timestamp: task.completed_at,\n        icon: '‚úÖ',\n        text: 'Task completed'\n      });\n    }\n    \n    // Sort by timestamp (newest first)\n    activities.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));\n    \n    if (activities.length === 0) {\n      return '<p class=\"uba-empty-state\">No activity recorded</p>';\n    }\n    \n    return activities.map(activity => `\n      <div class=\"uba-activity-item\">\n        <span class=\"uba-activity-icon\">${activity.icon}</span>\n        <span class=\"uba-activity-text\">${activity.text}</span>\n        <span class=\"uba-activity-time\">${formatTimeAgo(activity.timestamp)}</span>\n      </div>\n    `).join('');\n  }\n  \n  /**\n   * Setup priority color coding\n   */\n  function setupPriorityColorCoding() {\n    // Enhanced priority system with better visual indicators\n    enhanceExistingTaskCards();\n    \n    // Add priority filter\n    addPriorityFilter();\n  }\n  \n  /**\n   * Enhance existing task cards with priority coding\n   */\n  function enhanceExistingTaskCards() {\n    const taskCards = document.querySelectorAll('.uba-task-card, .uba-task-item');\n    \n    taskCards.forEach(card => {\n      const taskId = card.dataset.taskId || card.dataset.id;\n      if (!taskId) return;\n      \n      const task = getTaskById(taskId);\n      if (!task) return;\n      \n      // Add priority visual indicators\n      addPriorityIndicators(card, task);\n      \n      // Add due date indicators\n      addDueDateIndicators(card, task);\n      \n      // Add click handler for details popup\n      addTaskDetailsHandler(card, task);\n    });\n  }\n  \n  /**\n   * Add priority indicators to task card\n   */\n  function addPriorityIndicators(card, task) {\n    const priority = task.priority || 'medium';\n    \n    // Add priority class to card\n    card.classList.add(`uba-priority-${priority}`);\n    \n    // Add priority badge if not exists\n    if (!card.querySelector('.uba-priority-badge')) {\n      const badge = document.createElement('div');\n      badge.className = `uba-priority-badge uba-priority-${priority}`;\n      badge.innerHTML = `\n        <span class=\"uba-priority-dot\"></span>\n        <span class=\"uba-priority-label\">${formatPriority(priority)}</span>\n      `;\n      \n      // Add to card header or top\n      const header = card.querySelector('.uba-card-header, .uba-task-header');\n      if (header) {\n        header.appendChild(badge);\n      } else {\n        card.insertBefore(badge, card.firstChild);\n      }\n    }\n  }\n  \n  /**\n   * Add due date indicators to task card\n   */\n  function addDueDateIndicators(card, task) {\n    if (!task.due) return;\n    \n    const now = new Date();\n    const dueDate = new Date(task.due);\n    const timeDiff = dueDate.getTime() - now.getTime();\n    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));\n    \n    // Add due date class\n    if (timeDiff < 0) {\n      card.classList.add('uba-task-overdue');\n    } else if (daysDiff <= 1) {\n      card.classList.add('uba-task-due-soon');\n    } else if (daysDiff <= 7) {\n      card.classList.add('uba-task-due-week');\n    }\n    \n    // Add due date display if not exists\n    if (!card.querySelector('.uba-due-date-display')) {\n      const dueDateDisplay = document.createElement('div');\n      dueDateDisplay.className = 'uba-due-date-display';\n      dueDateDisplay.innerHTML = `\n        <span class=\"uba-due-icon\">üìÖ</span>\n        <span class=\"uba-due-text\">${formatDueDate(task.due)}</span>\n      `;\n      \n      // Add to card footer or bottom\n      const footer = card.querySelector('.uba-card-footer, .uba-task-footer');\n      if (footer) {\n        footer.appendChild(dueDateDisplay);\n      } else {\n        card.appendChild(dueDateDisplay);\n      }\n    }\n  }\n  \n  /**\n   * Add task details handler\n   */\n  function addTaskDetailsHandler(card, task) {\n    card.addEventListener('click', (e) => {\n      // Don't trigger if clicking on action buttons\n      if (e.target.closest('.uba-card-actions, .uba-task-actions')) return;\n      \n      showTaskDetails(task.id);\n    });\n  }\n  \n  /**\n   * Add priority filter\n   */\n  function addPriorityFilter() {\n    const controlsContainer = document.querySelector('.uba-controls-right, .uba-task-controls');\n    if (!controlsContainer || controlsContainer.querySelector('#task-priority-filter')) return;\n    \n    const filter = document.createElement('select');\n    filter.id = 'task-priority-filter';\n    filter.className = 'uba-select uba-select-compact';\n    filter.innerHTML = `\n      <option value=\"all\">All Priorities</option>\n      <option value=\"high\">üî¥ High Priority</option>\n      <option value=\"medium\">üü° Medium Priority</option>\n      <option value=\"low\">üü¢ Low Priority</option>\n    `;\n    \n    filter.addEventListener('change', filterTasksByPriority);\n    \n    // Insert before the last element (usually add button)\n    const lastChild = controlsContainer.lastElementChild;\n    if (lastChild) {\n      controlsContainer.insertBefore(filter, lastChild);\n    } else {\n      controlsContainer.appendChild(filter);\n    }\n  }\n  \n  /**\n   * Filter tasks by priority\n   */\n  function filterTasksByPriority(e) {\n    enhancedTasksState.priorityFilter = e.target.value;\n    applyTaskFilters();\n  }\n  \n  /**\n   * Setup smart search system\n   */\n  function setupSmartSearch() {\n    createSmartSearchInterface();\n  }\n  \n  /**\n   * Create smart search interface\n   */\n  function createSmartSearchInterface() {\n    const controlsContainer = document.querySelector('.uba-controls-left, .uba-task-controls');\n    if (!controlsContainer || controlsContainer.querySelector('#task-smart-search')) return;\n    \n    const searchContainer = document.createElement('div');\n    searchContainer.className = 'uba-smart-search';\n    searchContainer.innerHTML = `\n      <div class=\"uba-search-input-container\">\n        <input type=\"text\" id=\"task-smart-search\" class=\"uba-search-input\" placeholder=\"Search tasks...\">\n        <button type=\"button\" class=\"uba-search-clear\" id=\"task-search-clear\" style=\"display: none;\">√ó</button>\n      </div>\n      <div class=\"uba-search-filters\">\n        <select id=\"task-due-filter\" class=\"uba-select uba-select-compact\">\n          <option value=\"all\">All Dates</option>\n          <option value=\"overdue\">Overdue</option>\n          <option value=\"today\">Due Today</option>\n          <option value=\"week\">This Week</option>\n          <option value=\"month\">This Month</option>\n        </select>\n      </div>\n    `;\n    \n    controlsContainer.appendChild(searchContainer);\n    \n    // Setup search functionality\n    const searchInput = searchContainer.querySelector('#task-smart-search');\n    const clearButton = searchContainer.querySelector('#task-search-clear');\n    const dueFilter = searchContainer.querySelector('#task-due-filter');\n    \n    searchInput.addEventListener('input', handleSmartSearch);\n    searchInput.addEventListener('keydown', handleSearchKeydown);\n    clearButton.addEventListener('click', clearSearch);\n    dueFilter.addEventListener('change', filterTasksByDueDate);\n  }\n  \n  /**\n   * Handle smart search\n   */\n  function handleSmartSearch(e) {\n    const query = e.target.value.trim();\n    enhancedTasksState.searchQuery = query;\n    \n    // Show/hide clear button\n    const clearButton = document.getElementById('task-search-clear');\n    if (clearButton) {\n      clearButton.style.display = query ? 'block' : 'none';\n    }\n    \n    // Apply search with debouncing\n    clearTimeout(enhancedTasksState.searchTimeout);\n    enhancedTasksState.searchTimeout = setTimeout(() => {\n      applyTaskFilters();\n    }, 300);\n  }\n  \n  /**\n   * Handle search keydown\n   */\n  function handleSearchKeydown(e) {\n    if (e.key === 'Escape') {\n      clearSearch();\n    }\n  }\n  \n  /**\n   * Clear search\n   */\n  function clearSearch() {\n    const searchInput = document.getElementById('task-smart-search');\n    const clearButton = document.getElementById('task-search-clear');\n    \n    if (searchInput) searchInput.value = '';\n    if (clearButton) clearButton.style.display = 'none';\n    \n    enhancedTasksState.searchQuery = '';\n    applyTaskFilters();\n  }\n  \n  /**\n   * Filter tasks by due date\n   */\n  function filterTasksByDueDate(e) {\n    enhancedTasksState.dueDateFilter = e.target.value;\n    applyTaskFilters();\n  }\n  \n  /**\n   * Apply all task filters\n   */\n  function applyTaskFilters() {\n    const taskCards = document.querySelectorAll('.uba-task-card, .uba-task-item');\n    \n    taskCards.forEach(card => {\n      const taskId = card.dataset.taskId || card.dataset.id;\n      if (!taskId) return;\n      \n      const task = getTaskById(taskId);\n      if (!task) return;\n      \n      const shouldShow = (\n        matchesSearchQuery(task) &&\n        matchesPriorityFilter(task) &&\n        matchesDueDateFilter(task)\n      );\n      \n      // Apply filter with animation\n      if (shouldShow) {\n        card.style.display = '';\n        card.classList.remove('uba-filtered-out');\n        highlightSearchMatches(card, task);\n      } else {\n        card.style.display = 'none';\n        card.classList.add('uba-filtered-out');\n      }\n    });\n    \n    // Update filter counts\n    updateFilterCounts();\n  }\n  \n  /**\n   * Check if task matches search query\n   */\n  function matchesSearchQuery(task) {\n    if (!enhancedTasksState.searchQuery) return true;\n    \n    const query = enhancedTasksState.searchQuery.toLowerCase();\n    const searchableText = getTaskSearchableText(task).toLowerCase();\n    \n    return searchableText.includes(query);\n  }\n  \n  /**\n   * Get searchable text from task\n   */\n  function getTaskSearchableText(task) {\n    const parts = [];\n    \n    ['title', 'description', 'notes'].forEach(field => {\n      if (task[field]) {\n        parts.push(task[field]);\n      }\n    });\n    \n    // Add project name if linked\n    const project = getTaskProject(task);\n    if (project) {\n      parts.push(project.name, project.client || '');\n    }\n    \n    return parts.join(' ');\n  }\n  \n  /**\n   * Check if task matches priority filter\n   */\n  function matchesPriorityFilter(task) {\n    if (enhancedTasksState.priorityFilter === 'all') return true;\n    \n    const taskPriority = task.priority || 'medium';\n    return taskPriority === enhancedTasksState.priorityFilter;\n  }\n  \n  /**\n   * Check if task matches due date filter\n   */\n  function matchesDueDateFilter(task) {\n    if (enhancedTasksState.dueDateFilter === 'all') return true;\n    \n    if (!task.due) return enhancedTasksState.dueDateFilter === 'all';\n    \n    const now = new Date();\n    const dueDate = new Date(task.due);\n    const timeDiff = dueDate.getTime() - now.getTime();\n    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));\n    \n    switch (enhancedTasksState.dueDateFilter) {\n      case 'overdue':\n        return timeDiff < 0;\n      case 'today':\n        return daysDiff === 0;\n      case 'week':\n        return daysDiff >= 0 && daysDiff <= 7;\n      case 'month':\n        return daysDiff >= 0 && daysDiff <= 30;\n      default:\n        return true;\n    }\n  }\n  \n  /**\n   * Highlight search matches in task card\n   */\n  function highlightSearchMatches(card, task) {\n    if (!enhancedTasksState.searchQuery) {\n      // Remove existing highlights\n      card.querySelectorAll('.uba-search-highlight').forEach(el => {\n        el.outerHTML = el.textContent;\n      });\n      return;\n    }\n    \n    const query = enhancedTasksState.searchQuery;\n    const titleElement = card.querySelector('.uba-card-title, .uba-task-title');\n    \n    if (titleElement) {\n      highlightTextInElement(titleElement, query);\n    }\n  }\n  \n  /**\n   * Highlight text in element\n   */\n  function highlightTextInElement(element, query) {\n    if (!element || !query) return;\n    \n    const text = element.textContent;\n    const regex = new RegExp(`(${escapeRegExp(query)})`, 'gi');\n    \n    if (regex.test(text)) {\n      element.innerHTML = text.replace(regex, '<span class=\"uba-search-highlight\">$1</span>');\n    }\n  }\n  \n  /**\n   * Escape regex special characters\n   */\n  function escapeRegExp(string) {\n    return string.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n  }\n  \n  /**\n   * Update filter counts\n   */\n  function updateFilterCounts() {\n    const visibleCards = document.querySelectorAll('.uba-task-card:not([style*=\"display: none\"]), .uba-task-item:not([style*=\"display: none\"])');\n    const totalCards = document.querySelectorAll('.uba-task-card, .uba-task-item');\n    \n    // Update task count display if exists\n    const countDisplay = document.querySelector('.uba-task-count, #tasks-count');\n    if (countDisplay) {\n      const visibleCount = visibleCards.length;\n      const totalCount = totalCards.length;\n      \n      if (visibleCount !== totalCount) {\n        countDisplay.textContent = `${visibleCount} of ${totalCount} tasks`;\n      } else {\n        countDisplay.textContent = `${totalCount} tasks`;\n      }\n    }\n  }\n  \n  /**\n   * Render enhanced tasks\n   */\n  function renderEnhancedTasks() {\n    const store = window.ubaStore;\n    if (!store || !store.tasks) return;\n    \n    const tasks = store.tasks.getAll();\n    enhancedTasksState.tasksData = tasks;\n    \n    // Enhance existing task cards\n    setTimeout(() => {\n      enhanceExistingTaskCards();\n      applyTaskFilters();\n    }, 100);\n  }\n  \n  /**\n   * Utility functions\n   */\n  function getTaskById(taskId) {\n    const store = window.ubaStore;\n    if (!store || !store.tasks) return null;\n    \n    return store.tasks.get(taskId) || store.tasks.getAll().find(t => t.id === taskId);\n  }\n  \n  function getTaskProject(task) {\n    if (!task.project_id) return null;\n    \n    const store = window.ubaStore;\n    if (!store || !store.projects) return null;\n    \n    return store.projects.get(task.project_id);\n  }\n  \n  function formatTaskStatus(status) {\n    const statusNames = {\n      todo: 'To Do',\n      in_progress: 'In Progress',\n      done: 'Done'\n    };\n    return statusNames[status] || status;\n  }\n  \n  function formatPriority(priority) {\n    const priorityNames = {\n      high: 'High',\n      medium: 'Medium',\n      low: 'Low'\n    };\n    return priorityNames[priority] || priority;\n  }\n  \n  function formatStage(stage) {\n    const stageNames = {\n      lead: 'Lead',\n      in_progress: 'In Progress',\n      ongoing: 'Ongoing',\n      completed: 'Completed'\n    };\n    return stageNames[stage] || stage;\n  }\n  \n  function formatDate(date) {\n    if (!date) return 'Not set';\n    return new Date(date).toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric'\n    });\n  }\n  \n  function formatDueDate(date) {\n    if (!date) return 'No due date';\n    \n    const now = new Date();\n    const dueDate = new Date(date);\n    const timeDiff = dueDate.getTime() - now.getTime();\n    const daysDiff = Math.ceil(timeDiff / (1000 * 3600 * 24));\n    \n    if (timeDiff < 0) {\n      return `Overdue (${formatDate(date)})`;\n    } else if (daysDiff === 0) {\n      return 'Due today';\n    } else if (daysDiff === 1) {\n      return 'Due tomorrow';\n    } else {\n      return formatDate(date);\n    }\n  }\n  \n  function formatTimeAgo(timestamp) {\n    const now = new Date();\n    const date = new Date(timestamp);\n    const diffInMs = now - date;\n    const diffInMinutes = Math.floor(diffInMs / (1000 * 60));\n    const diffInHours = Math.floor(diffInMs / (1000 * 60 * 60));\n    const diffInDays = Math.floor(diffInMs / (1000 * 60 * 60 * 24));\n    \n    if (diffInMinutes < 1) {\n      return 'Just now';\n    } else if (diffInMinutes < 60) {\n      return `${diffInMinutes}m ago`;\n    } else if (diffInHours < 24) {\n      return `${diffInHours}h ago`;\n    } else if (diffInDays < 7) {\n      return `${diffInDays}d ago`;\n    } else {\n      return formatDate(timestamp);\n    }\n  }\n  \n  // Global functions for modal interactions\n  window.closeTaskDetailsModal = function() {\n    const modal = document.getElementById('task-details-modal');\n    if (modal) {\n      modal.style.display = 'none';\n    }\n  };\n  \n  window.editTaskFromDetails = function() {\n    const modal = document.getElementById('task-details-modal');\n    const taskId = modal?.dataset.taskId;\n    \n    if (taskId) {\n      // Close details modal\n      closeTaskDetailsModal();\n      \n      // Open edit modal or navigate to edit page\n      if (window.editTask) {\n        window.editTask(taskId);\n      } else {\n        console.log('Edit task functionality to be implemented');\n      }\n    }\n  };\n  \n  window.completeTaskFromDetails = function() {\n    const modal = document.getElementById('task-details-modal');\n    const taskId = modal?.dataset.taskId;\n    \n    if (taskId && window.ubaStore && window.ubaStore.tasks) {\n      const task = getTaskById(taskId);\n      if (task && task.status !== 'done') {\n        // Update task status\n        window.ubaStore.tasks.update(taskId, {\n          status: 'done',\n          completed_at: new Date().toISOString()\n        });\n        \n        // Show notification\n        if (window.showToast) {\n          window.showToast(`Task \"${task.title}\" marked as complete`, 'success');\n        }\n        \n        // Close modal and refresh\n        closeTaskDetailsModal();\n        renderEnhancedTasks();\n      }\n    }\n  };\n  \n  window.deleteTaskFromDetails = function(taskId) {\n    if (!taskId) return;\n    \n    const task = getTaskById(taskId);\n    if (!task) return;\n    \n    if (confirm(`Are you sure you want to delete task \"${task.title}\"? This action cannot be undone.`)) {\n      if (window.ubaStore && window.ubaStore.tasks) {\n        window.ubaStore.tasks.delete(taskId);\n        \n        // Show notification\n        if (window.showToast) {\n          window.showToast(`Task \"${task.title}\" deleted`, 'success');\n        }\n        \n        // Close modal and refresh\n        closeTaskDetailsModal();\n        renderEnhancedTasks();\n      }\n    }\n  };\n  \n  window.showTaskDetails = showTaskDetails;\n  \n  // Expose enhanced tasks API\n  window.UBAEnhancedTasks = {\n    init: initEnhancedTasks,\n    showDetails: showTaskDetails,\n    checkReminders: checkDueDateReminders,\n    applyFilters: applyTaskFilters,\n    clearSearch: clearSearch\n  };\n  \n  // Auto-initialize\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', initEnhancedTasks);\n  } else {\n    // Delay initialization to ensure other modules are loaded\n    setTimeout(initEnhancedTasks, 100);\n  }\n  \n  console.log('‚úì Enhanced Tasks module loaded');\n  \n})();