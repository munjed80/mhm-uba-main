// enhanced-expenses.js - Comprehensive expense management with categories, charts, receipts, and improved UI
(function() {
  'use strict';
  
  /**
   * Enhanced Expenses System - Main Module
   * Features: Categories management, Charts (Pie & Trend), Receipt uploads, Enhanced dropdown design
   */
  window.UBAEnhancedExpenses = {
    
    // State management
    categories: [],
    expenses: [],
    charts: {},
    fileUploads: {},
    
    /**
     * Initialize enhanced expense system
     */
    init() {
      console.log('ğŸ’¸ Initializing Enhanced Expense System');
      
      this.loadExpenseCategories();
      this.setupCategoryManagement();
      this.setupCharts();
      this.setupReceiptUpload();
      this.enhanceDropdownDesign();
      this.initializeUI();
      
      console.log('âœ… Enhanced Expense System initialized');
    },
    
    /**
     * Load expense categories from localStorage
     */
    loadExpenseCategories() {
      try {
        const savedCategories = localStorage.getItem('uba-expense-categories');
        this.categories = savedCategories ? JSON.parse(savedCategories) : this.getDefaultCategories();
        console.log('âœ… Expense categories loaded');
      } catch (error) {
        console.warn('âš ï¸ Failed to load categories:', error);
        this.categories = this.getDefaultCategories();
      }
    },
    
    /**
     * Get default expense categories
     */
    getDefaultCategories() {
      return [
        {
          id: 'cat-office',
          name: 'Office Supplies',
          nameAr: 'Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ù…ÙƒØªØ¨ÙŠØ©',
          icon: 'ğŸ“',
          color: '#3b82f6',
          description: 'Office equipment, stationery, and supplies',
          budget: 500,
          active: true
        },
        {
          id: 'cat-software',
          name: 'Software',
          nameAr: 'Ø¨Ø±Ù…Ø¬ÙŠØ§Øª',
          icon: 'ğŸ’»',
          color: '#8b5cf6',
          description: 'Software subscriptions, licenses, and tools',
          budget: 1200,
          active: true
        },
        {
          id: 'cat-travel',
          name: 'Travel',
          nameAr: 'Ø³ÙØ±',
          icon: 'âœˆï¸',
          color: '#10b981',
          description: 'Business travel, accommodation, and transport',
          budget: 2000,
          active: true
        },
        {
          id: 'cat-marketing',
          name: 'Marketing',
          nameAr: 'ØªØ³ÙˆÙŠÙ‚',
          icon: 'ğŸ“¢',
          color: '#f59e0b',
          description: 'Advertising, campaigns, and promotional materials',
          budget: 1500,
          active: true
        },
        {
          id: 'cat-equipment',
          name: 'Equipment',
          nameAr: 'Ù…Ø¹Ø¯Ø§Øª',
          icon: 'ğŸ”§',
          color: '#6b7280',
          description: 'Hardware, machinery, and equipment',
          budget: 3000,
          active: true
        },
        {
          id: 'cat-utilities',
          name: 'Utilities',
          nameAr: 'Ù…Ø±Ø§ÙÙ‚',
          icon: 'ğŸ’¡',
          color: '#ef4444',
          description: 'Internet, phone, electricity, and utilities',
          budget: 800,
          active: true
        },
        {
          id: 'cat-rent',
          name: 'Rent',
          nameAr: 'Ø¥ÙŠØ¬Ø§Ø±',
          icon: 'ğŸ¢',
          color: '#06b6d4',
          description: 'Office rent and facility costs',
          budget: 2500,
          active: true
        },
        {
          id: 'cat-insurance',
          name: 'Insurance',
          nameAr: 'ØªØ£Ù…ÙŠÙ†',
          icon: 'ğŸ›¡ï¸',
          color: '#84cc16',
          description: 'Business insurance and protection',
          budget: 400,
          active: true
        },
        {
          id: 'cat-professional',
          name: 'Professional Services',
          nameAr: 'Ø®Ø¯Ù…Ø§Øª Ù…Ù‡Ù†ÙŠØ©',
          icon: 'ğŸ‘”',
          color: '#ec4899',
          description: 'Legal, accounting, and consulting services',
          budget: 1000,
          active: true
        },
        {
          id: 'cat-meals',
          name: 'Meals & Entertainment',
          nameAr: 'ÙˆØ¬Ø¨Ø§Øª ÙˆØªØ±ÙÙŠÙ‡',
          icon: 'ğŸ½ï¸',
          color: '#f97316',
          description: 'Business meals and entertainment',
          budget: 600,
          active: true
        },
        {
          id: 'cat-other',
          name: 'Other',
          nameAr: 'Ø£Ø®Ø±Ù‰',
          icon: 'ğŸ“‹',
          color: '#64748b',
          description: 'Miscellaneous business expenses',
          budget: 500,
          active: true
        }
      ];
    },
    
    /**
     * Save categories to localStorage
     */
    saveCategories() {
      try {
        localStorage.setItem('uba-expense-categories', JSON.stringify(this.categories));
        console.log('âœ… Categories saved');
      } catch (error) {
        console.error('âŒ Failed to save categories:', error);
      }
    },
    
    /**
     * Setup category management functionality
     */
    setupCategoryManagement() {
      console.log('ğŸ·ï¸ Setting up category management');
      
      // Add category management button to expenses page
      this.addCategoryManagementButton();
      
      // Create category management modal
      this.createCategoryModal();
      
      // Update expense form dropdown with categories
      this.updateExpenseFormCategories();
    },
    
    /**
     * Add category management button
     */
    addCategoryManagementButton() {
      const expensesHeader = document.querySelector('#expenses-page .uba-card-header');\n      if (expensesHeader) {\n        const buttonContainer = expensesHeader.querySelector('div:last-child');\n        if (buttonContainer) {\n          // Add category management button\n          const categoryBtn = document.createElement('button');\n          categoryBtn.className = 'uba-btn uba-btn-ghost';\n          categoryBtn.innerHTML = '<span class=\"icon\">ğŸ·ï¸</span> Categories';\n          categoryBtn.onclick = () => this.openCategoryManagement();\n          \n          // Insert before the Add Expense button\n          const addBtn = buttonContainer.querySelector('.uba-btn-primary');\n          if (addBtn) {\n            buttonContainer.insertBefore(categoryBtn, addBtn);\n          }\n        }\n      }\n    },\n    \n    /**\n     * Create category management modal\n     */\n    createCategoryModal() {\n      const modal = document.createElement('div');\n      modal.id = 'category-management-modal';\n      modal.className = 'uba-modal category-modal';\n      modal.innerHTML = `\n        <div class=\"uba-modal-overlay\" onclick=\"window.UBAEnhancedExpenses.closeCategoryManagement()\"></div>\n        <div class=\"uba-modal-dialog category-dialog\">\n          <div class=\"uba-modal-header\">\n            <h3><span class=\"icon\">ğŸ·ï¸</span> Ø¥Ø¯Ø§Ø±Ø© ÙØ¦Ø§Øª Ø§Ù„ØµØ±Ù (Expense Categories Management)</h3>\n            <button class=\"uba-modal-close\" onclick=\"window.UBAEnhancedExpenses.closeCategoryManagement()\">Ã—</button>\n          </div>\n          <div class=\"uba-modal-body category-body\">\n            <!-- Category form -->\n            <div class=\"category-form-section\">\n              <h4>Add/Edit Category</h4>\n              <form id=\"category-form\" class=\"category-form\">\n                <input type=\"hidden\" id=\"category-edit-id\" />\n                <div class=\"category-form-grid\">\n                  <div class=\"form-group\">\n                    <label for=\"category-name\">Name *</label>\n                    <input type=\"text\" id=\"category-name\" class=\"uba-input\" placeholder=\"Category name\" required />\n                  </div>\n                  <div class=\"form-group\">\n                    <label for=\"category-name-ar\">Arabic Name</label>\n                    <input type=\"text\" id=\"category-name-ar\" class=\"uba-input\" placeholder=\"Ø§Ù„Ø§Ø³Ù… Ø¨Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©\" />\n                  </div>\n                  <div class=\"form-group\">\n                    <label for=\"category-icon\">Icon</label>\n                    <div class=\"icon-selector\">\n                      <input type=\"text\" id=\"category-icon\" class=\"uba-input icon-input\" placeholder=\"ğŸ“\" maxlength=\"2\" />\n                      <div class=\"icon-suggestions\">\n                        <span class=\"icon-option\" onclick=\"window.UBAEnhancedExpenses.selectIcon('ğŸ“')\">ğŸ“</span>\n                        <span class=\"icon-option\" onclick=\"window.UBAEnhancedExpenses.selectIcon('ğŸ’»')\">ğŸ’»</span>\n                        <span class=\"icon-option\" onclick=\"window.UBAEnhancedExpenses.selectIcon('âœˆï¸')\">âœˆï¸</span>\n                        <span class=\"icon-option\" onclick=\"window.UBAEnhancedExpenses.selectIcon('ğŸ“¢')\">ğŸ“¢</span>\n                        <span class=\"icon-option\" onclick=\"window.UBAEnhancedExpenses.selectIcon('ğŸ”§')\">ğŸ”§</span>\n                        <span class=\"icon-option\" onclick=\"window.UBAEnhancedExpenses.selectIcon('ğŸ’¡')\">ğŸ’¡</span>\n                        <span class=\"icon-option\" onclick=\"window.UBAEnhancedExpenses.selectIcon('ğŸ¢')\">ğŸ¢</span>\n                        <span class=\"icon-option\" onclick=\"window.UBAEnhancedExpenses.selectIcon('ğŸ›¡ï¸')\">ğŸ›¡ï¸</span>\n                      </div>\n                    </div>\n                  </div>\n                  <div class=\"form-group\">\n                    <label for=\"category-color\">Color</label>\n                    <input type=\"color\" id=\"category-color\" class=\"uba-input color-picker\" value=\"#3b82f6\" />\n                  </div>\n                  <div class=\"form-group full-width\">\n                    <label for=\"category-description\">Description</label>\n                    <input type=\"text\" id=\"category-description\" class=\"uba-input\" placeholder=\"Brief description\" />\n                  </div>\n                  <div class=\"form-group\">\n                    <label for=\"category-budget\">Monthly Budget (â‚¬)</label>\n                    <input type=\"number\" id=\"category-budget\" class=\"uba-input\" min=\"0\" step=\"0.01\" placeholder=\"0.00\" />\n                  </div>\n                  <div class=\"form-group\">\n                    <label class=\"checkbox-label\">\n                      <input type=\"checkbox\" id=\"category-active\" checked />\n                      <span class=\"checkmark\"></span>\n                      Active\n                    </label>\n                  </div>\n                </div>\n                <div class=\"category-form-actions\">\n                  <button type=\"button\" class=\"uba-btn uba-btn-ghost\" onclick=\"window.UBAEnhancedExpenses.clearCategoryForm()\">Clear</button>\n                  <button type=\"submit\" class=\"uba-btn uba-btn-primary\">Save Category</button>\n                </div>\n              </form>\n            </div>\n            \n            <!-- Categories list -->\n            <div class=\"category-list-section\">\n              <h4>Existing Categories</h4>\n              <div id=\"categories-list\" class=\"categories-grid\">\n                <!-- Categories will be rendered here -->\n              </div>\n            </div>\n          </div>\n        </div>\n      `;\n      \n      document.body.appendChild(modal);\n      \n      // Setup form submission\n      const form = modal.querySelector('#category-form');\n      form.addEventListener('submit', (e) => {\n        e.preventDefault();\n        this.saveCategoryFromForm();\n      });\n    },\n    \n    /**\n     * Open category management modal\n     */\n    openCategoryManagement() {\n      const modal = document.getElementById('category-management-modal');\n      if (modal) {\n        modal.classList.add('is-visible');\n        document.body.style.overflow = 'hidden';\n        this.renderCategoriesList();\n      }\n    },\n    \n    /**\n     * Close category management modal\n     */\n    closeCategoryManagement() {\n      const modal = document.getElementById('category-management-modal');\n      if (modal) {\n        modal.classList.remove('is-visible');\n        document.body.style.overflow = '';\n        this.clearCategoryForm();\n      }\n    },\n    \n    /**\n     * Render categories list in modal\n     */\n    renderCategoriesList() {\n      const container = document.getElementById('categories-list');\n      if (!container) return;\n      \n      container.innerHTML = this.categories.map(category => `\n        <div class=\"category-item ${category.active ? 'active' : 'inactive'}\" style=\"border-left: 4px solid ${category.color}\">\n          <div class=\"category-header\">\n            <div class=\"category-icon-name\">\n              <span class=\"category-icon\">${category.icon}</span>\n              <div class=\"category-names\">\n                <strong class=\"category-name\">${category.name}</strong>\n                ${category.nameAr ? `<small class=\"category-name-ar\">${category.nameAr}</small>` : ''}\n              </div>\n            </div>\n            <div class=\"category-actions\">\n              <button class=\"uba-btn uba-btn-sm uba-btn-ghost\" onclick=\"window.UBAEnhancedExpenses.editCategory('${category.id}')\" title=\"Edit category\">\n                âœï¸\n              </button>\n              <button class=\"uba-btn uba-btn-sm uba-btn-danger\" onclick=\"window.UBAEnhancedExpenses.deleteCategory('${category.id}')\" title=\"Delete category\">\n                ğŸ—‘ï¸\n              </button>\n            </div>\n          </div>\n          <div class=\"category-details\">\n            <p class=\"category-description\">${category.description}</p>\n            <div class=\"category-meta\">\n              <span class=\"category-budget\">Budget: â‚¬${category.budget || 0}/month</span>\n              <span class=\"category-status ${category.active ? 'active' : 'inactive'}\">\n                ${category.active ? 'Active' : 'Inactive'}\n              </span>\n            </div>\n          </div>\n        </div>\n      `).join('');\n    },\n    \n    /**\n     * Clear category form\n     */\n    clearCategoryForm() {\n      document.getElementById('category-edit-id').value = '';\n      document.getElementById('category-name').value = '';\n      document.getElementById('category-name-ar').value = '';\n      document.getElementById('category-icon').value = '';\n      document.getElementById('category-color').value = '#3b82f6';\n      document.getElementById('category-description').value = '';\n      document.getElementById('category-budget').value = '';\n      document.getElementById('category-active').checked = true;\n    },\n    \n    /**\n     * Select icon for category\n     */\n    selectIcon(icon) {\n      document.getElementById('category-icon').value = icon;\n    },\n    \n    /**\n     * Save category from form\n     */\n    saveCategoryFromForm() {\n      const editId = document.getElementById('category-edit-id').value;\n      const categoryData = {\n        name: document.getElementById('category-name').value.trim(),\n        nameAr: document.getElementById('category-name-ar').value.trim(),\n        icon: document.getElementById('category-icon').value.trim() || 'ğŸ“‹',\n        color: document.getElementById('category-color').value,\n        description: document.getElementById('category-description').value.trim(),\n        budget: parseFloat(document.getElementById('category-budget').value) || 0,\n        active: document.getElementById('category-active').checked\n      };\n      \n      // Validate required fields\n      if (!categoryData.name) {\n        this.showNotification('Category name is required', 'error');\n        return;\n      }\n      \n      if (editId) {\n        // Update existing category\n        const index = this.categories.findIndex(cat => cat.id === editId);\n        if (index !== -1) {\n          this.categories[index] = { ...this.categories[index], ...categoryData };\n          this.showNotification(`Category \"${categoryData.name}\" updated successfully`, 'success');\n        }\n      } else {\n        // Create new category\n        const newCategory = {\n          id: 'cat-' + Date.now(),\n          ...categoryData,\n          createdAt: new Date().toISOString()\n        };\n        this.categories.push(newCategory);\n        this.showNotification(`Category \"${categoryData.name}\" created successfully`, 'success');\n      }\n      \n      this.saveCategories();\n      this.renderCategoriesList();\n      this.updateExpenseFormCategories();\n      this.clearCategoryForm();\n    },\n    \n    /**\n     * Edit category\n     */\n    editCategory(categoryId) {\n      const category = this.categories.find(cat => cat.id === categoryId);\n      if (!category) return;\n      \n      document.getElementById('category-edit-id').value = category.id;\n      document.getElementById('category-name').value = category.name;\n      document.getElementById('category-name-ar').value = category.nameAr || '';\n      document.getElementById('category-icon').value = category.icon;\n      document.getElementById('category-color').value = category.color;\n      document.getElementById('category-description').value = category.description || '';\n      document.getElementById('category-budget').value = category.budget || '';\n      document.getElementById('category-active').checked = category.active;\n    },\n    \n    /**\n     * Delete category\n     */\n    deleteCategory(categoryId) {\n      const category = this.categories.find(cat => cat.id === categoryId);\n      if (!category) return;\n      \n      if (confirm(`Are you sure you want to delete the category \"${category.name}\"?\\n\\nThis action cannot be undone.`)) {\n        this.categories = this.categories.filter(cat => cat.id !== categoryId);\n        this.saveCategories();\n        this.renderCategoriesList();\n        this.updateExpenseFormCategories();\n        this.showNotification(`Category \"${category.name}\" deleted`, 'info');\n      }\n    },\n    \n    /**\n     * Update expense form categories dropdown\n     */\n    updateExpenseFormCategories() {\n      const categorySelect = document.getElementById('expense-category');\n      if (!categorySelect) return;\n      \n      // Clear existing options except the first one\n      categorySelect.innerHTML = '<option value=\"\">Select Category</option>';\n      \n      // Add active categories\n      this.categories\n        .filter(category => category.active)\n        .forEach(category => {\n          const option = document.createElement('option');\n          option.value = category.name;\n          option.textContent = `${category.icon} ${category.name}`;\n          option.setAttribute('data-category-id', category.id);\n          categorySelect.appendChild(option);\n        });\n    },\n    \n    /**\n     * Setup charts functionality\n     */\n    setupCharts() {\n      console.log('ğŸ“Š Setting up expense charts');\n      \n      // Add charts section to expenses page\n      this.addChartsSection();\n      \n      // Initialize charts\n      this.initializeCharts();\n    },\n    \n    /**\n     * Add charts section to expenses page\n     */\n    addChartsSection() {\n      const expensesView = document.querySelector('[data-view=\"expenses\"]');\n      if (!expensesView) return;\n      \n      const chartsSection = document.createElement('div');\n      chartsSection.className = 'uba-grid';\n      chartsSection.style.marginBottom = '20px';\n      chartsSection.innerHTML = `\n        <div class=\"uba-grid-col\">\n          <div class=\"charts-container\">\n            <!-- Pie Chart -->\n            <div class=\"uba-card chart-card\">\n              <div class=\"uba-card-header\">\n                <div>\n                  <div class=\"uba-card-title\">ğŸ“Š Expense Distribution</div>\n                  <p class=\"uba-card-sub\">Breakdown by category</p>\n                </div>\n                <div class=\"chart-controls\">\n                  <select id=\"pie-chart-period\" class=\"uba-select enhanced-dropdown\">\n                    <option value=\"current-month\">This Month</option>\n                    <option value=\"last-month\">Last Month</option>\n                    <option value=\"last-3-months\">Last 3 Months</option>\n                    <option value=\"last-6-months\">Last 6 Months</option>\n                  </select>\n                </div>\n              </div>\n              <div class=\"chart-content\">\n                <canvas id=\"expense-pie-chart\" width=\"400\" height=\"300\"></canvas>\n                <div id=\"pie-chart-legend\" class=\"chart-legend\"></div>\n              </div>\n            </div>\n            \n            <!-- Monthly Trend Chart -->\n            <div class=\"uba-card chart-card\">\n              <div class=\"uba-card-header\">\n                <div>\n                  <div class=\"uba-card-title\">ğŸ“ˆ Monthly Trend</div>\n                  <p class=\"uba-card-sub\">Expense trends over time</p>\n                </div>\n                <div class=\"chart-controls\">\n                  <select id=\"trend-chart-period\" class=\"uba-select enhanced-dropdown\">\n                    <option value=\"6-months\">Last 6 Months</option>\n                    <option value=\"12-months\">Last 12 Months</option>\n                    <option value=\"24-months\">Last 24 Months</option>\n                  </select>\n                </div>\n              </div>\n              <div class=\"chart-content\">\n                <canvas id=\"expense-trend-chart\" width=\"600\" height=\"300\"></canvas>\n                <div id=\"trend-chart-summary\" class=\"chart-summary\"></div>\n              </div>\n            </div>\n          </div>\n        </div>\n      `;\n      \n      // Insert charts before the main expenses table\n      const expensesTable = expensesView.querySelector('.uba-grid');\n      if (expensesTable) {\n        expensesView.insertBefore(chartsSection, expensesTable);\n      }\n      \n      // Setup chart period change handlers\n      const pieSelect = document.getElementById('pie-chart-period');\n      const trendSelect = document.getElementById('trend-chart-period');\n      \n      if (pieSelect) {\n        pieSelect.addEventListener('change', () => this.updatePieChart());\n      }\n      \n      if (trendSelect) {\n        trendSelect.addEventListener('change', () => this.updateTrendChart());\n      }\n    },\n    \n    /**\n     * Initialize charts\n     */\n    initializeCharts() {\n      // Load Chart.js if not already loaded\n      this.loadChartJS().then(() => {\n        this.createPieChart();\n        this.createTrendChart();\n      }).catch(error => {\n        console.warn('Charts not available:', error);\n        this.createFallbackCharts();\n      });\n    },\n    \n    /**\n     * Load Chart.js library\n     */\n    async loadChartJS() {\n      if (window.Chart) return;\n      \n      return new Promise((resolve, reject) => {\n        const script = document.createElement('script');\n        script.src = 'https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js';\n        script.onload = resolve;\n        script.onerror = reject;\n        document.head.appendChild(script);\n      });\n    },\n    \n    /**\n     * Create pie chart\n     */\n    createPieChart() {\n      const ctx = document.getElementById('expense-pie-chart');\n      if (!ctx || !window.Chart) return;\n      \n      const data = this.getPieChartData();\n      \n      this.charts.pie = new Chart(ctx, {\n        type: 'doughnut',\n        data: {\n          labels: data.labels,\n          datasets: [{\n            data: data.values,\n            backgroundColor: data.colors,\n            borderWidth: 2,\n            borderColor: '#ffffff'\n          }]\n        },\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          plugins: {\n            legend: {\n              display: false // We'll create custom legend\n            },\n            tooltip: {\n              callbacks: {\n                label: (context) => {\n                  const label = context.label;\n                  const value = this.formatAmount(context.parsed);\n                  const percentage = ((context.parsed / data.total) * 100).toFixed(1);\n                  return `${label}: ${value} (${percentage}%)`;\n                }\n              }\n            }\n          }\n        }\n      });\n      \n      // Create custom legend\n      this.createPieChartLegend(data);\n    },\n    \n    /**\n     * Get pie chart data\n     */\n    getPieChartData() {\n      const period = document.getElementById('pie-chart-period')?.value || 'current-month';\n      const expenses = this.getExpensesForPeriod(period);\n      \n      // Group by category\n      const categoryTotals = {};\n      expenses.forEach(expense => {\n        const category = expense.category || 'Other';\n        categoryTotals[category] = (categoryTotals[category] || 0) + (expense.amount || 0);\n      });\n      \n      const labels = Object.keys(categoryTotals);\n      const values = Object.values(categoryTotals);\n      const total = values.reduce((sum, val) => sum + val, 0);\n      \n      // Get colors for categories\n      const colors = labels.map(label => {\n        const category = this.categories.find(cat => cat.name === label);\n        return category ? category.color : '#64748b';\n      });\n      \n      return { labels, values, colors, total };\n    },\n    \n    /**\n     * Create pie chart legend\n     */\n    createPieChartLegend(data) {\n      const legend = document.getElementById('pie-chart-legend');\n      if (!legend) return;\n      \n      legend.innerHTML = data.labels.map((label, index) => {\n        const value = data.values[index];\n        const percentage = ((value / data.total) * 100).toFixed(1);\n        const color = data.colors[index];\n        const category = this.categories.find(cat => cat.name === label);\n        const icon = category ? category.icon : 'ğŸ“‹';\n        \n        return `\n          <div class=\"legend-item\">\n            <span class=\"legend-color\" style=\"background-color: ${color}\"></span>\n            <span class=\"legend-icon\">${icon}</span>\n            <span class=\"legend-label\">${label}</span>\n            <span class=\"legend-value\">${this.formatAmount(value)} (${percentage}%)</span>\n          </div>\n        `;\n      }).join('');\n    },\n    \n    /**\n     * Create trend chart\n     */\n    createTrendChart() {\n      const ctx = document.getElementById('expense-trend-chart');\n      if (!ctx || !window.Chart) return;\n      \n      const data = this.getTrendChartData();\n      \n      this.charts.trend = new Chart(ctx, {\n        type: 'line',\n        data: {\n          labels: data.labels,\n          datasets: [{\n            label: 'Total Expenses',\n            data: data.values,\n            borderColor: '#3b82f6',\n            backgroundColor: 'rgba(59, 130, 246, 0.1)',\n            borderWidth: 3,\n            fill: true,\n            tension: 0.4\n          }]\n        },\n        options: {\n          responsive: true,\n          maintainAspectRatio: false,\n          scales: {\n            y: {\n              beginAtZero: true,\n              ticks: {\n                callback: (value) => 'â‚¬' + value.toFixed(0)\n              }\n            }\n          },\n          plugins: {\n            legend: {\n              display: false\n            },\n            tooltip: {\n              callbacks: {\n                label: (context) => {\n                  return `Total: ${this.formatAmount(context.parsed.y)}`;\n                }\n              }\n            }\n          }\n        }\n      });\n      \n      // Create trend summary\n      this.createTrendSummary(data);\n    },\n    \n    /**\n     * Get trend chart data\n     */\n    getTrendChartData() {\n      const period = document.getElementById('trend-chart-period')?.value || '6-months';\n      const monthsCount = period === '12-months' ? 12 : period === '24-months' ? 24 : 6;\n      \n      const labels = [];\n      const values = [];\n      const now = new Date();\n      \n      // Generate labels and calculate values for each month\n      for (let i = monthsCount - 1; i >= 0; i--) {\n        const date = new Date(now.getFullYear(), now.getMonth() - i, 1);\n        const monthKey = date.toISOString().slice(0, 7);\n        const monthLabel = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });\n        \n        labels.push(monthLabel);\n        \n        // Calculate total expenses for this month\n        const monthExpenses = this.getExpensesData().filter(expense => \n          expense.date && expense.date.startsWith(monthKey)\n        );\n        const monthTotal = monthExpenses.reduce((sum, expense) => sum + (expense.amount || 0), 0);\n        \n        values.push(monthTotal);\n      }\n      \n      return { labels, values };\n    },\n    \n    /**\n     * Create trend summary\n     */\n    createTrendSummary(data) {\n      const summary = document.getElementById('trend-chart-summary');\n      if (!summary) return;\n      \n      const total = data.values.reduce((sum, val) => sum + val, 0);\n      const average = total / data.values.length;\n      const max = Math.max(...data.values);\n      const min = Math.min(...data.values);\n      \n      summary.innerHTML = `\n        <div class=\"summary-grid\">\n          <div class=\"summary-item\">\n            <span class=\"summary-label\">Total</span>\n            <span class=\"summary-value\">${this.formatAmount(total)}</span>\n          </div>\n          <div class=\"summary-item\">\n            <span class=\"summary-label\">Average</span>\n            <span class=\"summary-value\">${this.formatAmount(average)}</span>\n          </div>\n          <div class=\"summary-item\">\n            <span class=\"summary-label\">Highest</span>\n            <span class=\"summary-value\">${this.formatAmount(max)}</span>\n          </div>\n          <div class=\"summary-item\">\n            <span class=\"summary-label\">Lowest</span>\n            <span class=\"summary-value\">${this.formatAmount(min)}</span>\n          </div>\n        </div>\n      `;\n    },\n    \n    /**\n     * Update pie chart\n     */\n    updatePieChart() {\n      if (this.charts.pie) {\n        const data = this.getPieChartData();\n        this.charts.pie.data.labels = data.labels;\n        this.charts.pie.data.datasets[0].data = data.values;\n        this.charts.pie.data.datasets[0].backgroundColor = data.colors;\n        this.charts.pie.update();\n        this.createPieChartLegend(data);\n      }\n    },\n    \n    /**\n     * Update trend chart\n     */\n    updateTrendChart() {\n      if (this.charts.trend) {\n        const data = this.getTrendChartData();\n        this.charts.trend.data.labels = data.labels;\n        this.charts.trend.data.datasets[0].data = data.values;\n        this.charts.trend.update();\n        this.createTrendSummary(data);\n      }\n    },\n    \n    /**\n     * Create fallback charts (for when Chart.js is not available)\n     */\n    createFallbackCharts() {\n      // Create simple HTML-based charts\n      this.createFallbackPieChart();\n      this.createFallbackTrendChart();\n    },\n    \n    /**\n     * Create fallback pie chart\n     */\n    createFallbackPieChart() {\n      const canvas = document.getElementById('expense-pie-chart');\n      if (!canvas) return;\n      \n      const data = this.getPieChartData();\n      const fallback = document.createElement('div');\n      fallback.className = 'fallback-pie-chart';\n      \n      let cumulativePercentage = 0;\n      fallback.innerHTML = `\n        <div class=\"pie-chart-fallback\">\n          ${data.labels.map((label, index) => {\n            const value = data.values[index];\n            const percentage = ((value / data.total) * 100);\n            const color = data.colors[index];\n            \n            const segment = `\n              <div class=\"pie-segment\" style=\"\n                background: ${color};\n                transform: rotate(${cumulativePercentage * 3.6}deg);\n                clip-path: polygon(50% 50%, 50% 0%, ${50 + percentage}% 0%);\n              \"></div>\n            `;\n            \n            cumulativePercentage += percentage;\n            return segment;\n          }).join('')}\n        </div>\n        <div class=\"pie-chart-center\">\n          <strong>${this.formatAmount(data.total)}</strong>\n          <small>Total</small>\n        </div>\n      `;\n      \n      canvas.parentNode.replaceChild(fallback, canvas);\n      this.createPieChartLegend(data);\n    },\n    \n    /**\n     * Create fallback trend chart\n     */\n    createFallbackTrendChart() {\n      const canvas = document.getElementById('expense-trend-chart');\n      if (!canvas) return;\n      \n      const data = this.getTrendChartData();\n      const maxValue = Math.max(...data.values);\n      \n      const fallback = document.createElement('div');\n      fallback.className = 'fallback-trend-chart';\n      fallback.innerHTML = `\n        <div class=\"trend-chart-bars\">\n          ${data.labels.map((label, index) => {\n            const value = data.values[index];\n            const height = maxValue > 0 ? (value / maxValue) * 100 : 0;\n            \n            return `\n              <div class=\"trend-bar\" title=\"${label}: ${this.formatAmount(value)}\">\n                <div class=\"bar\" style=\"height: ${height}%;\"></div>\n                <span class=\"bar-label\">${label}</span>\n              </div>\n            `;\n          }).join('')}\n        </div>\n      `;\n      \n      canvas.parentNode.replaceChild(fallback, canvas);\n      this.createTrendSummary(data);\n    },\n    \n    /**\n     * Setup receipt upload functionality\n     */\n    setupReceiptUpload() {\n      console.log('ğŸ“ Setting up receipt upload integration');\n      \n      // Enhance expense form with receipt upload\n      this.enhanceExpenseFormWithUpload();\n      \n      // Setup file upload handlers\n      this.setupFileUploadHandlers();\n    },\n    \n    /**\n     * Enhance expense form with receipt upload\n     */\n    enhanceExpenseFormWithUpload() {\n      const receiptField = document.getElementById('expense-receipt');\n      if (!receiptField) return;\n      \n      // Replace textarea with enhanced upload section\n      const uploadSection = document.createElement('div');\n      uploadSection.className = 'receipt-upload-section';\n      uploadSection.innerHTML = `\n        <div class=\"upload-tabs\">\n          <button type=\"button\" class=\"upload-tab active\" data-tab=\"file\">ğŸ“ Upload File</button>\n          <button type=\"button\" class=\"upload-tab\" data-tab=\"notes\">ğŸ“ Notes</button>\n        </div>\n        \n        <div class=\"upload-content\">\n          <!-- File Upload Tab -->\n          <div class=\"upload-tab-content active\" data-tab=\"file\">\n            <div class=\"file-upload-area\" id=\"receipt-upload-area\">\n              <input type=\"file\" id=\"receipt-file-input\" class=\"file-input\" accept=\".pdf,.png,.jpg,.jpeg,.gif\" multiple />\n              <div class=\"upload-prompt\">\n                <span class=\"upload-icon\">ğŸ“</span>\n                <p>Drop receipt files here or <button type=\"button\" class=\"upload-link\" onclick=\"document.getElementById('receipt-file-input').click()\">browse files</button></p>\n                <small>Supports: PDF, PNG, JPG, GIF (max 5MB each)</small>\n              </div>\n              <div id=\"uploaded-files\" class=\"uploaded-files\"></div>\n            </div>\n          </div>\n          \n          <!-- Notes Tab -->\n          <div class=\"upload-tab-content\" data-tab=\"notes\">\n            <textarea id=\"expense-receipt\" name=\"receipt\" rows=\"3\" class=\"uba-textarea\" placeholder=\"Receipt number, notes, or additional details\"></textarea>\n          </div>\n        </div>\n      `;\n      \n      // Replace the original textarea's parent\n      const parentGroup = receiptField.closest('.uba-form-group');\n      if (parentGroup) {\n        const label = parentGroup.querySelector('label');\n        label.textContent = 'Receipt & Files (Ø§Ù„Ø¥ÙŠØµØ§Ù„ ÙˆØ§Ù„Ù…Ù„ÙØ§Øª)';\n        \n        // Replace textarea with upload section\n        receiptField.parentNode.replaceChild(uploadSection, receiptField);\n      }\n      \n      // Setup tab switching\n      this.setupUploadTabs();\n      \n      // Setup drag and drop\n      this.setupDragAndDrop();\n    },\n    \n    /**\n     * Setup upload tabs\n     */\n    setupUploadTabs() {\n      const tabs = document.querySelectorAll('.upload-tab');\n      const contents = document.querySelectorAll('.upload-tab-content');\n      \n      tabs.forEach(tab => {\n        tab.addEventListener('click', () => {\n          const targetTab = tab.getAttribute('data-tab');\n          \n          // Update tab states\n          tabs.forEach(t => t.classList.remove('active'));\n          tab.classList.add('active');\n          \n          // Update content states\n          contents.forEach(content => {\n            content.classList.remove('active');\n            if (content.getAttribute('data-tab') === targetTab) {\n              content.classList.add('active');\n            }\n          });\n        });\n      });\n    },\n    \n    /**\n     * Setup drag and drop\n     */\n    setupDragAndDrop() {\n      const uploadArea = document.getElementById('receipt-upload-area');\n      if (!uploadArea) return;\n      \n      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {\n        uploadArea.addEventListener(eventName, (e) => {\n          e.preventDefault();\n          e.stopPropagation();\n        });\n      });\n      \n      ['dragenter', 'dragover'].forEach(eventName => {\n        uploadArea.addEventListener(eventName, () => {\n          uploadArea.classList.add('drag-over');\n        });\n      });\n      \n      ['dragleave', 'drop'].forEach(eventName => {\n        uploadArea.addEventListener(eventName, () => {\n          uploadArea.classList.remove('drag-over');\n        });\n      });\n      \n      uploadArea.addEventListener('drop', (e) => {\n        const files = e.dataTransfer.files;\n        this.handleFileUpload(files);\n      });\n    },\n    \n    /**\n     * Setup file upload handlers\n     */\n    setupFileUploadHandlers() {\n      const fileInput = document.getElementById('receipt-file-input');\n      if (fileInput) {\n        fileInput.addEventListener('change', (e) => {\n          this.handleFileUpload(e.target.files);\n        });\n      }\n    },\n    \n    /**\n     * Handle file upload\n     */\n    handleFileUpload(files) {\n      const maxSize = 5 * 1024 * 1024; // 5MB\n      const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/gif', 'application/pdf'];\n      \n      Array.from(files).forEach(file => {\n        // Validate file size\n        if (file.size > maxSize) {\n          this.showNotification(`File \"${file.name}\" is too large. Maximum size is 5MB.`, 'error');\n          return;\n        }\n        \n        // Validate file type\n        if (!allowedTypes.includes(file.type)) {\n          this.showNotification(`File \"${file.name}\" is not a supported format.`, 'error');\n          return;\n        }\n        \n        // Process file\n        this.processUploadedFile(file);\n      });\n    },\n    \n    /**\n     * Process uploaded file\n     */\n    processUploadedFile(file) {\n      const fileId = 'file-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);\n      \n      // Create file object\n      const fileObj = {\n        id: fileId,\n        name: file.name,\n        size: file.size,\n        type: file.type,\n        uploadedAt: new Date().toISOString(),\n        file: file // Store the actual file object\n      };\n      \n      // Store in files collection (integrate with files section)\n      this.storeFileInFilesSection(fileObj);\n      \n      // Add to current uploads\n      if (!this.fileUploads.currentExpense) {\n        this.fileUploads.currentExpense = [];\n      }\n      this.fileUploads.currentExpense.push(fileObj);\n      \n      // Update UI\n      this.updateUploadedFilesDisplay();\n      \n      this.showNotification(`File \"${file.name}\" uploaded successfully`, 'success');\n    },\n    \n    /**\n     * Store file in files section\n     */\n    storeFileInFilesSection(fileObj) {\n      // Create file entry for files section\n      const fileEntry = {\n        id: fileObj.id,\n        name: fileObj.name,\n        type: 'receipt',\n        category: 'expense',\n        size: fileObj.size,\n        mimeType: fileObj.type,\n        uploadedAt: fileObj.uploadedAt,\n        tags: ['receipt', 'expense'],\n        description: 'Expense receipt upload'\n      };\n      \n      // Store in localStorage (files section integration)\n      const existingFiles = JSON.parse(localStorage.getItem('uba-files') || '[]');\n      existingFiles.push(fileEntry);\n      localStorage.setItem('uba-files', JSON.stringify(existingFiles));\n    },\n    \n    /**\n     * Update uploaded files display\n     */\n    updateUploadedFilesDisplay() {\n      const container = document.getElementById('uploaded-files');\n      if (!container || !this.fileUploads.currentExpense) return;\n      \n      container.innerHTML = this.fileUploads.currentExpense.map(file => `\n        <div class=\"uploaded-file\" data-file-id=\"${file.id}\">\n          <div class=\"file-info\">\n            <span class=\"file-icon\">${this.getFileIcon(file.type)}</span>\n            <div class=\"file-details\">\n              <strong class=\"file-name\">${file.name}</strong>\n              <small class=\"file-size\">${this.formatFileSize(file.size)}</small>\n            </div>\n          </div>\n          <div class=\"file-actions\">\n            <button type=\"button\" class=\"uba-btn uba-btn-sm uba-btn-ghost\" onclick=\"window.UBAEnhancedExpenses.previewFile('${file.id}')\" title=\"Preview\">\n              ğŸ‘ï¸\n            </button>\n            <button type=\"button\" class=\"uba-btn uba-btn-sm uba-btn-danger\" onclick=\"window.UBAEnhancedExpenses.removeFile('${file.id}')\" title=\"Remove\">\n              ğŸ—‘ï¸\n            </button>\n          </div>\n        </div>\n      `).join('');\n    },\n    \n    /**\n     * Get file icon based on type\n     */\n    getFileIcon(mimeType) {\n      if (mimeType.startsWith('image/')) return 'ğŸ–¼ï¸';\n      if (mimeType === 'application/pdf') return 'ğŸ“„';\n      return 'ğŸ“';\n    },\n    \n    /**\n     * Format file size\n     */\n    formatFileSize(bytes) {\n      if (bytes === 0) return '0 Bytes';\n      const k = 1024;\n      const sizes = ['Bytes', 'KB', 'MB', 'GB'];\n      const i = Math.floor(Math.log(bytes) / Math.log(k));\n      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n    },\n    \n    /**\n     * Preview file\n     */\n    previewFile(fileId) {\n      const file = this.fileUploads.currentExpense?.find(f => f.id === fileId);\n      if (!file) return;\n      \n      if (file.type.startsWith('image/')) {\n        // Show image preview\n        const reader = new FileReader();\n        reader.onload = (e) => {\n          this.showImagePreview(file.name, e.target.result);\n        };\n        reader.readAsDataURL(file.file);\n      } else if (file.type === 'application/pdf') {\n        // Open PDF in new tab\n        const url = URL.createObjectURL(file.file);\n        window.open(url, '_blank');\n      } else {\n        this.showNotification('Preview not available for this file type', 'info');\n      }\n    },\n    \n    /**\n     * Show image preview\n     */\n    showImagePreview(fileName, dataUrl) {\n      const modal = document.createElement('div');\n      modal.className = 'uba-modal image-preview-modal is-visible';\n      modal.innerHTML = `\n        <div class=\"uba-modal-overlay\"></div>\n        <div class=\"uba-modal-dialog image-preview-dialog\">\n          <div class=\"uba-modal-header\">\n            <h3>${fileName}</h3>\n            <button class=\"uba-modal-close\">Ã—</button>\n          </div>\n          <div class=\"uba-modal-body\">\n            <img src=\"${dataUrl}\" alt=\"${fileName}\" class=\"preview-image\" />\n          </div>\n        </div>\n      `;\n      \n      document.body.appendChild(modal);\n      document.body.style.overflow = 'hidden';\n      \n      // Setup close handlers\n      const closeBtn = modal.querySelector('.uba-modal-close');\n      const overlay = modal.querySelector('.uba-modal-overlay');\n      \n      const closeModal = () => {\n        document.body.removeChild(modal);\n        document.body.style.overflow = '';\n      };\n      \n      closeBtn.addEventListener('click', closeModal);\n      overlay.addEventListener('click', closeModal);\n    },\n    \n    /**\n     * Remove file\n     */\n    removeFile(fileId) {\n      if (!this.fileUploads.currentExpense) return;\n      \n      this.fileUploads.currentExpense = this.fileUploads.currentExpense.filter(f => f.id !== fileId);\n      this.updateUploadedFilesDisplay();\n      \n      // Also remove from files section\n      const existingFiles = JSON.parse(localStorage.getItem('uba-files') || '[]');\n      const updatedFiles = existingFiles.filter(f => f.id !== fileId);\n      localStorage.setItem('uba-files', JSON.stringify(updatedFiles));\n      \n      this.showNotification('File removed', 'info');\n    },\n    \n    /**\n     * Setup enhanced dropdown design\n     */\n    enhanceDropdownDesign() {\n      console.log('ğŸ¨ Enhancing dropdown design');\n      \n      // Apply enhanced styling to all dropdowns\n      this.applyEnhancedDropdownStyles();\n      \n      // Setup dropdown interactions\n      this.setupDropdownInteractions();\n    },\n    \n    /**\n     * Apply enhanced dropdown styles\n     */\n    applyEnhancedDropdownStyles() {\n      // Add enhanced class to all select elements\n      document.querySelectorAll('select').forEach(select => {\n        select.classList.add('enhanced-dropdown');\n      });\n      \n      // Enhance expense category dropdown specifically\n      const categorySelect = document.getElementById('expense-category');\n      if (categorySelect) {\n        this.enhanceCategoryDropdown(categorySelect);\n      }\n    },\n    \n    /**\n     * Enhance category dropdown\n     */\n    enhanceCategoryDropdown(select) {\n      // Update category options with icons and colors\n      const options = select.querySelectorAll('option[data-category-id]');\n      options.forEach(option => {\n        const categoryId = option.getAttribute('data-category-id');\n        const category = this.categories.find(cat => cat.id === categoryId);\n        if (category) {\n          option.textContent = `${category.icon} ${category.name}`;\n          option.setAttribute('data-color', category.color);\n        }\n      });\n    },\n    \n    /**\n     * Setup dropdown interactions\n     */\n    setupDropdownInteractions() {\n      // Enhanced focus and hover effects are handled via CSS\n      // Add any additional JavaScript interactions here\n    },\n    \n    /**\n     * Initialize UI components\n     */\n    initializeUI() {\n      // Update category dropdown when page loads\n      setTimeout(() => {\n        this.updateExpenseFormCategories();\n      }, 500);\n    },\n    \n    // Utility methods\n    \n    /**\n     * Get expenses data\n     */\n    getExpensesData() {\n      if (window.ubaStore?.expenses) {\n        return window.ubaStore.expenses.getAll() || [];\n      }\n      // Fallback to demo data\n      return this.getDemoExpenses();\n    },\n    \n    /**\n     * Get demo expenses for chart testing\n     */\n    getDemoExpenses() {\n      const now = new Date();\n      return [\n        {\n          id: 'demo-1',\n          date: now.toISOString().slice(0, 10),\n          category: 'Software',\n          amount: 299,\n          description: 'Design software subscription'\n        },\n        {\n          id: 'demo-2',\n          date: new Date(now.getFullYear(), now.getMonth(), now.getDate() - 5).toISOString().slice(0, 10),\n          category: 'Office Supplies',\n          amount: 156,\n          description: 'Office equipment'\n        },\n        {\n          id: 'demo-3',\n          date: new Date(now.getFullYear(), now.getMonth() - 1, 15).toISOString().slice(0, 10),\n          category: 'Marketing',\n          amount: 850,\n          description: 'Social media ads'\n        }\n      ];\n    },\n    \n    /**\n     * Get expenses for specific period\n     */\n    getExpensesForPeriod(period) {\n      const expenses = this.getExpensesData();\n      const now = new Date();\n      \n      switch (period) {\n        case 'current-month':\n          const currentMonth = now.toISOString().slice(0, 7);\n          return expenses.filter(e => e.date && e.date.startsWith(currentMonth));\n          \n        case 'last-month':\n          const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1).toISOString().slice(0, 7);\n          return expenses.filter(e => e.date && e.date.startsWith(lastMonth));\n          \n        case 'last-3-months':\n          const threeMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 3, 1);\n          return expenses.filter(e => e.date && new Date(e.date) >= threeMonthsAgo);\n          \n        case 'last-6-months':\n          const sixMonthsAgo = new Date(now.getFullYear(), now.getMonth() - 6, 1);\n          return expenses.filter(e => e.date && new Date(e.date) >= sixMonthsAgo);\n          \n        default:\n          return expenses;\n      }\n    },\n    \n    /**\n     * Format amount with currency\n     */\n    formatAmount(amount) {\n      return new Intl.NumberFormat('en-US', {\n        style: 'currency',\n        currency: 'EUR'\n      }).format(amount || 0);\n    },\n    \n    /**\n     * Show notification\n     */\n    showNotification(message, type = 'info', options = {}) {\n      if (window.showToast) {\n        window.showToast(message, type, options);\n      } else {\n        console.log(`${type.toUpperCase()}: ${message}`);\n      }\n    }\n  };\n  \n  // Auto-initialize when DOM is ready\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      setTimeout(() => window.UBAEnhancedExpenses.init(), 1000);\n    });\n  } else {\n    setTimeout(() => window.UBAEnhancedExpenses.init(), 1000);\n  }\n  \n  console.log('âœ… Enhanced Expenses module loaded');\n  \n})();