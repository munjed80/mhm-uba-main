// enhanced-invoices.js - Comprehensive invoice enhancements with PDF export, monthly grouping, preview, templates, and auto client linking
(function() {
  'use strict';
  
  /**
   * Enhanced Invoices System - Main Module
   * Features: PDF export, Monthly grouping, Invoice preview, Template system, Auto client linking
   */
  window.UBAEnhancedInvoices = {
    
    // State management
    currentInvoice: null,
    templates: {},
    brandingSettings: {},
    clientList: [],
    
    /**
     * Initialize enhanced invoice system
     */
    init() {
      console.log('üßæ Initializing Enhanced Invoice System');
      
      this.loadBrandingSettings();
      this.loadInvoiceTemplates();
      this.setupMonthlyGrouping();
      this.setupInvoicePreview();
      this.setupAutoClientLinking();
      this.setupPDFExport();
      this.enhanceInvoiceModal();
      
      console.log('‚úÖ Enhanced Invoice System initialized');
    },
    
    /**
     * Load branding settings from localStorage
     */
    loadBrandingSettings() {
      try {
        const settings = localStorage.getItem('uba-invoice-branding');
        this.brandingSettings = settings ? JSON.parse(settings) : this.getDefaultBrandingSettings();
        console.log('‚úÖ Branding settings loaded');
      } catch (error) {
        console.warn('‚ö†Ô∏è Failed to load branding settings:', error);
        this.brandingSettings = this.getDefaultBrandingSettings();
      }
    },
    
    /**
     * Get default branding settings
     */
    getDefaultBrandingSettings() {
      return {
        companyName: 'MHM Business Solutions',
        companyAddress: '123 Business Avenue',
        companyCity: 'Amsterdam',
        companyCountry: 'Netherlands',
        companyPhone: '+31 20 123 4567',
        companyEmail: 'info@mhmuba.com',
        companyWebsite: 'www.mhmuba.com',
        logoUrl: '',
        primaryColor: '#2563eb',
        secondaryColor: '#64748b',
        accentColor: '#0f172a',
        fontFamily: 'Arial, sans-serif',
        headerStyle: 'modern',
        footerText: 'Thank you for your business!',
        paymentTerms: '30 days',
        bankDetails: {
          bankName: 'ABN AMRO Bank',
          accountNumber: 'NL12 ABNA 0123 4567 89',
          swiftCode: 'ABNANL2A'
        }
      };
    },
    
    /**
     * Save branding settings
     */
    saveBrandingSettings(settings) {
      try {
        this.brandingSettings = { ...this.brandingSettings, ...settings };
        localStorage.setItem('uba-invoice-branding', JSON.stringify(this.brandingSettings));
        console.log('‚úÖ Branding settings saved');
        this.updateTemplatesWithBranding();
      } catch (error) {
        console.error('‚ùå Failed to save branding settings:', error);
      }
    },
    
    /**
     * Load invoice templates
     */
    loadInvoiceTemplates() {
      try {
        const templates = localStorage.getItem('uba-invoice-templates');
        this.templates = templates ? JSON.parse(templates) : this.getDefaultTemplates();
        console.log('‚úÖ Invoice templates loaded');
      } catch (error) {
        console.warn('‚ö†Ô∏è Failed to load templates:', error);
        this.templates = this.getDefaultTemplates();
      }
    },
    
    /**
     * Get default invoice templates
     */
    getDefaultTemplates() {
      return {\n        modern: {\n          id: 'modern',\n          name: 'Modern Professional',\n          description: 'Clean, modern design with professional layout',\n          headerStyle: 'modern',\n          colorScheme: 'blue',\n          layoutStyle: 'standard'\n        },\n        classic: {\n          id: 'classic',\n          name: 'Classic Business',\n          description: 'Traditional business invoice layout',\n          headerStyle: 'classic',\n          colorScheme: 'gray',\n          layoutStyle: 'traditional'\n        },\n        creative: {\n          id: 'creative',\n          name: 'Creative Design',\n          description: 'Colorful and creative layout for design agencies',\n          headerStyle: 'creative',\n          colorScheme: 'colorful',\n          layoutStyle: 'creative'\n        }\n      };\n    },\n    \n    /**\n     * Update templates with current branding\n     */\n    updateTemplatesWithBranding() {\n      // Apply branding to all templates\n      Object.keys(this.templates).forEach(templateId => {\n        this.templates[templateId].branding = this.brandingSettings;\n      });\n    },\n    \n    /**\n     * Setup monthly grouping functionality\n     */\n    setupMonthlyGrouping() {\n      console.log('üìÖ Setting up monthly invoice grouping');\n      \n      // Add monthly view toggle to invoice page\n      const invoicesCard = document.getElementById('invoices-page');\n      if (invoicesCard) {\n        const header = invoicesCard.querySelector('.uba-card-header');\n        if (header) {\n          // Add view toggle buttons\n          const viewToggle = document.createElement('div');\n          viewToggle.className = 'invoice-view-toggle';\n          viewToggle.innerHTML = `\n            <div class=\"uba-btn-group\">\n              <button class=\"uba-btn uba-btn-sm invoice-view-btn active\" data-view=\"list\">\n                üìã List View\n              </button>\n              <button class=\"uba-btn uba-btn-sm invoice-view-btn\" data-view=\"monthly\">\n                üìÖ Monthly View\n              </button>\n            </div>\n          `;\n          \n          // Insert before new invoice button\n          const newInvoiceBtn = header.querySelector('#new-invoice-btn');\n          if (newInvoiceBtn) {\n            newInvoiceBtn.parentNode.insertBefore(viewToggle, newInvoiceBtn);\n          }\n          \n          // Attach event listeners\n          viewToggle.querySelectorAll('.invoice-view-btn').forEach(btn => {\n            btn.addEventListener('click', () => this.switchInvoiceView(btn.dataset.view));\n          });\n        }\n      }\n      \n      // Create monthly view container\n      this.createMonthlyViewContainer();\n    },\n    \n    /**\n     * Create monthly view container\n     */\n    createMonthlyViewContainer() {\n      const invoicesPage = document.getElementById('invoices-page');\n      if (!invoicesPage) return;\n      \n      const monthlyView = document.createElement('div');\n      monthlyView.id = 'monthly-invoices-view';\n      monthlyView.className = 'monthly-invoices-container hidden';\n      monthlyView.innerHTML = `\n        <div class=\"monthly-header\">\n          <div class=\"monthly-controls\">\n            <button class=\"uba-btn uba-btn-ghost\" id=\"prev-month\">‚Äπ Previous</button>\n            <h3 id=\"current-month-title\">Current Month</h3>\n            <button class=\"uba-btn uba-btn-ghost\" id=\"next-month\">Next ‚Ä∫</button>\n          </div>\n          <div class=\"monthly-stats\">\n            <div class=\"stat-item\">\n              <span class=\"stat-value\" id=\"month-total-amount\">‚Ç¨0</span>\n              <span class=\"stat-label\">Total Amount</span>\n            </div>\n            <div class=\"stat-item\">\n              <span class=\"stat-value\" id=\"month-invoice-count\">0</span>\n              <span class=\"stat-label\">Invoices</span>\n            </div>\n            <div class=\"stat-item\">\n              <span class=\"stat-value\" id=\"month-paid-count\">0</span>\n              <span class=\"stat-label\">Paid</span>\n            </div>\n          </div>\n        </div>\n        <div id=\"monthly-invoices-list\" class=\"monthly-invoices-list\">\n          <!-- Monthly grouped invoices will be rendered here -->\n        </div>\n      `;\n      \n      // Insert after the regular table\n      const tableWrap = invoicesPage.querySelector('.uba-table-wrap');\n      if (tableWrap) {\n        tableWrap.parentNode.insertBefore(monthlyView, tableWrap.nextSibling);\n      }\n      \n      // Setup monthly navigation\n      this.setupMonthlyNavigation();\n    },\n    \n    /**\n     * Setup monthly navigation\n     */\n    setupMonthlyNavigation() {\n      this.currentMonthDate = new Date();\n      \n      const prevBtn = document.getElementById('prev-month');\n      const nextBtn = document.getElementById('next-month');\n      \n      if (prevBtn) {\n        prevBtn.addEventListener('click', () => {\n          this.currentMonthDate.setMonth(this.currentMonthDate.getMonth() - 1);\n          this.renderMonthlyView();\n        });\n      }\n      \n      if (nextBtn) {\n        nextBtn.addEventListener('click', () => {\n          this.currentMonthDate.setMonth(this.currentMonthDate.getMonth() + 1);\n          this.renderMonthlyView();\n        });\n      }\n    },\n    \n    /**\n     * Switch between list and monthly view\n     */\n    switchInvoiceView(viewType) {\n      // Update button states\n      document.querySelectorAll('.invoice-view-btn').forEach(btn => {\n        btn.classList.toggle('active', btn.dataset.view === viewType);\n      });\n      \n      const listView = document.querySelector('.uba-table-wrap');\n      const monthlyView = document.getElementById('monthly-invoices-view');\n      \n      if (viewType === 'monthly') {\n        listView?.classList.add('hidden');\n        monthlyView?.classList.remove('hidden');\n        this.renderMonthlyView();\n      } else {\n        listView?.classList.remove('hidden');\n        monthlyView?.classList.add('hidden');\n      }\n    },\n    \n    /**\n     * Render monthly invoice view\n     */\n    renderMonthlyView() {\n      if (!window.ubaStore?.invoices) return;\n      \n      const invoices = window.ubaStore.invoices.getAll();\n      const currentMonth = this.currentMonthDate.getMonth();\n      const currentYear = this.currentMonthDate.getFullYear();\n      \n      // Filter invoices for current month\n      const monthlyInvoices = invoices.filter(invoice => {\n        const invoiceDate = new Date(invoice.created_at);\n        return invoiceDate.getMonth() === currentMonth && invoiceDate.getFullYear() === currentYear;\n      });\n      \n      // Update month title\n      const monthTitle = document.getElementById('current-month-title');\n      if (monthTitle) {\n        const monthName = this.currentMonthDate.toLocaleDateString('en', { month: 'long', year: 'numeric' });\n        monthTitle.textContent = monthName;\n      }\n      \n      // Calculate statistics\n      const totalAmount = monthlyInvoices.reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);\n      const paidInvoices = monthlyInvoices.filter(inv => inv.status === 'paid');\n      \n      // Update statistics\n      this.updateElement('month-total-amount', this.formatAmount(totalAmount));\n      this.updateElement('month-invoice-count', monthlyInvoices.length);\n      this.updateElement('month-paid-count', paidInvoices.length);\n      \n      // Render invoice list\n      const listContainer = document.getElementById('monthly-invoices-list');\n      if (listContainer) {\n        if (monthlyInvoices.length === 0) {\n          listContainer.innerHTML = `\n            <div class=\"empty-month\">\n              <p>No invoices found for ${monthTitle?.textContent}</p>\n            </div>\n          `;\n        } else {\n          listContainer.innerHTML = this.renderMonthlyInvoicesList(monthlyInvoices);\n        }\n      }\n    },\n    \n    /**\n     * Render monthly invoices list HTML\n     */\n    renderMonthlyInvoicesList(invoices) {\n      return `\n        <div class=\"monthly-invoices-grid\">\n          ${invoices.map(invoice => `\n            <div class=\"monthly-invoice-card\">\n              <div class=\"invoice-card-header\">\n                <div class=\"invoice-info\">\n                  <h4>${this.escapeHtml(invoice.client)}</h4>\n                  <p class=\"invoice-label\">${this.escapeHtml(invoice.label || 'Invoice')}</p>\n                </div>\n                <div class=\"invoice-amount\">\n                  <span class=\"amount\">${this.formatAmount(invoice.amount)}</span>\n                  <span class=\"status status-${invoice.status}\">${this.capitalizeFirst(invoice.status)}</span>\n                </div>\n              </div>\n              <div class=\"invoice-card-meta\">\n                <span class=\"invoice-date\">Created: ${this.formatDate(invoice.created_at)}</span>\n                ${invoice.due ? `<span class=\"invoice-due\">Due: ${this.formatDate(invoice.due)}</span>` : ''}\n              </div>\n              <div class=\"invoice-card-actions\">\n                <button class=\"uba-btn uba-btn-sm uba-btn-ghost\" onclick=\"window.UBAEnhancedInvoices.previewInvoice('${invoice.id}')\">\n                  üëÅÔ∏è Preview\n                </button>\n                <button class=\"uba-btn uba-btn-sm uba-btn-ghost\" onclick=\"window.UBAEnhancedInvoices.exportToPDF('${invoice.id}')\">\n                  üìÑ PDF\n                </button>\n                <button class=\"uba-btn uba-btn-sm uba-btn-ghost\" onclick=\"editInvoice('${invoice.id}')\">\n                  ‚úèÔ∏è Edit\n                </button>\n              </div>\n            </div>\n          `).join('')}\n        </div>\n      `;\n    },\n    \n    /**\n     * Setup invoice preview functionality\n     */\n    setupInvoicePreview() {\n      console.log('üëÅÔ∏è Setting up invoice preview');\n      \n      // Create preview modal\n      this.createInvoicePreviewModal();\n      \n      // Add preview button to invoice form\n      this.addPreviewButtonToForm();\n    },\n    \n    /**\n     * Create invoice preview modal\n     */\n    createInvoicePreviewModal() {\n      const previewModal = document.createElement('div');\n      previewModal.id = 'invoice-preview-modal';\n      previewModal.className = 'uba-modal invoice-preview-modal';\n      previewModal.innerHTML = `\n        <div class=\"uba-modal-overlay\" onclick=\"window.UBAEnhancedInvoices.closePreview()\"></div>\n        <div class=\"uba-modal-dialog invoice-preview-dialog\">\n          <div class=\"uba-modal-header\">\n            <h3>Invoice Preview</h3>\n            <div class=\"preview-actions\">\n              <button class=\"uba-btn uba-btn-ghost\" onclick=\"window.UBAEnhancedInvoices.exportToPDF()\">\n                üìÑ Export PDF\n              </button>\n              <button class=\"uba-btn uba-btn-primary\" onclick=\"window.UBAEnhancedInvoices.saveFromPreview()\">\n                üíæ Save Invoice\n              </button>\n              <button class=\"uba-modal-close\" onclick=\"window.UBAEnhancedInvoices.closePreview()\">√ó</button>\n            </div>\n          </div>\n          <div class=\"uba-modal-body preview-body\">\n            <div id=\"invoice-preview-content\" class=\"invoice-preview-content\">\n              <!-- Preview content will be rendered here -->\n            </div>\n          </div>\n        </div>\n      `;\n      \n      document.body.appendChild(previewModal);\n    },\n    \n    /**\n     * Add preview button to invoice form\n     */\n    addPreviewButtonToForm() {\n      const saveBtn = document.getElementById('save-invoice-btn');\n      if (saveBtn) {\n        const previewBtn = document.createElement('button');\n        previewBtn.type = 'button';\n        previewBtn.className = 'uba-btn uba-btn-ghost';\n        previewBtn.innerHTML = '<span>üëÅÔ∏è Preview</span>';\n        previewBtn.onclick = () => this.showInvoicePreview();\n        \n        // Insert before save button\n        saveBtn.parentNode.insertBefore(previewBtn, saveBtn);\n      }\n    },\n    \n    /**\n     * Show invoice preview\n     */\n    showInvoicePreview(invoiceId = null) {\n      let invoiceData;\n      \n      if (invoiceId) {\n        // Preview existing invoice\n        invoiceData = window.ubaStore?.invoices?.getById(invoiceId);\n        if (!invoiceData) {\n          console.error('Invoice not found:', invoiceId);\n          return;\n        }\n      } else {\n        // Preview current form data\n        invoiceData = this.getFormData();\n        if (!this.validateFormData(invoiceData)) {\n          return;\n        }\n      }\n      \n      this.currentInvoice = invoiceData;\n      \n      // Render preview content\n      const previewContent = document.getElementById('invoice-preview-content');\n      if (previewContent) {\n        previewContent.innerHTML = this.generateInvoiceHTML(invoiceData);\n      }\n      \n      // Show modal\n      const modal = document.getElementById('invoice-preview-modal');\n      if (modal) {\n        modal.classList.add('is-visible');\n        document.body.style.overflow = 'hidden';\n      }\n    },\n    \n    /**\n     * Get form data for preview\n     */\n    getFormData() {\n      return {\n        id: document.getElementById('invoice-edit-id')?.value || 'preview-' + Date.now(),\n        client: document.getElementById('invoice-client')?.value || '',\n        label: document.getElementById('invoice-label')?.value || '',\n        amount: parseFloat(document.getElementById('invoice-amount')?.value) || 0,\n        status: document.getElementById('invoice-status')?.value || 'draft',\n        due: document.getElementById('invoice-due')?.value || '',\n        notes: document.getElementById('invoice-notes')?.value || '',\n        created_at: new Date().toISOString()\n      };\n    },\n    \n    /**\n     * Validate form data\n     */\n    validateFormData(data) {\n      if (!data.client.trim()) {\n        this.showNotification('Client name is required', 'error');\n        return false;\n      }\n      if (!data.amount || data.amount <= 0) {\n        this.showNotification('Valid amount is required', 'error');\n        return false;\n      }\n      return true;\n    },\n    \n    /**\n     * Close preview modal\n     */\n    closePreview() {\n      const modal = document.getElementById('invoice-preview-modal');\n      if (modal) {\n        modal.classList.remove('is-visible');\n        document.body.style.overflow = '';\n      }\n      this.currentInvoice = null;\n    },\n    \n    /**\n     * Save invoice from preview\n     */\n    saveFromPreview() {\n      if (this.currentInvoice) {\n        // If it's a preview of form data, trigger normal save\n        if (this.currentInvoice.id.startsWith('preview-')) {\n          this.closePreview();\n          // Trigger the normal save process\n          const saveBtn = document.getElementById('save-invoice-btn');\n          if (saveBtn) {\n            saveBtn.click();\n          }\n        } else {\n          // Already saved invoice, just close preview\n          this.closePreview();\n        }\n      }\n    },\n    \n    /**\n     * Generate invoice HTML for preview/PDF\n     */\n    generateInvoiceHTML(invoice, template = 'modern') {\n      const settings = this.brandingSettings;\n      const invoiceNumber = invoice.id.replace(/^(inv-|preview-)/, 'INV-');\n      const issueDate = this.formatDate(invoice.created_at);\n      const dueDate = this.formatDate(invoice.due);\n      \n      return `\n        <div class=\"invoice-document template-${template}\">\n          ${this.generateInvoiceHeader(settings, invoice, invoiceNumber, issueDate, dueDate)}\n          ${this.generateBillToSection(invoice)}\n          ${this.generateInvoiceItems(invoice)}\n          ${this.generateInvoiceTotals(invoice)}\n          ${this.generateInvoiceFooter(settings, invoiceNumber)}\n        </div>\n      `;\n    },\n    \n    /**\n     * Generate invoice header\n     */\n    generateInvoiceHeader(settings, invoice, invoiceNumber, issueDate, dueDate) {\n      return `\n        <div class=\"invoice-header\">\n          <div class=\"company-info\">\n            ${settings.logoUrl ? `<img src=\"${settings.logoUrl}\" alt=\"Company Logo\" class=\"company-logo\" />` : ''}\n            <h1 style=\"color: ${settings.primaryColor}\">${settings.companyName}</h1>\n            <div class=\"company-details\">\n              <p>${settings.companyAddress}</p>\n              <p>${settings.companyCity}, ${settings.companyCountry}</p>\n              <p>Phone: ${settings.companyPhone}</p>\n              <p>Email: ${settings.companyEmail}</p>\n              ${settings.companyWebsite ? `<p>Web: ${settings.companyWebsite}</p>` : ''}\n            </div>\n          </div>\n          <div class=\"invoice-details\">\n            <h2 style=\"color: ${settings.accentColor}\">INVOICE</h2>\n            <div class=\"invoice-meta\">\n              <div class=\"meta-row\">\n                <span class=\"label\">Invoice #:</span>\n                <span class=\"value\">${invoiceNumber}</span>\n              </div>\n              <div class=\"meta-row\">\n                <span class=\"label\">Date:</span>\n                <span class=\"value\">${issueDate}</span>\n              </div>\n              <div class=\"meta-row\">\n                <span class=\"label\">Due Date:</span>\n                <span class=\"value\">${dueDate}</span>\n              </div>\n              <div class=\"meta-row\">\n                <span class=\"label\">Status:</span>\n                <span class=\"value status-${invoice.status}\">${this.capitalizeFirst(invoice.status)}</span>\n              </div>\n            </div>\n          </div>\n        </div>\n      `;\n    },\n    \n    /**\n     * Generate bill to section\n     */\n    generateBillToSection(invoice) {\n      return `\n        <div class=\"bill-to-section\">\n          <h3>Bill To:</h3>\n          <div class=\"client-info\">\n            <p class=\"client-name\">${this.escapeHtml(invoice.client)}</p>\n          </div>\n        </div>\n      `;\n    },\n    \n    /**\n     * Generate invoice items\n     */\n    generateInvoiceItems(invoice) {\n      return `\n        <div class=\"invoice-items\">\n          <table class=\"items-table\">\n            <thead>\n              <tr>\n                <th>Description</th>\n                <th>Quantity</th>\n                <th>Rate</th>\n                <th>Amount</th>\n              </tr>\n            </thead>\n            <tbody>\n              <tr>\n                <td>\n                  <strong>${this.escapeHtml(invoice.label || 'Service')}</strong>\n                  ${invoice.notes ? `<br><small>${this.escapeHtml(invoice.notes)}</small>` : ''}\n                </td>\n                <td>1</td>\n                <td>${this.formatAmount(invoice.amount)}</td>\n                <td>${this.formatAmount(invoice.amount)}</td>\n              </tr>\n            </tbody>\n          </table>\n        </div>\n      `;\n    },\n    \n    /**\n     * Generate invoice totals\n     */\n    generateInvoiceTotals(invoice) {\n      const amount = parseFloat(invoice.amount) || 0;\n      const tax = 0; // No tax for now\n      const total = amount + tax;\n      \n      return `\n        <div class=\"invoice-totals\">\n          <div class=\"totals-section\">\n            <div class=\"total-row\">\n              <span class=\"label\">Subtotal:</span>\n              <span class=\"value\">${this.formatAmount(amount)}</span>\n            </div>\n            <div class=\"total-row\">\n              <span class=\"label\">Tax:</span>\n              <span class=\"value\">${this.formatAmount(tax)}</span>\n            </div>\n            <div class=\"total-row final-total\">\n              <span class=\"label\">Total:</span>\n              <span class=\"value\">${this.formatAmount(total)}</span>\n            </div>\n          </div>\n        </div>\n      `;\n    },\n    \n    /**\n     * Generate invoice footer\n     */\n    generateInvoiceFooter(settings, invoiceNumber) {\n      return `\n        <div class=\"invoice-footer\">\n          <div class=\"payment-info\">\n            <h4>Payment Information</h4>\n            <p><strong>Bank:</strong> ${settings.bankDetails.bankName}</p>\n            <p><strong>Account:</strong> ${settings.bankDetails.accountNumber}</p>\n            <p><strong>Swift:</strong> ${settings.bankDetails.swiftCode}</p>\n            <p><strong>Reference:</strong> ${invoiceNumber}</p>\n          </div>\n          <div class=\"terms\">\n            <h4>Payment Terms</h4>\n            <p>Payment due within ${settings.paymentTerms} from invoice date.</p>\n            <p>${settings.footerText}</p>\n          </div>\n        </div>\n      `;\n    },\n    \n    /**\n     * Setup auto client linking\n     */\n    setupAutoClientLinking() {\n      console.log('üîó Setting up auto client linking');\n      \n      const clientInput = document.getElementById('invoice-client');\n      if (!clientInput) return;\n      \n      // Replace text input with searchable dropdown\n      this.createClientDropdown(clientInput);\n    },\n    \n    /**\n     * Create client dropdown with search\n     */\n    createClientDropdown(originalInput) {\n      // Create container\n      const container = document.createElement('div');\n      container.className = 'client-dropdown-container';\n      \n      // Create searchable input\n      const searchInput = document.createElement('input');\n      searchInput.type = 'text';\n      searchInput.id = 'invoice-client-search';\n      searchInput.className = 'uba-input client-search-input';\n      searchInput.placeholder = 'Search or add new client...';\n      searchInput.value = originalInput.value;\n      \n      // Create dropdown list\n      const dropdown = document.createElement('div');\n      dropdown.className = 'client-dropdown-list';\n      dropdown.id = 'client-dropdown-list';\n      \n      // Assemble container\n      container.appendChild(searchInput);\n      container.appendChild(dropdown);\n      \n      // Replace original input\n      originalInput.parentNode.insertBefore(container, originalInput);\n      originalInput.style.display = 'none';\n      \n      // Setup event listeners\n      this.setupClientDropdownEvents(searchInput, dropdown, originalInput);\n      \n      // Load initial client list\n      this.updateClientList();\n    },\n    \n    /**\n     * Setup client dropdown events\n     */\n    setupClientDropdownEvents(searchInput, dropdown, hiddenInput) {\n      let isDropdownOpen = false;\n      \n      // Search input events\n      searchInput.addEventListener('input', (e) => {\n        const query = e.target.value.toLowerCase();\n        this.filterClientDropdown(query);\n        hiddenInput.value = e.target.value;\n        \n        if (!isDropdownOpen) {\n          this.showClientDropdown();\n          isDropdownOpen = true;\n        }\n      });\n      \n      searchInput.addEventListener('focus', () => {\n        this.showClientDropdown();\n        isDropdownOpen = true;\n      });\n      \n      searchInput.addEventListener('blur', () => {\n        // Delay hiding to allow clicks on dropdown items\n        setTimeout(() => {\n          this.hideClientDropdown();\n          isDropdownOpen = false;\n        }, 200);\n      });\n      \n      // Click outside to close\n      document.addEventListener('click', (e) => {\n        if (!e.target.closest('.client-dropdown-container')) {\n          this.hideClientDropdown();\n          isDropdownOpen = false;\n        }\n      });\n    },\n    \n    /**\n     * Update client list from store\n     */\n    updateClientList() {\n      if (window.ubaStore?.clients) {\n        this.clientList = window.ubaStore.clients.getAll() || [];\n      } else {\n        // Fallback: extract clients from invoices\n        const invoices = window.ubaStore?.invoices?.getAll() || [];\n        const clientNames = [...new Set(invoices.map(inv => inv.client).filter(Boolean))];\n        this.clientList = clientNames.map(name => ({ name, id: name.toLowerCase().replace(/\\s+/g, '-') }));\n      }\n      \n      this.renderClientDropdown();\n    },\n    \n    /**\n     * Render client dropdown\n     */\n    renderClientDropdown() {\n      const dropdown = document.getElementById('client-dropdown-list');\n      if (!dropdown) return;\n      \n      if (this.clientList.length === 0) {\n        dropdown.innerHTML = `\n          <div class=\"dropdown-item dropdown-empty\">\n            <span>No clients found</span>\n          </div>\n        `;\n        return;\n      }\n      \n      dropdown.innerHTML = this.clientList.map(client => `\n        <div class=\"dropdown-item\" data-client-name=\"${this.escapeHtml(client.name || client.id)}\">\n          <span class=\"client-name\">${this.escapeHtml(client.name || client.id)}</span>\n          ${client.email ? `<small class=\"client-email\">${this.escapeHtml(client.email)}</small>` : ''}\n        </div>\n      `).join('');\n      \n      // Attach click events\n      dropdown.querySelectorAll('.dropdown-item[data-client-name]').forEach(item => {\n        item.addEventListener('click', () => {\n          const clientName = item.dataset.clientName;\n          this.selectClient(clientName);\n        });\n      });\n    },\n    \n    /**\n     * Filter client dropdown\n     */\n    filterClientDropdown(query) {\n      const dropdown = document.getElementById('client-dropdown-list');\n      if (!dropdown) return;\n      \n      const items = dropdown.querySelectorAll('.dropdown-item[data-client-name]');\n      let visibleCount = 0;\n      \n      items.forEach(item => {\n        const clientName = item.dataset.clientName.toLowerCase();\n        const isVisible = clientName.includes(query);\n        item.style.display = isVisible ? 'block' : 'none';\n        if (isVisible) visibleCount++;\n      });\n      \n      // Show \"Add new client\" option if no matches and query is not empty\n      if (visibleCount === 0 && query.trim()) {\n        const addNewItem = dropdown.querySelector('.dropdown-add-new');\n        if (!addNewItem) {\n          const newItem = document.createElement('div');\n          newItem.className = 'dropdown-item dropdown-add-new';\n          newItem.innerHTML = `\n            <span class=\"add-new-text\">‚ûï Add \"${this.escapeHtml(query)}\" as new client</span>\n          `;\n          newItem.addEventListener('click', () => {\n            this.selectClient(query);\n          });\n          dropdown.appendChild(newItem);\n        } else {\n          addNewItem.innerHTML = `\n            <span class=\"add-new-text\">‚ûï Add \"${this.escapeHtml(query)}\" as new client</span>\n          `;\n          addNewItem.style.display = 'block';\n        }\n      } else {\n        const addNewItem = dropdown.querySelector('.dropdown-add-new');\n        if (addNewItem) {\n          addNewItem.style.display = 'none';\n        }\n      }\n    },\n    \n    /**\n     * Select client from dropdown\n     */\n    selectClient(clientName) {\n      const searchInput = document.getElementById('invoice-client-search');\n      const hiddenInput = document.getElementById('invoice-client');\n      \n      if (searchInput) searchInput.value = clientName;\n      if (hiddenInput) hiddenInput.value = clientName;\n      \n      this.hideClientDropdown();\n    },\n    \n    /**\n     * Show client dropdown\n     */\n    showClientDropdown() {\n      const dropdown = document.getElementById('client-dropdown-list');\n      if (dropdown) {\n        dropdown.classList.add('visible');\n      }\n    },\n    \n    /**\n     * Hide client dropdown\n     */\n    hideClientDropdown() {\n      const dropdown = document.getElementById('client-dropdown-list');\n      if (dropdown) {\n        dropdown.classList.remove('visible');\n      }\n    },\n    \n    /**\n     * Setup PDF export functionality\n     */\n    setupPDFExport() {\n      console.log('üìÑ Setting up PDF export functionality');\n      \n      // Add export buttons to invoice actions\n      this.enhanceInvoiceActions();\n    },\n    \n    /**\n     * Enhance invoice actions with PDF export\n     */\n    enhanceInvoiceActions() {\n      // This will be called after the table is rendered\n      // We'll add export buttons dynamically\n    },\n    \n    /**\n     * Export invoice to PDF\n     */\n    async exportToPDF(invoiceId = null) {\n      try {\n        let invoice;\n        \n        if (invoiceId) {\n          invoice = window.ubaStore?.invoices?.getById(invoiceId);\n          if (!invoice) {\n            this.showNotification('Invoice not found', 'error');\n            return;\n          }\n        } else {\n          // Export current preview\n          invoice = this.currentInvoice;\n          if (!invoice) {\n            this.showNotification('No invoice to export', 'error');\n            return;\n          }\n        }\n        \n        // Load jsPDF if not already loaded\n        await this.loadJSPDF();\n        \n        // Generate PDF\n        this.generatePDF(invoice);\n        \n      } catch (error) {\n        console.error('‚ùå Error exporting PDF:', error);\n        this.showNotification('Failed to export PDF', 'error');\n      }\n    },\n    \n    /**\n     * Load jsPDF library\n     */\n    async loadJSPDF() {\n      if (window.jsPDF) return;\n      \n      return new Promise((resolve, reject) => {\n        const script = document.createElement('script');\n        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';\n        script.onload = () => {\n          if (window.jsPDF) {\n            resolve();\n          } else {\n            reject(new Error('jsPDF failed to initialize'));\n          }\n        };\n        script.onerror = () => reject(new Error('Failed to load jsPDF'));\n        document.head.appendChild(script);\n      });\n    },\n    \n    /**\n     * Generate PDF document\n     */\n    generatePDF(invoice) {\n      const { jsPDF } = window.jsPDF;\n      const doc = new jsPDF('p', 'mm', 'a4');\n      const settings = this.brandingSettings;\n      \n      // Set up fonts\n      doc.setFont('helvetica');\n      \n      // Page dimensions\n      const pageWidth = doc.internal.pageSize.getWidth();\n      const pageHeight = doc.internal.pageSize.getHeight();\n      const margin = 20;\n      \n      let yPos = margin;\n      \n      // Header\n      doc.setFontSize(24);\n      doc.setFont('helvetica', 'bold');\n      doc.setTextColor(settings.primaryColor || '#2563eb');\n      doc.text(settings.companyName, margin, yPos);\n      \n      yPos += 15;\n      \n      // Company details\n      doc.setFontSize(10);\n      doc.setFont('helvetica', 'normal');\n      doc.setTextColor(100, 100, 100);\n      doc.text(settings.companyAddress, margin, yPos);\n      yPos += 5;\n      doc.text(`${settings.companyCity}, ${settings.companyCountry}`, margin, yPos);\n      yPos += 5;\n      doc.text(`Phone: ${settings.companyPhone}`, margin, yPos);\n      yPos += 5;\n      doc.text(`Email: ${settings.companyEmail}`, margin, yPos);\n      \n      // Invoice title and details (right side)\n      const rightX = pageWidth - 80;\n      doc.setFontSize(20);\n      doc.setFont('helvetica', 'bold');\n      doc.setTextColor(50, 50, 50);\n      doc.text('INVOICE', rightX, margin + 10);\n      \n      doc.setFontSize(10);\n      doc.setFont('helvetica', 'normal');\n      const invoiceNumber = invoice.id.replace(/^(inv-|preview-)/, 'INV-');\n      doc.text(`Invoice #: ${invoiceNumber}`, rightX, margin + 20);\n      doc.text(`Date: ${this.formatDate(invoice.created_at)}`, rightX, margin + 25);\n      doc.text(`Due: ${this.formatDate(invoice.due)}`, rightX, margin + 30);\n      doc.text(`Status: ${this.capitalizeFirst(invoice.status)}`, rightX, margin + 35);\n      \n      yPos = margin + 50;\n      \n      // Separator line\n      doc.setDrawColor(200, 200, 200);\n      doc.line(margin, yPos, pageWidth - margin, yPos);\n      yPos += 10;\n      \n      // Bill To\n      doc.setFontSize(12);\n      doc.setFont('helvetica', 'bold');\n      doc.setTextColor(50, 50, 50);\n      doc.text('Bill To:', margin, yPos);\n      yPos += 8;\n      \n      doc.setFontSize(11);\n      doc.setFont('helvetica', 'normal');\n      doc.text(invoice.client, margin, yPos);\n      yPos += 20;\n      \n      // Items table header\n      const tableY = yPos;\n      doc.setFontSize(11);\n      doc.setFont('helvetica', 'bold');\n      doc.setTextColor(50, 50, 50);\n      \n      doc.text('Description', margin, tableY);\n      doc.text('Qty', pageWidth - 80, tableY);\n      doc.text('Rate', pageWidth - 60, tableY);\n      doc.text('Amount', pageWidth - 40, tableY);\n      \n      // Table header line\n      doc.setDrawColor(150, 150, 150);\n      doc.line(margin, tableY + 2, pageWidth - margin, tableY + 2);\n      \n      yPos = tableY + 10;\n      \n      // Items\n      doc.setFont('helvetica', 'normal');\n      doc.text(invoice.label || 'Service', margin, yPos);\n      doc.text('1', pageWidth - 80, yPos);\n      doc.text(this.formatAmount(invoice.amount), pageWidth - 60, yPos);\n      doc.text(this.formatAmount(invoice.amount), pageWidth - 40, yPos);\n      \n      yPos += 20;\n      \n      // Totals\n      const totalsX = pageWidth - 80;\n      doc.setDrawColor(100, 100, 100);\n      doc.line(totalsX, yPos, pageWidth - margin, yPos);\n      yPos += 8;\n      \n      doc.setFont('helvetica', 'normal');\n      doc.text('Subtotal:', totalsX, yPos);\n      doc.text(this.formatAmount(invoice.amount), pageWidth - 40, yPos);\n      yPos += 6;\n      \n      doc.text('Tax:', totalsX, yPos);\n      doc.text('‚Ç¨0.00', pageWidth - 40, yPos);\n      yPos += 10;\n      \n      doc.setFont('helvetica', 'bold');\n      doc.setFontSize(12);\n      doc.text('Total:', totalsX, yPos);\n      doc.text(this.formatAmount(invoice.amount), pageWidth - 40, yPos);\n      \n      yPos += 30;\n      \n      // Payment information\n      if (yPos > pageHeight - 80) {\n        doc.addPage();\n        yPos = margin;\n      }\n      \n      doc.setFontSize(11);\n      doc.setFont('helvetica', 'bold');\n      doc.text('Payment Information:', margin, yPos);\n      yPos += 8;\n      \n      doc.setFont('helvetica', 'normal');\n      doc.text(`Bank: ${settings.bankDetails.bankName}`, margin, yPos);\n      yPos += 5;\n      doc.text(`Account: ${settings.bankDetails.accountNumber}`, margin, yPos);\n      yPos += 5;\n      doc.text(`Swift: ${settings.bankDetails.swiftCode}`, margin, yPos);\n      yPos += 5;\n      doc.text(`Reference: ${invoiceNumber}`, margin, yPos);\n      yPos += 15;\n      \n      // Terms\n      doc.setFont('helvetica', 'bold');\n      doc.text('Payment Terms:', margin, yPos);\n      yPos += 8;\n      \n      doc.setFont('helvetica', 'normal');\n      doc.text(`Payment due within ${settings.paymentTerms} from invoice date.`, margin, yPos);\n      yPos += 5;\n      doc.text(settings.footerText, margin, yPos);\n      \n      // Save PDF\n      const filename = `invoice-${invoiceNumber.toLowerCase()}-${invoice.client.replace(/[^a-z0-9]/gi, '-').toLowerCase()}.pdf`;\n      doc.save(filename);\n      \n      this.showNotification(`PDF saved: ${filename}`, 'success');\n    },\n    \n    /**\n     * Enhance invoice modal with new features\n     */\n    enhanceInvoiceModal() {\n      // Add template selector to modal\n      this.addTemplateSelector();\n      \n      // Add branding settings button\n      this.addBrandingButton();\n    },\n    \n    /**\n     * Add template selector to modal\n     */\n    addTemplateSelector() {\n      const notesGroup = document.querySelector('#invoice-modal .uba-form-group:last-child');\n      if (!notesGroup) return;\n      \n      const templateGroup = document.createElement('div');\n      templateGroup.className = 'uba-form-group';\n      templateGroup.innerHTML = `\n        <label for=\"invoice-template\">Invoice Template</label>\n        <select id=\"invoice-template\" class=\"uba-select\">\n          ${Object.values(this.templates).map(template => `\n            <option value=\"${template.id}\">${template.name}</option>\n          `).join('')}\n        </select>\n        <small class=\"form-help\">Choose the template style for your invoice</small>\n      `;\n      \n      // Insert before notes\n      notesGroup.parentNode.insertBefore(templateGroup, notesGroup);\n    },\n    \n    /**\n     * Add branding settings button\n     */\n    addBrandingButton() {\n      const modalFooter = document.querySelector('#invoice-modal .uba-modal-footer');\n      if (!modalFooter) return;\n      \n      const brandingBtn = document.createElement('button');\n      brandingBtn.type = 'button';\n      brandingBtn.className = 'uba-btn uba-btn-ghost';\n      brandingBtn.innerHTML = '<span>üé® Branding</span>';\n      brandingBtn.onclick = () => this.openBrandingSettings();\n      \n      // Insert before cancel button\n      const cancelBtn = modalFooter.querySelector('.uba-btn-ghost');\n      if (cancelBtn) {\n        modalFooter.insertBefore(brandingBtn, cancelBtn);\n      }\n    },\n    \n    /**\n     * Open branding settings modal\n     */\n    openBrandingSettings() {\n      // Create branding settings modal if it doesn't exist\n      if (!document.getElementById('branding-settings-modal')) {\n        this.createBrandingModal();\n      }\n      \n      // Show modal\n      const modal = document.getElementById('branding-settings-modal');\n      if (modal) {\n        modal.classList.add('is-visible');\n        document.body.style.overflow = 'hidden';\n        this.populateBrandingForm();\n      }\n    },\n    \n    /**\n     * Create branding settings modal\n     */\n    createBrandingModal() {\n      const modal = document.createElement('div');\n      modal.id = 'branding-settings-modal';\n      modal.className = 'uba-modal branding-settings-modal';\n      modal.innerHTML = `\n        <div class=\"uba-modal-overlay\" onclick=\"window.UBAEnhancedInvoices.closeBrandingSettings()\"></div>\n        <div class=\"uba-modal-dialog\">\n          <div class=\"uba-modal-header\">\n            <h3>Invoice Branding Settings</h3>\n            <button class=\"uba-modal-close\" onclick=\"window.UBAEnhancedInvoices.closeBrandingSettings()\">√ó</button>\n          </div>\n          <div class=\"uba-modal-body\">\n            <form id=\"branding-form\" class=\"uba-form\">\n              <div class=\"uba-form-row\">\n                <div class=\"uba-form-group\">\n                  <label for=\"branding-company-name\">Company Name</label>\n                  <input type=\"text\" id=\"branding-company-name\" class=\"uba-input\" />\n                </div>\n                <div class=\"uba-form-group\">\n                  <label for=\"branding-logo-url\">Logo URL</label>\n                  <input type=\"url\" id=\"branding-logo-url\" class=\"uba-input\" placeholder=\"https://...\" />\n                </div>\n              </div>\n              \n              <div class=\"uba-form-group\">\n                <label for=\"branding-address\">Address</label>\n                <input type=\"text\" id=\"branding-address\" class=\"uba-input\" />\n              </div>\n              \n              <div class=\"uba-form-row\">\n                <div class=\"uba-form-group\">\n                  <label for=\"branding-city\">City</label>\n                  <input type=\"text\" id=\"branding-city\" class=\"uba-input\" />\n                </div>\n                <div class=\"uba-form-group\">\n                  <label for=\"branding-country\">Country</label>\n                  <input type=\"text\" id=\"branding-country\" class=\"uba-input\" />\n                </div>\n              </div>\n              \n              <div class=\"uba-form-row\">\n                <div class=\"uba-form-group\">\n                  <label for=\"branding-phone\">Phone</label>\n                  <input type=\"text\" id=\"branding-phone\" class=\"uba-input\" />\n                </div>\n                <div class=\"uba-form-group\">\n                  <label for=\"branding-email\">Email</label>\n                  <input type=\"email\" id=\"branding-email\" class=\"uba-input\" />\n                </div>\n              </div>\n              \n              <div class=\"uba-form-group\">\n                <label for=\"branding-website\">Website</label>\n                <input type=\"text\" id=\"branding-website\" class=\"uba-input\" placeholder=\"www.example.com\" />\n              </div>\n              \n              <div class=\"uba-form-section\">\n                <h4>Colors</h4>\n                <div class=\"uba-form-row\">\n                  <div class=\"uba-form-group\">\n                    <label for=\"branding-primary-color\">Primary Color</label>\n                    <input type=\"color\" id=\"branding-primary-color\" class=\"uba-input color-input\" />\n                  </div>\n                  <div class=\"uba-form-group\">\n                    <label for=\"branding-accent-color\">Accent Color</label>\n                    <input type=\"color\" id=\"branding-accent-color\" class=\"uba-input color-input\" />\n                  </div>\n                </div>\n              </div>\n              \n              <div class=\"uba-form-section\">\n                <h4>Payment Details</h4>\n                <div class=\"uba-form-row\">\n                  <div class=\"uba-form-group\">\n                    <label for=\"branding-bank-name\">Bank Name</label>\n                    <input type=\"text\" id=\"branding-bank-name\" class=\"uba-input\" />\n                  </div>\n                  <div class=\"uba-form-group\">\n                    <label for=\"branding-payment-terms\">Payment Terms (days)</label>\n                    <input type=\"number\" id=\"branding-payment-terms\" class=\"uba-input\" min=\"1\" />\n                  </div>\n                </div>\n                <div class=\"uba-form-row\">\n                  <div class=\"uba-form-group\">\n                    <label for=\"branding-account-number\">Account Number / IBAN</label>\n                    <input type=\"text\" id=\"branding-account-number\" class=\"uba-input\" />\n                  </div>\n                  <div class=\"uba-form-group\">\n                    <label for=\"branding-swift-code\">Swift Code</label>\n                    <input type=\"text\" id=\"branding-swift-code\" class=\"uba-input\" />\n                  </div>\n                </div>\n              </div>\n              \n              <div class=\"uba-form-group\">\n                <label for=\"branding-footer-text\">Footer Text</label>\n                <textarea id=\"branding-footer-text\" class=\"uba-textarea\" rows=\"2\" placeholder=\"Thank you message...\"></textarea>\n              </div>\n            </form>\n          </div>\n          <div class=\"uba-modal-footer\">\n            <button type=\"button\" class=\"uba-btn uba-btn-ghost\" onclick=\"window.UBAEnhancedInvoices.closeBrandingSettings()\">Cancel</button>\n            <button type=\"button\" class=\"uba-btn uba-btn-primary\" onclick=\"window.UBAEnhancedInvoices.saveBrandingSettings()\">Save Branding</button>\n          </div>\n        </div>\n      `;\n      \n      document.body.appendChild(modal);\n    },\n    \n    /**\n     * Populate branding form with current settings\n     */\n    populateBrandingForm() {\n      const settings = this.brandingSettings;\n      \n      this.updateElement('branding-company-name', settings.companyName, 'value');\n      this.updateElement('branding-logo-url', settings.logoUrl, 'value');\n      this.updateElement('branding-address', settings.companyAddress, 'value');\n      this.updateElement('branding-city', settings.companyCity, 'value');\n      this.updateElement('branding-country', settings.companyCountry, 'value');\n      this.updateElement('branding-phone', settings.companyPhone, 'value');\n      this.updateElement('branding-email', settings.companyEmail, 'value');\n      this.updateElement('branding-website', settings.companyWebsite, 'value');\n      this.updateElement('branding-primary-color', settings.primaryColor, 'value');\n      this.updateElement('branding-accent-color', settings.accentColor, 'value');\n      this.updateElement('branding-bank-name', settings.bankDetails.bankName, 'value');\n      this.updateElement('branding-account-number', settings.bankDetails.accountNumber, 'value');\n      this.updateElement('branding-swift-code', settings.bankDetails.swiftCode, 'value');\n      this.updateElement('branding-payment-terms', settings.paymentTerms, 'value');\n      this.updateElement('branding-footer-text', settings.footerText, 'value');\n    },\n    \n    /**\n     * Save branding settings\n     */\n    saveBrandingSettings() {\n      const formData = {\n        companyName: document.getElementById('branding-company-name')?.value || '',\n        logoUrl: document.getElementById('branding-logo-url')?.value || '',\n        companyAddress: document.getElementById('branding-address')?.value || '',\n        companyCity: document.getElementById('branding-city')?.value || '',\n        companyCountry: document.getElementById('branding-country')?.value || '',\n        companyPhone: document.getElementById('branding-phone')?.value || '',\n        companyEmail: document.getElementById('branding-email')?.value || '',\n        companyWebsite: document.getElementById('branding-website')?.value || '',\n        primaryColor: document.getElementById('branding-primary-color')?.value || '#2563eb',\n        accentColor: document.getElementById('branding-accent-color')?.value || '#0f172a',\n        paymentTerms: document.getElementById('branding-payment-terms')?.value || '30',\n        footerText: document.getElementById('branding-footer-text')?.value || '',\n        bankDetails: {\n          bankName: document.getElementById('branding-bank-name')?.value || '',\n          accountNumber: document.getElementById('branding-account-number')?.value || '',\n          swiftCode: document.getElementById('branding-swift-code')?.value || ''\n        }\n      };\n      \n      this.saveBrandingSettings(formData);\n      this.closeBrandingSettings();\n      this.showNotification('Branding settings saved successfully!', 'success');\n    },\n    \n    /**\n     * Close branding settings modal\n     */\n    closeBrandingSettings() {\n      const modal = document.getElementById('branding-settings-modal');\n      if (modal) {\n        modal.classList.remove('is-visible');\n        document.body.style.overflow = '';\n      }\n    },\n    \n    // Utility methods\n    \n    /**\n     * Preview specific invoice\n     */\n    previewInvoice(invoiceId) {\n      this.showInvoicePreview(invoiceId);\n    },\n    \n    /**\n     * Update element content or attribute\n     */\n    updateElement(id, value, type = 'textContent') {\n      const element = document.getElementById(id);\n      if (element && value !== undefined) {\n        element[type] = value;\n      }\n    },\n    \n    /**\n     * Show notification\n     */\n    showNotification(message, type = 'info', options = {}) {\n      if (window.showToast) {\n        window.showToast(message, type, options);\n      } else {\n        console.log(`${type.toUpperCase()}: ${message}`);\n      }\n    },\n    \n    /**\n     * Format amount with currency\n     */\n    formatAmount(amount) {\n      const num = parseFloat(amount) || 0;\n      return `‚Ç¨${num.toFixed(2)}`;\n    },\n    \n    /**\n     * Format date\n     */\n    formatDate(dateStr) {\n      if (!dateStr) return '‚Äî';\n      try {\n        const date = new Date(dateStr);\n        return date.toLocaleDateString('en-GB');\n      } catch (e) {\n        return '‚Äî';\n      }\n    },\n    \n    /**\n     * Escape HTML\n     */\n    escapeHtml(text) {\n      if (typeof text !== 'string') return text || '';\n      const div = document.createElement('div');\n      div.textContent = text;\n      return div.innerHTML;\n    },\n    \n    /**\n     * Capitalize first letter\n     */\n    capitalizeFirst(str) {\n      if (!str) return '';\n      return str.charAt(0).toUpperCase() + str.slice(1);\n    }\n  };\n  \n  // Auto-initialize when DOM is ready\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      setTimeout(() => window.UBAEnhancedInvoices.init(), 1000);\n    });\n  } else {\n    setTimeout(() => window.UBAEnhancedInvoices.init(), 1000);\n  }\n  \n  console.log('‚úÖ Enhanced Invoices module loaded');\n  \n})();