// client-relationships.js — Cross-linking system for clients, projects, and invoices
(function() {
  'use strict';
  
  /**
   * Get all projects related to a client
   * @param {string} clientId - Client ID or name
   * @returns {Array} Array of related projects
   */\n  function getClientProjects(clientId) {\n    const store = window.ubaStore;\n    if (!store || !store.projects) return [];\n    \n    const projects = store.projects.getAll();\n    const clients = store.clients.getAll();\n    \n    // Find client by ID or name\n    const client = clients.find(c => c.id === clientId || c.name === clientId);\n    if (!client) return [];\n    \n    // Find projects that mention this client\n    return projects.filter(project => {\n      return (\n        project.client_id === client.id ||\n        project.client === client.name ||\n        (project.name && project.name.toLowerCase().includes(client.name.toLowerCase())) ||\n        (project.description && project.description.toLowerCase().includes(client.name.toLowerCase()))\n      );\n    });\n  }\n  \n  /**\n   * Get all invoices related to a client\n   * @param {string} clientId - Client ID or name  \n   * @returns {Array} Array of related invoices\n   */\n  function getClientInvoices(clientId) {\n    const store = window.ubaStore;\n    if (!store || !store.invoices) return [];\n    \n    const invoices = store.invoices.getAll();\n    const clients = store.clients.getAll();\n    \n    // Find client by ID or name\n    const client = clients.find(c => c.id === clientId || c.name === clientId);\n    if (!client) return [];\n    \n    // Find invoices for this client\n    return invoices.filter(invoice => {\n      return (\n        invoice.client_id === client.id ||\n        invoice.client === client.name ||\n        (invoice.client && invoice.client.toLowerCase().includes(client.name.toLowerCase()))\n      );\n    });\n  }\n  \n  /**\n   * Get client summary with financial and project data\n   * @param {string} clientId - Client ID\n   * @returns {Object} Client summary object\n   */\n  function getClientSummary(clientId) {\n    const store = window.ubaStore;\n    if (!store || !store.clients) return null;\n    \n    const client = store.clients.getAll().find(c => c.id === clientId);\n    if (!client) return null;\n    \n    const projects = getClientProjects(clientId);\n    const invoices = getClientInvoices(clientId);\n    \n    // Calculate financial metrics\n    const totalInvoiced = invoices.reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);\n    const paidInvoices = invoices.filter(inv => inv.status === 'paid');\n    const unpaidInvoices = invoices.filter(inv => ['sent', 'draft', 'overdue'].includes(inv.status));\n    const totalPaid = paidInvoices.reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);\n    const totalUnpaid = unpaidInvoices.reduce((sum, inv) => sum + (parseFloat(inv.amount) || 0), 0);\n    \n    // Calculate project metrics\n    const activeProjects = projects.filter(p => ['in_progress', 'ongoing'].includes(p.stage || p.status));\n    const completedProjects = projects.filter(p => ['completed', 'done'].includes(p.stage || p.status));\n    const leadProjects = projects.filter(p => p.stage === 'lead');\n    \n    // Calculate engagement metrics\n    const lastInvoice = invoices\n      .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0))[0];\n    const lastProject = projects\n      .sort((a, b) => new Date(b.created_at || 0) - new Date(a.created_at || 0))[0];\n    \n    const daysSinceLastInvoice = lastInvoice ? \n      Math.floor((Date.now() - new Date(lastInvoice.created_at).getTime()) / (1000 * 60 * 60 * 24)) : null;\n    const daysSinceLastProject = lastProject ?\n      Math.floor((Date.now() - new Date(lastProject.created_at).getTime()) / (1000 * 60 * 60 * 24)) : null;\n    \n    return {\n      client,\n      projects,\n      invoices,\n      metrics: {\n        totalInvoiced,\n        totalPaid,\n        totalUnpaid,\n        invoiceCount: invoices.length,\n        paidInvoiceCount: paidInvoices.length,\n        unpaidInvoiceCount: unpaidInvoices.length,\n        projectCount: projects.length,\n        activeProjectCount: activeProjects.length,\n        completedProjectCount: completedProjects.length,\n        leadProjectCount: leadProjects.length,\n        daysSinceLastInvoice,\n        daysSinceLastProject\n      },\n      engagement: {\n        level: calculateEngagementLevel(daysSinceLastInvoice, daysSinceLastProject, totalPaid),\n        lastActivity: getLastActivity(lastInvoice, lastProject)\n      }\n    };\n  }\n  \n  /**\n   * Calculate client engagement level\n   */\n  function calculateEngagementLevel(daysSinceInvoice, daysSinceProject, totalPaid) {\n    if (totalPaid > 10000 && (daysSinceInvoice < 30 || daysSinceProject < 30)) {\n      return 'high';\n    }\n    if (totalPaid > 1000 && (daysSinceInvoice < 90 || daysSinceProject < 90)) {\n      return 'medium';\n    }\n    if (daysSinceInvoice > 180 && daysSinceProject > 180) {\n      return 'low';\n    }\n    return 'medium';\n  }\n  \n  /**\n   * Get last activity description\n   */\n  function getLastActivity(lastInvoice, lastProject) {\n    const invoiceDate = lastInvoice ? new Date(lastInvoice.created_at) : null;\n    const projectDate = lastProject ? new Date(lastProject.created_at) : null;\n    \n    if (!invoiceDate && !projectDate) {\n      return 'No recent activity';\n    }\n    \n    if (!projectDate || (invoiceDate && invoiceDate > projectDate)) {\n      const days = Math.floor((Date.now() - invoiceDate.getTime()) / (1000 * 60 * 60 * 24));\n      return `Invoice \"${lastInvoice.label || 'Untitled'}\" ${days === 0 ? 'today' : days === 1 ? 'yesterday' : `${days} days ago`}`;\n    } else {\n      const days = Math.floor((Date.now() - projectDate.getTime()) / (1000 * 60 * 60 * 24));\n      return `Project \"${lastProject.name || 'Untitled'}\" ${days === 0 ? 'today' : days === 1 ? 'yesterday' : `${days} days ago`}`;\n    }\n  }\n  \n  /**\n   * Create or update relationships when creating/editing records\n   */\n  function updateClientRelationships(clientId, projectIds = [], invoiceIds = []) {\n    const store = window.ubaStore;\n    if (!store) return;\n    \n    // Update projects to reference client\n    if (store.projects && projectIds.length > 0) {\n      projectIds.forEach(projectId => {\n        const project = store.projects.getAll().find(p => p.id === projectId);\n        if (project && !project.client_id) {\n          store.projects.update(projectId, { ...project, client_id: clientId });\n        }\n      });\n    }\n    \n    // Update invoices to reference client\n    if (store.invoices && invoiceIds.length > 0) {\n      invoiceIds.forEach(invoiceId => {\n        const invoice = store.invoices.getAll().find(i => i.id === invoiceId);\n        if (invoice && !invoice.client_id) {\n          store.invoices.update(invoiceId, { ...invoice, client_id: clientId });\n        }\n      });\n    }\n  }\n  \n  /**\n   * Find orphaned projects and invoices (not linked to any client)\n   */\n  function findOrphanedRecords() {\n    const store = window.ubaStore;\n    if (!store) return { projects: [], invoices: [] };\n    \n    const clients = store.clients ? store.clients.getAll() : [];\n    const clientNames = clients.map(c => c.name.toLowerCase());\n    const clientIds = clients.map(c => c.id);\n    \n    const orphanedProjects = [];\n    const orphanedInvoices = [];\n    \n    // Find projects without client linkage\n    if (store.projects) {\n      const projects = store.projects.getAll();\n      projects.forEach(project => {\n        const hasClientId = project.client_id && clientIds.includes(project.client_id);\n        const hasClientName = project.client && clientNames.includes(project.client.toLowerCase());\n        \n        if (!hasClientId && !hasClientName) {\n          orphanedProjects.push(project);\n        }\n      });\n    }\n    \n    // Find invoices without client linkage\n    if (store.invoices) {\n      const invoices = store.invoices.getAll();\n      invoices.forEach(invoice => {\n        const hasClientId = invoice.client_id && clientIds.includes(invoice.client_id);\n        const hasClientName = invoice.client && clientNames.includes(invoice.client.toLowerCase());\n        \n        if (!hasClientId && !hasClientName) {\n          orphanedInvoices.push(invoice);\n        }\n      });\n    }\n    \n    return {\n      projects: orphanedProjects,\n      invoices: orphanedInvoices\n    };\n  }\n  \n  /**\n   * Suggest client matches for orphaned records\n   */\n  function suggestClientMatches(orphanedRecord, recordType) {\n    const store = window.ubaStore;\n    if (!store || !store.clients) return [];\n    \n    const clients = store.clients.getAll();\n    const suggestions = [];\n    \n    const recordText = (\n      orphanedRecord.name || \n      orphanedRecord.label || \n      orphanedRecord.client || \n      orphanedRecord.description || \n      ''\n    ).toLowerCase();\n    \n    clients.forEach(client => {\n      let score = 0;\n      const clientName = client.name.toLowerCase();\n      const clientCompany = (client.company || '').toLowerCase();\n      \n      // Exact name match\n      if (recordText.includes(clientName)) {\n        score += 10;\n      }\n      \n      // Exact company match\n      if (clientCompany && recordText.includes(clientCompany)) {\n        score += 8;\n      }\n      \n      // Partial name match\n      const nameWords = clientName.split(' ');\n      nameWords.forEach(word => {\n        if (word.length > 2 && recordText.includes(word)) {\n          score += 3;\n        }\n      });\n      \n      // Email domain match (for invoices)\n      if (recordType === 'invoice' && orphanedRecord.client && client.email) {\n        const recordDomain = orphanedRecord.client.split('@')[1];\n        const clientDomain = client.email.split('@')[1];\n        if (recordDomain && clientDomain && recordDomain === clientDomain) {\n          score += 7;\n        }\n      }\n      \n      if (score > 0) {\n        suggestions.push({\n          client,\n          score,\n          confidence: score > 8 ? 'high' : score > 5 ? 'medium' : 'low'\n        });\n      }\n    });\n    \n    return suggestions.sort((a, b) => b.score - a.score).slice(0, 3);\n  }\n  \n  /**\n   * Auto-link records to clients based on suggestions\n   */\n  function autoLinkRecords(threshold = 8) {\n    const orphaned = findOrphanedRecords();\n    const linked = {\n      projects: 0,\n      invoices: 0,\n      suggestions: []\n    };\n    \n    const store = window.ubaStore;\n    if (!store) return linked;\n    \n    // Auto-link high-confidence projects\n    orphaned.projects.forEach(project => {\n      const suggestions = suggestClientMatches(project, 'project');\n      if (suggestions.length > 0 && suggestions[0].score >= threshold) {\n        const client = suggestions[0].client;\n        if (store.projects) {\n          store.projects.update(project.id, { ...project, client_id: client.id, client: client.name });\n          linked.projects++;\n        }\n      } else if (suggestions.length > 0) {\n        linked.suggestions.push({\n          type: 'project',\n          record: project,\n          suggestions: suggestions\n        });\n      }\n    });\n    \n    // Auto-link high-confidence invoices\n    orphaned.invoices.forEach(invoice => {\n      const suggestions = suggestClientMatches(invoice, 'invoice');\n      if (suggestions.length > 0 && suggestions[0].score >= threshold) {\n        const client = suggestions[0].client;\n        if (store.invoices) {\n          store.invoices.update(invoice.id, { ...invoice, client_id: client.id, client: client.name });\n          linked.invoices++;\n        }\n      } else if (suggestions.length > 0) {\n        linked.suggestions.push({\n          type: 'invoice',\n          record: invoice,\n          suggestions: suggestions\n        });\n      }\n    });\n    \n    return linked;\n  }\n  \n  /**\n   * Format currency for display\n   */\n  function formatCurrency(amount) {\n    return new Intl.NumberFormat('en-US', {\n      style: 'currency',\n      currency: 'EUR',\n      minimumFractionDigits: 0,\n      maximumFractionDigits: 0\n    }).format(amount || 0);\n  }\n  \n  /**\n   * Show client details with relationships\n   */\n  function showClientDetails(clientId) {\n    const summary = getClientSummary(clientId);\n    if (!summary) return;\n    \n    const modal = document.getElementById('client-details-modal');\n    const title = document.getElementById('client-details-title');\n    const basicInfo = document.getElementById('client-basic-info');\n    const customInfo = document.getElementById('client-custom-info');\n    const relationships = document.getElementById('client-relationships');\n    const relatedProjects = document.getElementById('related-projects');\n    const relatedInvoices = document.getElementById('related-invoices');\n    \n    if (!modal) return;\n    \n    // Set title\n    if (title) {\n      title.textContent = summary.client.name;\n    }\n    \n    // Basic info\n    if (basicInfo) {\n      basicInfo.innerHTML = `\n        <h4>Contact Information</h4>\n        <div class=\"uba-client-info-grid\">\n          <div><strong>Email:</strong> ${summary.client.email || 'Not provided'}</div>\n          <div><strong>Phone:</strong> ${summary.client.phone || 'Not provided'}</div>\n          <div><strong>Company:</strong> ${summary.client.company || 'Not provided'}</div>\n          <div><strong>Notes:</strong> ${summary.client.notes || 'No notes'}</div>\n        </div>\n        <div class=\"uba-client-metrics\">\n          <div class=\"uba-metric\">\n            <span class=\"uba-metric-label\">Total Revenue:</span>\n            <span class=\"uba-metric-value\">${formatCurrency(summary.metrics.totalPaid)}</span>\n          </div>\n          <div class=\"uba-metric\">\n            <span class=\"uba-metric-label\">Unpaid Amount:</span>\n            <span class=\"uba-metric-value\">${formatCurrency(summary.metrics.totalUnpaid)}</span>\n          </div>\n          <div class=\"uba-metric\">\n            <span class=\"uba-metric-label\">Engagement:</span>\n            <span class=\"uba-metric-value uba-engagement-${summary.engagement.level}\">${summary.engagement.level}</span>\n          </div>\n        </div>\n      `;\n    }\n    \n    // Related projects\n    if (relatedProjects) {\n      if (summary.projects.length === 0) {\n        relatedProjects.innerHTML = '<p class=\"uba-empty-state\">No related projects found</p>';\n      } else {\n        relatedProjects.innerHTML = summary.projects.map(project => `\n          <div class=\"uba-related-item\">\n            <div>\n              <strong>${project.name || 'Untitled Project'}</strong>\n              <br><small>Stage: ${project.stage || project.status || 'Unknown'}</small>\n            </div>\n            <div class=\"uba-item-actions\">\n              <button class=\"uba-btn-sm uba-btn-ghost\" onclick=\"viewProject('${project.id}')\">View</button>\n            </div>\n          </div>\n        `).join('');\n      }\n    }\n    \n    // Related invoices\n    if (relatedInvoices) {\n      if (summary.invoices.length === 0) {\n        relatedInvoices.innerHTML = '<p class=\"uba-empty-state\">No related invoices found</p>';\n      } else {\n        relatedInvoices.innerHTML = summary.invoices.map(invoice => `\n          <div class=\"uba-related-item\">\n            <div>\n              <strong>${invoice.label || 'Invoice'} - ${formatCurrency(invoice.amount)}</strong>\n              <br><small>Status: <span class=\"uba-status uba-status-${invoice.status}\">${invoice.status}</span></small>\n            </div>\n            <div class=\"uba-item-actions\">\n              <button class=\"uba-btn-sm uba-btn-ghost\" onclick=\"viewInvoice('${invoice.id}')\">View</button>\n            </div>\n          </div>\n        `).join('');\n      }\n    }\n    \n    // Show modal\n    modal.style.display = 'block';\n  }\n  \n  // Expose client relationships API\n  window.UBAClientRelationships = {\n    getClientProjects,\n    getClientInvoices,\n    getClientSummary,\n    updateClientRelationships,\n    findOrphanedRecords,\n    suggestClientMatches,\n    autoLinkRecords,\n    showClientDetails\n  };\n  \n  console.log('✓ Client Relationships module loaded');\n  \n})();