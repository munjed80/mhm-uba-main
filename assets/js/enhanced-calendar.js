// enhanced-calendar.js - Enhanced Calendar with Event Modal, Drag & Drop, Task Sync, and Sidebar Fix
(function() {
  'use strict';
  
  /**
   * Enhanced Calendar System
   * Features: Event creation modal, Drag & Drop, Task synchronization, Sidebar fixes
   */
  window.UBAEnhancedCalendar = {
    
    // State management
    currentDate: new Date(),
    currentFilter: 'all',
    events: [],
    tasks: [],
    draggedEvent: null,
    
    /**
     * Initialize enhanced calendar system
     */
    init() {
      console.log('ğŸ“… Initializing Enhanced Calendar System');
      
      this.setupEventCreationModal();
      this.setupDragAndDrop();
      this.setupTaskSync();
      this.fixSidebarIssues();
      this.enhanceCalendarInterface();
      this.loadCalendarData();
      
      console.log('âœ… Enhanced Calendar System initialized');
    },
    
    /**
     * Setup event creation modal
     */
    setupEventCreationModal() {
      console.log('ğŸ—‚ï¸ Setting up event creation modal');
      
      this.createEventModal();
      this.addEventCreationButton();
      this.setupDateClickHandlers();
    },
    
    /**\n     * Create event creation modal\n     */\n    createEventModal() {\n      // Remove existing modal if present\n      const existingModal = document.getElementById('event-creation-modal');\n      if (existingModal) {\n        existingModal.remove();\n      }\n      \n      const modal = document.createElement('div');\n      modal.id = 'event-creation-modal';\n      modal.className = 'uba-modal event-modal';\n      modal.innerHTML = `\n        <div class=\"uba-modal-overlay\" onclick=\"window.UBAEnhancedCalendar.closeEventModal()\"></div>\n        <div class=\"uba-modal-dialog event-dialog\">\n          <div class=\"uba-modal-header\">\n            <h3><span class=\"icon\">ğŸ“…</span> Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø¯Ø« Ø¬Ø¯ÙŠØ¯ (Create New Event)</h3>\n            <button class=\"uba-modal-close\" onclick=\"window.UBAEnhancedCalendar.closeEventModal()\">Ã—</button>\n          </div>\n          <div class=\"uba-modal-body event-form-body\">\n            <form id=\"event-creation-form\" class=\"event-form\">\n              <input type=\"hidden\" id=\"event-edit-id\" />\n              <input type=\"hidden\" id=\"event-selected-date\" />\n              \n              <!-- Event Type Selection -->\n              <div class=\"form-group\">\n                <label for=\"event-type\">Event Type *</label>\n                <select id=\"event-type\" class=\"uba-select enhanced-dropdown\" required onchange=\"window.UBAEnhancedCalendar.onEventTypeChange()\">\n                  <option value=\"\">Select event type</option>\n                  <option value=\"meeting\">ğŸ“‹ Meeting</option>\n                  <option value=\"deadline\">â° Deadline</option>\n                  <option value=\"reminder\">ğŸ”” Reminder</option>\n                  <option value=\"task\">âœ… Task</option>\n                  <option value=\"appointment\">ğŸ‘¥ Appointment</option>\n                  <option value=\"call\">ğŸ“ Call</option>\n                  <option value=\"follow-up\">ğŸ“§ Follow-up</option>\n                  <option value=\"other\">ğŸ“Œ Other</option>\n                </select>\n              </div>\n              \n              <!-- Basic Event Information -->\n              <div class=\"form-grid\">\n                <div class=\"form-group\">\n                  <label for=\"event-title\">Title *</label>\n                  <input type=\"text\" id=\"event-title\" class=\"uba-input\" placeholder=\"Event title\" required />\n                </div>\n                \n                <div class=\"form-group\">\n                  <label for=\"event-date\">Date *</label>\n                  <input type=\"date\" id=\"event-date\" class=\"uba-input\" required />\n                </div>\n              </div>\n              \n              <!-- Time Information -->\n              <div class=\"form-grid\">\n                <div class=\"form-group\">\n                  <label for=\"event-start-time\">Start Time</label>\n                  <input type=\"time\" id=\"event-start-time\" class=\"uba-input\" />\n                </div>\n                \n                <div class=\"form-group\">\n                  <label for=\"event-end-time\">End Time</label>\n                  <input type=\"time\" id=\"event-end-time\" class=\"uba-input\" />\n                </div>\n              </div>\n              \n              <!-- Description -->\n              <div class=\"form-group\">\n                <label for=\"event-description\">Description</label>\n                <textarea id=\"event-description\" class=\"uba-textarea\" rows=\"3\" placeholder=\"Event details and notes\"></textarea>\n              </div>\n              \n              <!-- Additional Options -->\n              <div class=\"form-grid\">\n                <div class=\"form-group\">\n                  <label for=\"event-priority\">Priority</label>\n                  <select id=\"event-priority\" class=\"uba-select enhanced-dropdown\">\n                    <option value=\"low\">ğŸŸ¢ Low</option>\n                    <option value=\"medium\" selected>ğŸŸ¡ Medium</option>\n                    <option value=\"high\">ğŸ”´ High</option>\n                  </select>\n                </div>\n                \n                <div class=\"form-group\">\n                  <label for=\"event-category\">Category</label>\n                  <select id=\"event-category\" class=\"uba-select enhanced-dropdown\">\n                    <option value=\"\">No category</option>\n                    <option value=\"work\">ğŸ’¼ Work</option>\n                    <option value=\"personal\">ğŸ‘¤ Personal</option>\n                    <option value=\"client\">ğŸ§‘â€ğŸ’» Client</option>\n                    <option value=\"project\">ğŸ“Š Project</option>\n                    <option value=\"admin\">âš™ï¸ Admin</option>\n                  </select>\n                </div>\n              </div>\n              \n              <!-- Reminders -->\n              <div class=\"form-group\">\n                <label>Reminders (Ø§Ù„ØªØ°ÙƒÙŠØ±Ø§Øª)</label>\n                <div class=\"reminder-options\">\n                  <label class=\"checkbox-label\">\n                    <input type=\"checkbox\" id=\"reminder-15min\" />\n                    <span class=\"checkmark\"></span>\n                    15 minutes before\n                  </label>\n                  <label class=\"checkbox-label\">\n                    <input type=\"checkbox\" id=\"reminder-1hour\" />\n                    <span class=\"checkmark\"></span>\n                    1 hour before\n                  </label>\n                  <label class=\"checkbox-label\">\n                    <input type=\"checkbox\" id=\"reminder-1day\" />\n                    <span class=\"checkmark\"></span>\n                    1 day before\n                  </label>\n                </div>\n              </div>\n              \n              <!-- Task Integration (shown when type is task) -->\n              <div id=\"task-integration-section\" class=\"form-group\" style=\"display: none;\">\n                <label>Link to Existing Task</label>\n                <select id=\"linked-task\" class=\"uba-select enhanced-dropdown\">\n                  <option value=\"\">Create new task</option>\n                  <!-- Existing tasks will be populated here -->\n                </select>\n              </div>\n              \n              <!-- Project Integration -->\n              <div class=\"form-group\">\n                <label for=\"event-project\">Related Project</label>\n                <select id=\"event-project\" class=\"uba-select enhanced-dropdown\">\n                  <option value=\"\">No project</option>\n                  <!-- Projects will be populated here -->\n                </select>\n              </div>\n            </form>\n          </div>\n          <div class=\"uba-modal-footer\">\n            <button type=\"button\" class=\"uba-btn uba-btn-ghost\" onclick=\"window.UBAEnhancedCalendar.closeEventModal()\">Cancel</button>\n            <button type=\"button\" class=\"uba-btn uba-btn-danger\" id=\"delete-event-btn\" onclick=\"window.UBAEnhancedCalendar.deleteEvent()\" style=\"display: none;\">Delete Event</button>\n            <button type=\"submit\" form=\"event-creation-form\" class=\"uba-btn uba-btn-primary\">Save Event</button>\n          </div>\n        </div>\n      `;\n      \n      document.body.appendChild(modal);\n      \n      // Setup form submission\n      const form = document.getElementById('event-creation-form');\n      form.addEventListener('submit', (e) => {\n        e.preventDefault();\n        this.saveEvent();\n      });\n      \n      // Populate dropdowns\n      this.populateProjectDropdown();\n      this.populateTaskDropdown();\n    },\n    \n    /**\n     * Handle event type change\n     */\n    onEventTypeChange() {\n      const eventType = document.getElementById('event-type').value;\n      const taskSection = document.getElementById('task-integration-section');\n      \n      if (eventType === 'task') {\n        taskSection.style.display = 'block';\n      } else {\n        taskSection.style.display = 'none';\n      }\n    },\n    \n    /**\n     * Add event creation button\n     */\n    addEventCreationButton() {\n      const calendarHeader = document.querySelector('.uba-card-header');\n      if (!calendarHeader) return;\n      \n      const buttonContainer = calendarHeader.querySelector('div:last-child');\n      if (buttonContainer) {\n        const createEventBtn = document.createElement('button');\n        createEventBtn.className = 'uba-btn uba-btn-primary';\n        createEventBtn.innerHTML = '<span class=\"icon\">â•</span> New Event';\n        createEventBtn.onclick = () => this.openEventModal();\n        \n        buttonContainer.appendChild(createEventBtn);\n      }\n    },\n    \n    /**\n     * Setup date click handlers\n     */\n    setupDateClickHandlers() {\n      // Override calendar rendering to add click handlers\n      const originalRenderCalendar = window.renderCalendar;\n      \n      window.renderCalendar = () => {\n        if (originalRenderCalendar) {\n          originalRenderCalendar();\n        }\n        \n        // Add click handlers to calendar days\n        setTimeout(() => {\n          this.addCalendarDayClickHandlers();\n        }, 100);\n      };\n    },\n    \n    /**\n     * Add click handlers to calendar days\n     */\n    addCalendarDayClickHandlers() {\n      const calendarDays = document.querySelectorAll('.uba-calendar-day');\n      \n      calendarDays.forEach(dayElement => {\n        // Remove existing listeners\n        dayElement.removeEventListener('click', this.handleDayClick);\n        \n        // Add new listener\n        dayElement.addEventListener('click', (e) => this.handleDayClick(e));\n        \n        // Add double-click for quick event creation\n        dayElement.addEventListener('dblclick', (e) => this.handleDayDoubleClick(e));\n      });\n    },\n    \n    /**\n     * Handle day click\n     */\n    handleDayClick(e) {\n      const dayElement = e.currentTarget;\n      const dayNumber = dayElement.querySelector('.day-number')?.textContent;\n      \n      if (dayNumber && !dayElement.classList.contains('other-month')) {\n        const selectedDate = this.getDateFromDayElement(dayElement);\n        console.log('Day clicked:', selectedDate);\n        \n        // Highlight selected day\n        document.querySelectorAll('.uba-calendar-day').forEach(day => {\n          day.classList.remove('selected');\n        });\n        dayElement.classList.add('selected');\n      }\n    },\n    \n    /**\n     * Handle day double-click\n     */\n    handleDayDoubleClick(e) {\n      const dayElement = e.currentTarget;\n      const selectedDate = this.getDateFromDayElement(dayElement);\n      \n      if (selectedDate) {\n        this.openEventModal(null, selectedDate);\n      }\n    },\n    \n    /**\n     * Get date from day element\n     */\n    getDateFromDayElement(dayElement) {\n      const dayNumber = dayElement.querySelector('.day-number')?.textContent;\n      if (!dayNumber) return null;\n      \n      const year = this.currentDate.getFullYear();\n      const month = this.currentDate.getMonth();\n      \n      // Handle previous/next month days\n      let targetMonth = month;\n      let targetYear = year;\n      \n      if (dayElement.classList.contains('other-month')) {\n        const dayNum = parseInt(dayNumber);\n        if (dayNum > 15) {\n          // Previous month\n          targetMonth = month === 0 ? 11 : month - 1;\n          if (month === 0) targetYear--;\n        } else {\n          // Next month\n          targetMonth = month === 11 ? 0 : month + 1;\n          if (month === 11) targetYear++;\n        }\n      }\n      \n      return new Date(targetYear, targetMonth, parseInt(dayNumber)).toISOString().slice(0, 10);\n    },\n    \n    /**\n     * Open event modal\n     */\n    openEventModal(eventData = null, selectedDate = null) {\n      const modal = document.getElementById('event-creation-modal');\n      if (!modal) {\n        this.createEventModal();\n        return this.openEventModal(eventData, selectedDate);\n      }\n      \n      const form = document.getElementById('event-creation-form');\n      const deleteBtn = document.getElementById('delete-event-btn');\n      \n      // Reset form\n      form.reset();\n      document.getElementById('event-edit-id').value = '';\n      \n      if (eventData) {\n        // Edit mode\n        this.populateEventForm(eventData);\n        deleteBtn.style.display = 'block';\n      } else {\n        // Create mode\n        deleteBtn.style.display = 'none';\n        \n        // Pre-fill date if provided\n        if (selectedDate) {\n          document.getElementById('event-date').value = selectedDate;\n          document.getElementById('event-selected-date').value = selectedDate;\n        } else {\n          const today = new Date().toISOString().slice(0, 10);\n          document.getElementById('event-date').value = today;\n        }\n      }\n      \n      modal.classList.add('is-visible');\n      document.body.style.overflow = 'hidden';\n      \n      // Focus on title field\n      setTimeout(() => {\n        document.getElementById('event-title')?.focus();\n      }, 100);\n    },\n    \n    /**\n     * Close event modal\n     */\n    closeEventModal() {\n      const modal = document.getElementById('event-creation-modal');\n      if (modal) {\n        modal.classList.remove('is-visible');\n        document.body.style.overflow = '';\n      }\n    },\n    \n    /**\n     * Save event\n     */\n    saveEvent() {\n      const eventData = this.getEventFormData();\n      \n      // Validate required fields\n      if (!eventData.title || !eventData.date || !eventData.type) {\n        this.showNotification('Please fill in all required fields', 'error');\n        return;\n      }\n      \n      const editId = document.getElementById('event-edit-id').value;\n      \n      if (editId) {\n        // Update existing event\n        this.updateEvent(editId, eventData);\n      } else {\n        // Create new event\n        this.createEvent(eventData);\n      }\n      \n      // Close modal and refresh calendar\n      this.closeEventModal();\n      this.refreshCalendar();\n    },\n    \n    /**\n     * Get event form data\n     */\n    getEventFormData() {\n      return {\n        type: document.getElementById('event-type').value,\n        title: document.getElementById('event-title').value.trim(),\n        date: document.getElementById('event-date').value,\n        startTime: document.getElementById('event-start-time').value,\n        endTime: document.getElementById('event-end-time').value,\n        description: document.getElementById('event-description').value.trim(),\n        priority: document.getElementById('event-priority').value,\n        category: document.getElementById('event-category').value,\n        projectId: document.getElementById('event-project').value,\n        linkedTaskId: document.getElementById('linked-task').value,\n        reminders: {\n          fifteenMin: document.getElementById('reminder-15min').checked,\n          oneHour: document.getElementById('reminder-1hour').checked,\n          oneDay: document.getElementById('reminder-1day').checked\n        }\n      };\n    },\n    \n    /**\n     * Create new event\n     */\n    createEvent(eventData) {\n      const event = {\n        id: 'event-' + Date.now(),\n        ...eventData,\n        createdAt: new Date().toISOString(),\n        updatedAt: new Date().toISOString()\n      };\n      \n      // Save to localStorage\n      this.saveEventToStorage(event);\n      \n      // If it's a task event, create or link task\n      if (event.type === 'task') {\n        this.handleTaskIntegration(event);\n      }\n      \n      this.showNotification(`Event \"${event.title}\" created successfully`, 'success');\n    },\n    \n    /**\n     * Save event to storage\n     */\n    saveEventToStorage(event) {\n      const events = this.getStoredEvents();\n      const existingIndex = events.findIndex(e => e.id === event.id);\n      \n      if (existingIndex !== -1) {\n        events[existingIndex] = event;\n      } else {\n        events.push(event);\n      }\n      \n      localStorage.setItem('uba-calendar-events', JSON.stringify(events));\n    },\n    \n    /**\n     * Get stored events\n     */\n    getStoredEvents() {\n      try {\n        return JSON.parse(localStorage.getItem('uba-calendar-events') || '[]');\n      } catch (error) {\n        console.warn('Failed to load stored events:', error);\n        return [];\n      }\n    },\n    \n    /**\n     * Setup drag and drop functionality\n     */\n    setupDragAndDrop() {\n      console.log('ğŸ–±ï¸ Setting up drag & drop functionality');\n      \n      // Override calendar rendering to add drag handlers\n      const originalCollectEvents = window.collectCalendarEvents;\n      \n      window.collectCalendarEvents = () => {\n        let events = [];\n        \n        if (originalCollectEvents) {\n          events = originalCollectEvents();\n        }\n        \n        // Add our custom events\n        const customEvents = this.getStoredEvents().map(event => ({\n          id: event.id,\n          date: event.date,\n          type: 'event',\n          title: event.title,\n          description: event.description,\n          priority: event.priority,\n          category: event.category,\n          startTime: event.startTime,\n          endTime: event.endTime\n        }));\n        \n        return [...events, ...customEvents];\n      };\n      \n      // Add drag handlers after calendar render\n      setTimeout(() => {\n        this.addDragHandlers();\n      }, 500);\n    },\n    \n    /**\n     * Add drag handlers to calendar events\n     */\n    addDragHandlers() {\n      const calendarGrid = document.getElementById('calendar-grid');\n      if (!calendarGrid) return;\n      \n      // Make events draggable\n      const eventElements = calendarGrid.querySelectorAll('.calendar-event');\n      eventElements.forEach(eventEl => {\n        eventEl.draggable = true;\n        eventEl.addEventListener('dragstart', (e) => this.handleDragStart(e));\n        eventEl.addEventListener('dragend', (e) => this.handleDragEnd(e));\n      });\n      \n      // Make calendar days droppable\n      const dayElements = calendarGrid.querySelectorAll('.uba-calendar-day');\n      dayElements.forEach(dayEl => {\n        dayEl.addEventListener('dragover', (e) => this.handleDragOver(e));\n        dayEl.addEventListener('drop', (e) => this.handleDrop(e));\n        dayEl.addEventListener('dragenter', (e) => this.handleDragEnter(e));\n        dayEl.addEventListener('dragleave', (e) => this.handleDragLeave(e));\n      });\n    },\n    \n    /**\n     * Handle drag start\n     */\n    handleDragStart(e) {\n      const eventElement = e.target.closest('.calendar-event');\n      if (!eventElement) return;\n      \n      const eventId = eventElement.dataset.eventId || eventElement.dataset.id;\n      const eventType = eventElement.dataset.type || 'event';\n      \n      this.draggedEvent = {\n        id: eventId,\n        type: eventType,\n        element: eventElement\n      };\n      \n      eventElement.classList.add('dragging');\n      e.dataTransfer.effectAllowed = 'move';\n      e.dataTransfer.setData('text/plain', eventId);\n    },\n    \n    /**\n     * Handle drag end\n     */\n    handleDragEnd(e) {\n      if (this.draggedEvent?.element) {\n        this.draggedEvent.element.classList.remove('dragging');\n      }\n      \n      // Remove drop indicators\n      document.querySelectorAll('.uba-calendar-day').forEach(day => {\n        day.classList.remove('drag-over');\n      });\n      \n      this.draggedEvent = null;\n    },\n    \n    /**\n     * Handle drag over\n     */\n    handleDragOver(e) {\n      e.preventDefault();\n      e.dataTransfer.dropEffect = 'move';\n    },\n    \n    /**\n     * Handle drag enter\n     */\n    handleDragEnter(e) {\n      e.preventDefault();\n      const dayElement = e.currentTarget;\n      dayElement.classList.add('drag-over');\n    },\n    \n    /**\n     * Handle drag leave\n     */\n    handleDragLeave(e) {\n      const dayElement = e.currentTarget;\n      // Only remove if we're truly leaving the day\n      if (!dayElement.contains(e.relatedTarget)) {\n        dayElement.classList.remove('drag-over');\n      }\n    },\n    \n    /**\n     * Handle drop\n     */\n    handleDrop(e) {\n      e.preventDefault();\n      \n      const dayElement = e.currentTarget;\n      dayElement.classList.remove('drag-over');\n      \n      if (!this.draggedEvent) return;\n      \n      const newDate = this.getDateFromDayElement(dayElement);\n      if (!newDate) return;\n      \n      // Update event date\n      this.moveEvent(this.draggedEvent.id, this.draggedEvent.type, newDate);\n    },\n    \n    /**\n     * Move event to new date\n     */\n    moveEvent(eventId, eventType, newDate) {\n      if (eventType === 'event') {\n        // Move custom calendar event\n        const events = this.getStoredEvents();\n        const event = events.find(e => e.id === eventId);\n        \n        if (event) {\n          const oldDate = event.date;\n          event.date = newDate;\n          event.updatedAt = new Date().toISOString();\n          \n          this.saveEventToStorage(event);\n          this.showNotification(`Event moved from ${oldDate} to ${newDate}`, 'success');\n          \n          // Refresh calendar\n          this.refreshCalendar();\n        }\n      } else if (eventType === 'task') {\n        // Move task due date\n        this.moveTaskDate(eventId.replace('task-', ''), newDate);\n      } else if (eventType === 'invoice') {\n        // Move invoice due date\n        this.moveInvoiceDate(eventId.replace('invoice-', ''), newDate);\n      } else if (eventType === 'project') {\n        // Move project deadline\n        this.moveProjectDate(eventId.replace('project-', ''), newDate);\n      }\n    },\n    \n    /**\n     * Move task due date\n     */\n    moveTaskDate(taskId, newDate) {\n      if (window.ubaStore?.tasks) {\n        const task = window.ubaStore.tasks.getById(taskId);\n        if (task) {\n          task.due = newDate;\n          window.ubaStore.tasks.update(taskId, task);\n          this.showNotification(`Task due date updated to ${newDate}`, 'success');\n          this.refreshCalendar();\n        }\n      }\n    },\n    \n    /**\n     * Setup task synchronization\n     */\n    setupTaskSync() {\n      console.log('ğŸ”„ Setting up task synchronization');\n      \n      // Override task operations to sync with calendar\n      this.setupTaskEventSync();\n      \n      // Set up periodic sync\n      setInterval(() => {\n        this.syncTasksWithCalendar();\n      }, 30000); // Sync every 30 seconds\n    },\n    \n    /**\n     * Setup task event synchronization\n     */\n    setupTaskEventSync() {\n      // Monitor task store changes if available\n      if (window.ubaStore?.tasks) {\n        const originalCreate = window.ubaStore.tasks.create;\n        const originalUpdate = window.ubaStore.tasks.update;\n        const originalDelete = window.ubaStore.tasks.delete;\n        \n        // Override create\n        window.ubaStore.tasks.create = (taskData) => {\n          const result = originalCreate.call(window.ubaStore.tasks, taskData);\n          if (taskData.due) {\n            this.createEventFromTask(taskData);\n          }\n          return result;\n        };\n        \n        // Override update\n        window.ubaStore.tasks.update = (taskId, taskData) => {\n          const result = originalUpdate.call(window.ubaStore.tasks, taskId, taskData);\n          this.updateEventFromTask(taskId, taskData);\n          return result;\n        };\n        \n        // Override delete\n        window.ubaStore.tasks.delete = (taskId) => {\n          this.deleteEventFromTask(taskId);\n          return originalDelete.call(window.ubaStore.tasks, taskId);\n        };\n      }\n    },\n    \n    /**\n     * Create calendar event from task\n     */\n    createEventFromTask(task) {\n      if (!task.due) return;\n      \n      const event = {\n        id: 'task-event-' + task.id,\n        type: 'task',\n        title: `ğŸ“‹ ${task.title || 'Task'}`,\n        date: task.due.split('T')[0],\n        description: task.description || '',\n        priority: task.priority || 'medium',\n        category: 'work',\n        linkedTaskId: task.id,\n        createdAt: new Date().toISOString()\n      };\n      \n      this.saveEventToStorage(event);\n    },\n    \n    /**\n     * Update calendar event from task\n     */\n    updateEventFromTask(taskId, taskData) {\n      const events = this.getStoredEvents();\n      const eventIndex = events.findIndex(e => e.linkedTaskId === taskId);\n      \n      if (eventIndex !== -1) {\n        if (taskData.due) {\n          // Update existing event\n          events[eventIndex].title = `ğŸ“‹ ${taskData.title || 'Task'}`;\n          events[eventIndex].date = taskData.due.split('T')[0];\n          events[eventIndex].description = taskData.description || '';\n          events[eventIndex].priority = taskData.priority || 'medium';\n          events[eventIndex].updatedAt = new Date().toISOString();\n        } else {\n          // Remove event if no due date\n          events.splice(eventIndex, 1);\n        }\n      } else if (taskData.due) {\n        // Create new event\n        this.createEventFromTask({ id: taskId, ...taskData });\n        return;\n      }\n      \n      localStorage.setItem('uba-calendar-events', JSON.stringify(events));\n    },\n    \n    /**\n     * Delete calendar event from task\n     */\n    deleteEventFromTask(taskId) {\n      const events = this.getStoredEvents();\n      const filteredEvents = events.filter(e => e.linkedTaskId !== taskId);\n      localStorage.setItem('uba-calendar-events', JSON.stringify(filteredEvents));\n    },\n    \n    /**\n     * Handle task integration when creating events\n     */\n    handleTaskIntegration(event) {\n      if (event.linkedTaskId) {\n        // Link to existing task\n        if (window.ubaStore?.tasks) {\n          const task = window.ubaStore.tasks.getById(event.linkedTaskId);\n          if (task) {\n            task.due = event.date;\n            if (event.startTime) {\n              task.due += 'T' + event.startTime;\n            }\n            window.ubaStore.tasks.update(event.linkedTaskId, task);\n          }\n        }\n      } else if (event.type === 'task') {\n        // Create new task\n        const taskData = {\n          id: 'task-' + Date.now(),\n          title: event.title.replace('ğŸ“‹ ', ''),\n          description: event.description,\n          due: event.startTime ? `${event.date}T${event.startTime}` : event.date,\n          priority: event.priority,\n          status: 'todo',\n          createdAt: new Date().toISOString()\n        };\n        \n        if (window.ubaStore?.tasks) {\n          window.ubaStore.tasks.create(taskData);\n        }\n        \n        // Update event with linked task ID\n        event.linkedTaskId = taskData.id;\n        this.saveEventToStorage(event);\n      }\n    },\n    \n    /**\n     * Fix sidebar issues\n     */\n    fixSidebarIssues() {\n      console.log('ğŸ”§ Fixing sidebar issues');\n      \n      this.fixSidebarVisibility();\n      this.fixNavigationState();\n      this.setupSidebarEventListeners();\n    },\n    \n    /**\n     * Fix sidebar visibility issues\n     */\n    fixSidebarVisibility() {\n      const sidebar = document.querySelector('.uba-sidebar');\n      if (!sidebar) return;\n      \n      // Ensure sidebar is visible\n      sidebar.style.display = 'flex';\n      sidebar.style.visibility = 'visible';\n      sidebar.style.opacity = '1';\n      \n      // Fix potential z-index issues\n      sidebar.style.zIndex = '100';\n      \n      // Ensure parent containers don't hide sidebar\n      const shell = document.querySelector('.uba-shell');\n      if (shell) {\n        shell.style.display = 'flex';\n      }\n    },\n    \n    /**\n     * Fix navigation state management\n     */\n    fixNavigationState() {\n      // Ensure proper active states\n      const navLinks = document.querySelectorAll('.uba-nav-btn');\n      \n      navLinks.forEach(link => {\n        link.addEventListener('click', (e) => {\n          // Prevent navigation from breaking sidebar\n          e.stopPropagation();\n          \n          // Update active state\n          navLinks.forEach(l => l.classList.remove('active'));\n          link.classList.add('active');\n        });\n      });\n      \n      // Set correct active state for calendar\n      const calendarLink = document.querySelector('a[href=\"calendar.html\"]');\n      if (calendarLink) {\n        navLinks.forEach(l => l.classList.remove('active'));\n        calendarLink.classList.add('active');\n      }\n    },\n    \n    /**\n     * Setup sidebar event listeners\n     */\n    setupSidebarEventListeners() {\n      // Prevent sidebar from disappearing on various events\n      document.addEventListener('click', (e) => {\n        // Don't hide sidebar on any clicks\n        e.stopPropagation();\n      });\n      \n      // Fix any layout shifts\n      window.addEventListener('resize', () => {\n        this.fixSidebarVisibility();\n      });\n      \n      // Ensure sidebar stays visible on page interactions\n      document.addEventListener('DOMContentLoaded', () => {\n        this.fixSidebarVisibility();\n      });\n    },\n    \n    /**\n     * Enhance calendar interface\n     */\n    enhanceCalendarInterface() {\n      console.log('ğŸ¨ Enhancing calendar interface');\n      \n      this.addCalendarControls();\n      this.enhanceEventDisplay();\n    },\n    \n    /**\n     * Load calendar data\n     */\n    loadCalendarData() {\n      // Load stored events\n      this.events = this.getStoredEvents();\n      \n      // Sync with tasks\n      this.syncTasksWithCalendar();\n      \n      // Refresh calendar display\n      setTimeout(() => {\n        this.refreshCalendar();\n      }, 1000);\n    },\n    \n    /**\n     * Sync tasks with calendar\n     */\n    syncTasksWithCalendar() {\n      if (!window.ubaStore?.tasks) return;\n      \n      const tasks = window.ubaStore.tasks.getAll() || [];\n      const events = this.getStoredEvents();\n      \n      tasks.forEach(task => {\n        if (task.due) {\n          const existingEvent = events.find(e => e.linkedTaskId === task.id);\n          if (!existingEvent) {\n            this.createEventFromTask(task);\n          }\n        }\n      });\n    },\n    \n    /**\n     * Refresh calendar display\n     */\n    refreshCalendar() {\n      if (window.renderCalendar) {\n        window.renderCalendar();\n        \n        // Re-add our enhancements after render\n        setTimeout(() => {\n          this.addCalendarDayClickHandlers();\n          this.addDragHandlers();\n        }, 100);\n      }\n    },\n    \n    /**\n     * Populate project dropdown\n     */\n    populateProjectDropdown() {\n      const projectSelect = document.getElementById('event-project');\n      if (!projectSelect) return;\n      \n      // Clear existing options (except first one)\n      projectSelect.innerHTML = '<option value=\"\">No project</option>';\n      \n      if (window.ubaStore?.projects) {\n        const projects = window.ubaStore.projects.getAll() || [];\n        projects.forEach(project => {\n          const option = document.createElement('option');\n          option.value = project.id;\n          option.textContent = project.name || project.title || 'Unnamed Project';\n          projectSelect.appendChild(option);\n        });\n      }\n    },\n    \n    /**\n     * Populate task dropdown\n     */\n    populateTaskDropdown() {\n      const taskSelect = document.getElementById('linked-task');\n      if (!taskSelect) return;\n      \n      // Clear existing options (except first one)\n      taskSelect.innerHTML = '<option value=\"\">Create new task</option>';\n      \n      if (window.ubaStore?.tasks) {\n        const tasks = window.ubaStore.tasks.getAll() || [];\n        tasks.forEach(task => {\n          const option = document.createElement('option');\n          option.value = task.id;\n          option.textContent = task.title || 'Unnamed Task';\n          taskSelect.appendChild(option);\n        });\n      }\n    },\n    \n    /**\n     * Show notification\n     */\n    showNotification(message, type = 'info', options = {}) {\n      if (window.showToast) {\n        window.showToast(message, type, options);\n      } else {\n        console.log(`${type.toUpperCase()}: ${message}`);\n      }\n    }\n  };\n  \n  // Auto-initialize when DOM is ready\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      setTimeout(() => window.UBAEnhancedCalendar.init(), 1000);\n    });\n  } else {\n    setTimeout(() => window.UBAEnhancedCalendar.init(), 1000);\n  }\n  \n  console.log('âœ… Enhanced Calendar module loaded');\n  \n})();