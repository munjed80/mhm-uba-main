// enhanced-leads.js - Advanced Lead Management System with Scoring, Contact Logs, and Project Integration
(function() {
  'use strict';
  
  /**
   * Enhanced Leads System - Advanced Lead Management
   * Features: Lead scoring (0-100), Contact logging, Project integration, Enhanced table views
   */
  window.UBAEnhancedLeads = {
    
    // State management
    leads: [],
    contactLogs: [],
    leadScoreConfig: {},
    projects: [],
    
    /**
     * Initialize enhanced leads system
     */
    init() {
      console.log('üß≤ Initializing Enhanced Leads System');
      
      this.loadLeadsData();
      this.setupLeadScoring();
      this.setupContactLogging();
      this.setupProjectIntegration();
      this.enhanceTableView();
      this.initializeUI();
      
      console.log('‚úÖ Enhanced Leads System initialized');
    },
    
    /**
     * Load leads data and enhance with scoring
     */
    loadLeadsData() {
      try {
        // Load existing leads
        this.leads = window.ubaStore?.leads?.getAll() || this.getDemoLeads();
        
        // Load contact logs
        const savedLogs = localStorage.getItem('uba-contact-logs');
        this.contactLogs = savedLogs ? JSON.parse(savedLogs) : [];
        
        // Load lead score configuration
        this.loadScoreConfiguration();
        
        console.log('‚úÖ Leads data loaded');
      } catch (error) {
        console.warn('‚ö†Ô∏è Failed to load leads data:', error);
        this.leads = this.getDemoLeads();
      }
    },
    
    /**
     * Setup lead scoring system
     */
    setupLeadScoring() {
      console.log('üéØ Setting up lead scoring system');
      
      // Add scoring section to leads page
      this.addScoringInterface();
      
      // Calculate scores for existing leads
      this.calculateAllLeadScores();
    },
    
    /**
     * Load score configuration
     */
    loadScoreConfiguration() {
      const saved = localStorage.getItem('uba-lead-score-config');
      this.leadScoreConfig = saved ? JSON.parse(saved) : this.getDefaultScoreConfig();
    },
    
    /**
     * Get default scoring configuration
     */
    getDefaultScoreConfig() {
      return {
        engagement: {
          weight: 25,
          criteria: {
            'initial_contact': 10,
            'responded_quickly': 15,
            'multiple_touchpoints': 20,
            'requested_demo': 25,
            'scheduled_meeting': 30
          }
        },
        company: {
          weight: 20,
          criteria: {
            'startup': 10,
            'small_business': 15,
            'medium_business': 20,
            'enterprise': 25,
            'fortune_500': 30
          }
        },
        budget: {
          weight: 25,
          criteria: {
            'under_1k': 5,
            '1k_5k': 10,
            '5k_15k': 15,
            '15k_50k': 20,
            'over_50k': 25
          }
        },
        timeline: {
          weight: 15,
          criteria: {
            'immediate': 25,
            'this_quarter': 20,
            'next_quarter': 15,
            'this_year': 10,
            'no_timeline': 5
          }
        },
        authority: {
          weight: 15,
          criteria: {
            'decision_maker': 25,
            'influencer': 20,
            'recommender': 15,
            'evaluator': 10,
            'end_user': 5
          }
        }
      };
    },
    
    /**
     * Add scoring interface to leads page
     */
    addScoringInterface() {
      const leadsPage = document.querySelector('#leads-page');\n      if (!leadsPage) return;\n      \n      // Add scoring overview section\n      const scoringOverview = document.createElement('div');\n      scoringOverview.className = 'scoring-overview';\n      scoringOverview.innerHTML = `\n        <div class=\"uba-card scoring-card\">\n          <div class=\"uba-card-header\">\n            <div>\n              <div class=\"uba-card-title\">üéØ Lead Scoring Overview</div>\n              <p class=\"uba-card-sub\">Intelligent lead prioritization system</p>\n            </div>\n            <div class=\"scoring-actions\">\n              <button class=\"uba-btn uba-btn-ghost\" onclick=\"window.UBAEnhancedLeads.openScoreConfig()\">Configure Scoring</button>\n              <button class=\"uba-btn uba-btn-primary\" onclick=\"window.UBAEnhancedLeads.recalculateAllScores()\">Recalculate All</button>\n            </div>\n          </div>\n          <div class=\"scoring-metrics\">\n            <div class=\"score-metric\">\n              <div class=\"score-value\" id=\"avg-lead-score\">0</div>\n              <div class=\"score-label\">Avg Score</div>\n            </div>\n            <div class=\"score-metric\">\n              <div class=\"score-value\" id=\"high-quality-leads\">0</div>\n              <div class=\"score-label\">High Quality (80+)</div>\n            </div>\n            <div class=\"score-metric\">\n              <div class=\"score-value\" id=\"medium-quality-leads\">0</div>\n              <div class=\"score-label\">Medium Quality (50-79)</div>\n            </div>\n            <div class=\"score-metric\">\n              <div class=\"score-value\" id=\"low-quality-leads\">0</div>\n              <div class=\"score-label\">Low Quality (<50)</div>\n            </div>\n          </div>\n        </div>\n      `;\n      \n      // Insert before the main leads table\n      const leadsTable = leadsPage.querySelector('.uba-card');\n      if (leadsTable) {\n        leadsPage.insertBefore(scoringOverview, leadsTable);\n      }\n      \n      // Create score configuration modal\n      this.createScoreConfigModal();\n    },\n    \n    /**\n     * Create score configuration modal\n     */\n    createScoreConfigModal() {\n      const modal = document.createElement('div');\n      modal.id = 'score-config-modal';\n      modal.className = 'uba-modal score-config-modal';\n      modal.innerHTML = `\n        <div class=\"uba-modal-overlay\" onclick=\"window.UBAEnhancedLeads.closeScoreConfig()\"></div>\n        <div class=\"uba-modal-dialog score-config-dialog\">\n          <div class=\"uba-modal-header\">\n            <h3>üéØ Lead Scoring Configuration</h3>\n            <button class=\"uba-modal-close\" onclick=\"window.UBAEnhancedLeads.closeScoreConfig()\">√ó</button>\n          </div>\n          <div class=\"uba-modal-body\">\n            <div class=\"scoring-categories\">\n              <!-- Dynamic scoring categories will be rendered here -->\n            </div>\n            <div class=\"scoring-preview\">\n              <h4>Preview Score Calculation</h4>\n              <div class=\"score-preview-content\">\n                <div class=\"preview-lead-score\">85</div>\n                <div class=\"preview-breakdown\">\n                  <!-- Score breakdown will be shown here -->\n                </div>\n              </div>\n            </div>\n          </div>\n          <div class=\"uba-modal-footer\">\n            <button class=\"uba-btn uba-btn-ghost\" onclick=\"window.UBAEnhancedLeads.resetScoreConfig()\">Reset to Default</button>\n            <button class=\"uba-btn uba-btn-primary\" onclick=\"window.UBAEnhancedLeads.saveScoreConfig()\">Save Configuration</button>\n          </div>\n        </div>\n      `;\n      \n      document.body.appendChild(modal);\n    },\n    \n    /**\n     * Calculate lead score\n     */\n    calculateLeadScore(lead) {\n      let totalScore = 0;\n      \n      for (const [category, config] of Object.entries(this.leadScoreConfig)) {\n        const categoryScore = this.calculateCategoryScore(lead, category, config);\n        const weightedScore = (categoryScore * config.weight) / 100;\n        totalScore += weightedScore;\n      }\n      \n      return Math.min(Math.round(totalScore), 100);\n    },\n    \n    /**\n     * Calculate category score\n     */\n    calculateCategoryScore(lead, category, config) {\n      const leadValue = lead.scoring?.[category] || this.inferCategoryValue(lead, category);\n      return config.criteria[leadValue] || 0;\n    },\n    \n    /**\n     * Infer category value from lead data\n     */\n    inferCategoryValue(lead, category) {\n      switch (category) {\n        case 'budget':\n          if (lead.budget) {\n            if (lead.budget < 1000) return 'under_1k';\n            if (lead.budget < 5000) return '1k_5k';\n            if (lead.budget < 15000) return '5k_15k';\n            if (lead.budget < 50000) return '15k_50k';\n            return 'over_50k';\n          }\n          return 'under_1k';\n          \n        case 'company':\n          if (lead.companySize) {\n            if (lead.companySize === 'Enterprise') return 'enterprise';\n            if (lead.companySize === 'Medium') return 'medium_business';\n            if (lead.companySize === 'Small') return 'small_business';\n          }\n          return 'startup';\n          \n        case 'timeline':\n          if (lead.timeline) {\n            if (lead.timeline.includes('immediate')) return 'immediate';\n            if (lead.timeline.includes('quarter')) return 'this_quarter';\n            if (lead.timeline.includes('year')) return 'this_year';\n          }\n          return 'no_timeline';\n          \n        default:\n          return Object.keys(this.leadScoreConfig[category]?.criteria || {})[0] || '';\n      }\n    },\n    \n    /**\n     * Calculate all lead scores\n     */\n    calculateAllLeadScores() {\n      this.leads.forEach(lead => {\n        lead.score = this.calculateLeadScore(lead);\n        lead.scoreUpdated = new Date().toISOString();\n      });\n      \n      // Update scoring metrics\n      this.updateScoringMetrics();\n    },\n    \n    /**\n     * Update scoring metrics display\n     */\n    updateScoringMetrics() {\n      const scores = this.leads.map(lead => lead.score || 0).filter(score => score > 0);\n      \n      if (scores.length === 0) return;\n      \n      const avgScore = Math.round(scores.reduce((sum, score) => sum + score, 0) / scores.length);\n      const highQuality = scores.filter(score => score >= 80).length;\n      const mediumQuality = scores.filter(score => score >= 50 && score < 80).length;\n      const lowQuality = scores.filter(score => score < 50).length;\n      \n      // Update UI\n      this.updateElement('avg-lead-score', avgScore);\n      this.updateElement('high-quality-leads', highQuality);\n      this.updateElement('medium-quality-leads', mediumQuality);\n      this.updateElement('low-quality-leads', lowQuality);\n    },\n    \n    /**\n     * Setup contact logging system\n     */\n    setupContactLogging() {\n      console.log('üí¨ Setting up contact logging system');\n      \n      // Add contact log interface to lead details\n      this.enhanceLeadDetailsWithLogs();\n    },\n    \n    /**\n     * Enhance lead details with contact logs\n     */\n    enhanceLeadDetailsWithLogs() {\n      // This will be added to the lead modal when opened\n      // We'll inject the contact log section dynamically\n    },\n    \n    /**\n     * Add contact log section to lead modal\n     */\n    addContactLogToModal(leadId) {\n      const modal = document.getElementById('lead-modal');\n      if (!modal) return;\n      \n      // Check if contact log section already exists\n      if (modal.querySelector('.contact-log-section')) return;\n      \n      const modalBody = modal.querySelector('.uba-modal-body');\n      if (!modalBody) return;\n      \n      const contactLogSection = document.createElement('div');\n      contactLogSection.className = 'contact-log-section';\n      contactLogSection.innerHTML = `\n        <div class=\"contact-log-tabs\">\n          <button class=\"log-tab active\" data-tab=\"timeline\">üìã Timeline</button>\n          <button class=\"log-tab\" data-tab=\"conversations\">üí¨ Conversations</button>\n          <button class=\"log-tab\" data-tab=\"notes\">üìù Notes</button>\n          <button class=\"log-tab\" data-tab=\"activities\">üéØ Activities</button>\n        </div>\n        \n        <div class=\"contact-log-content\">\n          <!-- Timeline Tab -->\n          <div class=\"log-tab-content active\" data-tab=\"timeline\">\n            <div class=\"timeline-header\">\n              <h4>ŸÖÿ≠ÿßÿØÿ´ÿßÿ™ ‚Äì ŸÖŸÑÿßÿ≠ÿ∏ÿßÿ™ ‚Äì ŸÜÿ¥ÿßÿ∑ (Contact Timeline)</h4>\n              <button class=\"uba-btn uba-btn-sm uba-btn-primary\" onclick=\"window.UBAEnhancedLeads.addTimelineEntry('${leadId}')\">\n                + Add Entry\n              </button>\n            </div>\n            <div id=\"timeline-${leadId}\" class=\"contact-timeline\">\n              <!-- Timeline entries will be rendered here -->\n            </div>\n          </div>\n          \n          <!-- Conversations Tab -->\n          <div class=\"log-tab-content\" data-tab=\"conversations\">\n            <div class=\"conversations-header\">\n              <h4>Conversation History</h4>\n              <button class=\"uba-btn uba-btn-sm uba-btn-primary\" onclick=\"window.UBAEnhancedLeads.addConversation('${leadId}')\">\n                + New Conversation\n              </button>\n            </div>\n            <div id=\"conversations-${leadId}\" class=\"conversations-list\">\n              <!-- Conversations will be rendered here -->\n            </div>\n          </div>\n          \n          <!-- Notes Tab -->\n          <div class=\"log-tab-content\" data-tab=\"notes\">\n            <div class=\"notes-header\">\n              <h4>Internal Notes</h4>\n              <button class=\"uba-btn uba-btn-sm uba-btn-primary\" onclick=\"window.UBAEnhancedLeads.addNote('${leadId}')\">\n                + Add Note\n              </button>\n            </div>\n            <div id=\"notes-${leadId}\" class=\"notes-list\">\n              <!-- Notes will be rendered here -->\n            </div>\n          </div>\n          \n          <!-- Activities Tab -->\n          <div class=\"log-tab-content\" data-tab=\"activities\">\n            <div class=\"activities-header\">\n              <h4>Activities & Follow-ups</h4>\n              <button class=\"uba-btn uba-btn-sm uba-btn-primary\" onclick=\"window.UBAEnhancedLeads.scheduleActivity('${leadId}')\">\n                + Schedule Activity\n              </button>\n            </div>\n            <div id=\"activities-${leadId}\" class=\"activities-list\">\n              <!-- Activities will be rendered here -->\n            </div>\n          </div>\n        </div>\n      `;\n      \n      modalBody.appendChild(contactLogSection);\n      \n      // Setup tab switching\n      this.setupContactLogTabs();\n      \n      // Render existing logs\n      this.renderContactLogs(leadId);\n    },\n    \n    /**\n     * Setup contact log tabs\n     */\n    setupContactLogTabs() {\n      const tabs = document.querySelectorAll('.log-tab');\n      const contents = document.querySelectorAll('.log-tab-content');\n      \n      tabs.forEach(tab => {\n        tab.addEventListener('click', () => {\n          const targetTab = tab.getAttribute('data-tab');\n          \n          // Update tab states\n          tabs.forEach(t => t.classList.remove('active'));\n          tab.classList.add('active');\n          \n          // Update content states\n          contents.forEach(content => {\n            content.classList.remove('active');\n            if (content.getAttribute('data-tab') === targetTab) {\n              content.classList.add('active');\n            }\n          });\n        });\n      });\n    },\n    \n    /**\n     * Add timeline entry\n     */\n    addTimelineEntry(leadId) {\n      const entry = {\n        id: 'timeline-' + Date.now(),\n        leadId: leadId,\n        type: 'timeline',\n        timestamp: new Date().toISOString(),\n        title: prompt('Enter timeline entry title:'),\n        description: prompt('Enter description (optional):') || '',\n        category: 'general'\n      };\n      \n      if (entry.title) {\n        this.contactLogs.push(entry);\n        this.saveContactLogs();\n        this.renderContactLogs(leadId);\n      }\n    },\n    \n    /**\n     * Add conversation\n     */\n    addConversation(leadId) {\n      const conversation = {\n        id: 'conv-' + Date.now(),\n        leadId: leadId,\n        type: 'conversation',\n        timestamp: new Date().toISOString(),\n        medium: prompt('Communication medium (email, phone, meeting):') || 'email',\n        summary: prompt('Conversation summary:'),\n        outcome: prompt('Outcome/Next steps:') || '',\n        participants: ['User'] // Could be enhanced to include multiple participants\n      };\n      \n      if (conversation.summary) {\n        this.contactLogs.push(conversation);\n        this.saveContactLogs();\n        this.renderContactLogs(leadId);\n      }\n    },\n    \n    /**\n     * Add note\n     */\n    addNote(leadId) {\n      const note = {\n        id: 'note-' + Date.now(),\n        leadId: leadId,\n        type: 'note',\n        timestamp: new Date().toISOString(),\n        content: prompt('Enter note content:'),\n        category: prompt('Note category (research, follow-up, technical):') || 'general',\n        private: confirm('Make this note private (internal only)?')\n      };\n      \n      if (note.content) {\n        this.contactLogs.push(note);\n        this.saveContactLogs();\n        this.renderContactLogs(leadId);\n      }\n    },\n    \n    /**\n     * Schedule activity\n     */\n    scheduleActivity(leadId) {\n      const activity = {\n        id: 'activity-' + Date.now(),\n        leadId: leadId,\n        type: 'activity',\n        timestamp: new Date().toISOString(),\n        activityType: prompt('Activity type (call, demo, meeting, proposal):') || 'call',\n        title: prompt('Activity title:'),\n        scheduledFor: prompt('Schedule for (YYYY-MM-DD HH:MM):'),\n        description: prompt('Activity description:') || '',\n        status: 'scheduled'\n      };\n      \n      if (activity.title) {\n        this.contactLogs.push(activity);\n        this.saveContactLogs();\n        this.renderContactLogs(leadId);\n      }\n    },\n    \n    /**\n     * Render contact logs for a specific lead\n     */\n    renderContactLogs(leadId) {\n      const leadLogs = this.contactLogs.filter(log => log.leadId === leadId);\n      \n      // Render timeline\n      this.renderTimeline(leadId, leadLogs);\n      \n      // Render conversations\n      this.renderConversations(leadId, leadLogs.filter(log => log.type === 'conversation'));\n      \n      // Render notes\n      this.renderNotes(leadId, leadLogs.filter(log => log.type === 'note'));\n      \n      // Render activities\n      this.renderActivities(leadId, leadLogs.filter(log => log.type === 'activity'));\n    },\n    \n    /**\n     * Render timeline\n     */\n    renderTimeline(leadId, logs) {\n      const timeline = document.getElementById(`timeline-${leadId}`);\n      if (!timeline) return;\n      \n      const sortedLogs = logs.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));\n      \n      timeline.innerHTML = sortedLogs.map(log => {\n        const date = new Date(log.timestamp).toLocaleDateString();\n        const time = new Date(log.timestamp).toLocaleTimeString();\n        const icon = this.getLogIcon(log.type);\n        \n        return `\n          <div class=\"timeline-entry ${log.type}\">\n            <div class=\"timeline-marker\">${icon}</div>\n            <div class=\"timeline-content\">\n              <div class=\"timeline-header\">\n                <strong>${log.title || log.summary || log.content || 'Activity'}</strong>\n                <span class=\"timeline-time\">${date} ${time}</span>\n              </div>\n              ${log.description || log.outcome || log.category ? `\n                <div class=\"timeline-details\">\n                  ${log.description || log.outcome || log.category}\n                </div>\n              ` : ''}\n            </div>\n          </div>\n        `;\n      }).join('');\n    },\n    \n    /**\n     * Get icon for log type\n     */\n    getLogIcon(type) {\n      const icons = {\n        'timeline': 'üìã',\n        'conversation': 'üí¨',\n        'note': 'üìù',\n        'activity': 'üéØ'\n      };\n      return icons[type] || 'üìå';\n    },\n    \n    /**\n     * Save contact logs to localStorage\n     */\n    saveContactLogs() {\n      try {\n        localStorage.setItem('uba-contact-logs', JSON.stringify(this.contactLogs));\n      } catch (error) {\n        console.error('‚ùå Failed to save contact logs:', error);\n      }\n    },\n    \n    /**\n     * Setup project integration\n     */\n    setupProjectIntegration() {\n      console.log('üîó Setting up project integration');\n      \n      // Add project conversion functionality\n      this.addProjectConversionInterface();\n      \n      // Load existing projects for linking\n      this.loadProjectsData();\n    },\n    \n    /**\n     * Add project conversion interface\n     */\n    addProjectConversionInterface() {\n      // This will be added to lead modal and table actions\n      // Enhanced when lead modal is opened\n    },\n    \n    /**\n     * Convert lead to project\n     */\n    convertLeadToProject(leadId) {\n      const lead = this.leads.find(l => l.id === leadId);\n      if (!lead) return;\n      \n      const project = {\n        id: 'proj-' + Date.now(),\n        name: lead.company + ' Project',\n        client: lead.name,\n        clientCompany: lead.company,\n        email: lead.email,\n        phone: lead.phone,\n        description: `Project converted from lead: ${lead.description || 'No description'}`,\n        stage: 'planning',\n        status: 'active',\n        budget: lead.budget || 0,\n        startDate: new Date().toISOString().slice(0, 10),\n        priority: this.getProjectPriority(lead.score),\n        leadId: leadId,\n        createdAt: new Date().toISOString(),\n        tags: ['converted-from-lead']\n      };\n      \n      // Save project\n      if (window.ubaStore?.projects) {\n        window.ubaStore.projects.create(project);\n      }\n      \n      // Update lead status\n      lead.status = 'converted';\n      lead.projectId = project.id;\n      lead.convertedAt = new Date().toISOString();\n      \n      // Add conversion log\n      this.contactLogs.push({\n        id: 'conv-log-' + Date.now(),\n        leadId: leadId,\n        type: 'timeline',\n        timestamp: new Date().toISOString(),\n        title: 'Lead converted to project',\n        description: `Project \"${project.name}\" created`,\n        category: 'conversion'\n      });\n      \n      this.saveContactLogs();\n      \n      this.showNotification(`Lead successfully converted to project: \"${project.name}\"`, 'success');\n      \n      // Offer to navigate to projects\n      if (confirm('Would you like to view the new project?')) {\n        window.location.href = `projects.html?id=${project.id}`;\n      }\n    },\n    \n    /**\n     * Get project priority based on lead score\n     */\n    getProjectPriority(score) {\n      if (score >= 80) return 'high';\n      if (score >= 60) return 'medium';\n      return 'low';\n    },\n    \n    /**\n     * Enhance table view\n     */\n    enhanceTableView() {\n      console.log('üìä Enhancing table view');\n      \n      // Add advanced filtering and sorting\n      this.addAdvancedFilters();\n      \n      // Add bulk actions\n      this.addBulkActions();\n      \n      // Enhance table columns\n      this.enhanceTableColumns();\n      \n      // Add export functionality\n      this.addExportFunctionality();\n    },\n    \n    /**\n     * Add advanced filters\n     */\n    addAdvancedFilters() {\n      const leadsCard = document.querySelector('#leads-page .uba-card');\n      if (!leadsCard) return;\n      \n      const filtersSection = document.createElement('div');\n      filtersSection.className = 'leads-filters';\n      filtersSection.innerHTML = `\n        <div class=\"filters-row\">\n          <div class=\"filter-group\">\n            <label>Score Range</label>\n            <select id=\"score-filter\" class=\"uba-select enhanced-dropdown\">\n              <option value=\"\">All Scores</option>\n              <option value=\"high\">High (80-100)</option>\n              <option value=\"medium\">Medium (50-79)</option>\n              <option value=\"low\">Low (0-49)</option>\n            </select>\n          </div>\n          \n          <div class=\"filter-group\">\n            <label>Status</label>\n            <select id=\"status-filter\" class=\"uba-select enhanced-dropdown\">\n              <option value=\"\">All Statuses</option>\n              <option value=\"new\">New</option>\n              <option value=\"contacted\">Contacted</option>\n              <option value=\"qualified\">Qualified</option>\n              <option value=\"proposal\">Proposal</option>\n              <option value=\"negotiation\">Negotiation</option>\n              <option value=\"won\">Won</option>\n              <option value=\"lost\">Lost</option>\n              <option value=\"converted\">Converted</option>\n            </select>\n          </div>\n          \n          <div class=\"filter-group\">\n            <label>Source</label>\n            <select id=\"source-filter\" class=\"uba-select enhanced-dropdown\">\n              <option value=\"\">All Sources</option>\n              <option value=\"website\">Website</option>\n              <option value=\"referral\">Referral</option>\n              <option value=\"social\">Social Media</option>\n              <option value=\"email\">Email Campaign</option>\n              <option value=\"event\">Event/Conference</option>\n              <option value=\"cold_call\">Cold Call</option>\n              <option value=\"other\">Other</option>\n            </select>\n          </div>\n          \n          <div class=\"filter-group\">\n            <label>Date Range</label>\n            <select id=\"date-filter\" class=\"uba-select enhanced-dropdown\">\n              <option value=\"\">All Time</option>\n              <option value=\"today\">Today</option>\n              <option value=\"week\">This Week</option>\n              <option value=\"month\">This Month</option>\n              <option value=\"quarter\">This Quarter</option>\n            </select>\n          </div>\n          \n          <div class=\"filter-actions\">\n            <button class=\"uba-btn uba-btn-ghost\" onclick=\"window.UBAEnhancedLeads.clearFilters()\">Clear</button>\n            <button class=\"uba-btn uba-btn-primary\" onclick=\"window.UBAEnhancedLeads.applyFilters()\">Apply Filters</button>\n          </div>\n        </div>\n      `;\n      \n      // Insert after card header\n      const cardBody = leadsCard.querySelector('.uba-card-body') || leadsCard;\n      cardBody.insertBefore(filtersSection, cardBody.firstChild);\n    },\n    \n    /**\n     * Add bulk actions\n     */\n    addBulkActions() {\n      const leadsTable = document.querySelector('#leads-table');\n      if (!leadsTable) return;\n      \n      // Add checkbox column to table header\n      const thead = leadsTable.querySelector('thead tr');\n      if (thead) {\n        const checkboxTh = document.createElement('th');\n        checkboxTh.innerHTML = '<input type=\"checkbox\" id=\"select-all-leads\" onchange=\"window.UBAEnhancedLeads.toggleSelectAll()\" />';\n        thead.insertBefore(checkboxTh, thead.firstChild);\n      }\n      \n      // Add bulk actions bar\n      const bulkActions = document.createElement('div');\n      bulkActions.id = 'bulk-actions-bar';\n      bulkActions.className = 'bulk-actions-bar hidden';\n      bulkActions.innerHTML = `\n        <div class=\"bulk-actions-content\">\n          <span class=\"selected-count\">0 leads selected</span>\n          <div class=\"bulk-action-buttons\">\n            <button class=\"uba-btn uba-btn-sm uba-btn-ghost\" onclick=\"window.UBAEnhancedLeads.bulkUpdateStatus()\">Update Status</button>\n            <button class=\"uba-btn uba-btn-sm uba-btn-ghost\" onclick=\"window.UBAEnhancedLeads.bulkAssignOwner()\">Assign Owner</button>\n            <button class=\"uba-btn uba-btn-sm uba-btn-primary\" onclick=\"window.UBAEnhancedLeads.bulkConvertToProjects()\">Convert to Projects</button>\n            <button class=\"uba-btn uba-btn-sm uba-btn-danger\" onclick=\"window.UBAEnhancedLeads.bulkDelete()\">Delete</button>\n          </div>\n          <button class=\"close-bulk-actions\" onclick=\"window.UBAEnhancedLeads.clearSelection()\">√ó</button>\n        </div>\n      `;\n      \n      leadsTable.parentNode.insertBefore(bulkActions, leadsTable);\n    },\n    \n    /**\n     * Enhance table columns with score display\n     */\n    enhanceTableColumns() {\n      // This will be done when rendering the table\n      // Add score column, improve status display, add action buttons\n    },\n    \n    /**\n     * Initialize UI components\n     */\n    initializeUI() {\n      // Update scoring metrics\n      setTimeout(() => {\n        this.updateScoringMetrics();\n      }, 500);\n      \n      // Enhance existing lead modal opening\n      this.enhanceLeadModalOpening();\n    },\n    \n    /**\n     * Enhance lead modal opening\n     */\n    enhanceLeadModalOpening() {\n      // Override the original openLeadModal function if it exists\n      const originalOpenModal = window.openLeadModal;\n      \n      window.openLeadModal = (leadData = null) => {\n        if (originalOpenModal) {\n          originalOpenModal(leadData);\n        }\n        \n        // Add our enhancements\n        if (leadData?.id) {\n          setTimeout(() => {\n            this.addContactLogToModal(leadData.id);\n            this.addProjectConversionToModal(leadData.id);\n          }, 100);\n        }\n      };\n    },\n    \n    /**\n     * Add project conversion to modal\n     */\n    addProjectConversionToModal(leadId) {\n      const modal = document.getElementById('lead-modal');\n      if (!modal || modal.querySelector('.project-conversion-section')) return;\n      \n      const lead = this.leads.find(l => l.id === leadId);\n      if (!lead) return;\n      \n      const conversionSection = document.createElement('div');\n      conversionSection.className = 'project-conversion-section';\n      conversionSection.innerHTML = `\n        <div class=\"conversion-card\">\n          <div class=\"conversion-header\">\n            <h4>üöÄ Project Conversion (ÿ±ÿ®ÿ∑ lead ÿ®ÿßŸÑŸÄ projects)</h4>\n            <div class=\"lead-score-display\">\n              <span class=\"score-label\">Score:</span>\n              <span class=\"score-badge score-${this.getScoreClass(lead.score || 0)}\">${lead.score || 0}</span>\n            </div>\n          </div>\n          \n          ${lead.status === 'converted' ? `\n            <div class=\"conversion-status converted\">\n              <span class=\"status-icon\">‚úÖ</span>\n              <span>Already converted to project</span>\n              ${lead.projectId ? `<button class=\"uba-btn uba-btn-sm uba-btn-ghost\" onclick=\"window.location.href='projects.html?id=${lead.projectId}'\">View Project</button>` : ''}\n            </div>\n          ` : `\n            <div class=\"conversion-actions\">\n              <p class=\"conversion-description\">Convert this lead to an active project with automated data transfer.</p>\n              <div class=\"conversion-preview\">\n                <div class=\"preview-item\">\n                  <strong>Project Name:</strong> ${lead.company} Project\n                </div>\n                <div class=\"preview-item\">\n                  <strong>Client:</strong> ${lead.name}\n                </div>\n                <div class=\"preview-item\">\n                  <strong>Budget:</strong> ‚Ç¨${lead.budget || 0}\n                </div>\n                <div class=\"preview-item\">\n                  <strong>Priority:</strong> ${this.getProjectPriority(lead.score || 0)}\n                </div>\n              </div>\n              <button class=\"uba-btn uba-btn-primary conversion-btn\" onclick=\"window.UBAEnhancedLeads.convertLeadToProject('${leadId}')\">\n                üöÄ Convert to Project\n              </button>\n            </div>\n          `}\n        </div>\n      `;\n      \n      const modalBody = modal.querySelector('.uba-modal-body');\n      if (modalBody) {\n        modalBody.appendChild(conversionSection);\n      }\n    },\n    \n    /**\n     * Get score class for styling\n     */\n    getScoreClass(score) {\n      if (score >= 80) return 'high';\n      if (score >= 50) return 'medium';\n      return 'low';\n    },\n    \n    // Utility methods\n    \n    /**\n     * Load projects data\n     */\n    loadProjectsData() {\n      this.projects = window.ubaStore?.projects?.getAll() || [];\n    },\n    \n    /**\n     * Get demo leads data\n     */\n    getDemoLeads() {\n      return [\n        {\n          id: 'lead-demo-1',\n          name: 'Ahmed Al-Rashid',\n          company: 'Tech Solutions MENA',\n          email: 'ahmed@techsolutions.ae',\n          phone: '+971-50-123-4567',\n          status: 'qualified',\n          source: 'website',\n          budget: 25000,\n          description: 'Looking for CRM automation solution',\n          createdAt: '2024-11-15T10:00:00Z',\n          score: 85\n        },\n        {\n          id: 'lead-demo-2',\n          name: 'Sarah Johnson',\n          company: 'Digital Marketing Pro',\n          email: 'sarah@digitalmarketingpro.com',\n          phone: '+1-555-0123',\n          status: 'contacted',\n          source: 'referral',\n          budget: 15000,\n          description: 'Needs marketing automation tools',\n          createdAt: '2024-11-18T14:30:00Z',\n          score: 72\n        }\n      ];\n    },\n    \n    /**\n     * Update element content safely\n     */\n    updateElement(id, value) {\n      const element = document.getElementById(id);\n      if (element) {\n        element.textContent = value;\n      }\n    },\n    \n    /**\n     * Show notification\n     */\n    showNotification(message, type = 'info', options = {}) {\n      if (window.showToast) {\n        window.showToast(message, type, options);\n      } else {\n        console.log(`${type.toUpperCase()}: ${message}`);\n      }\n    }\n  };\n  \n  // Auto-initialize when DOM is ready\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      setTimeout(() => window.UBAEnhancedLeads.init(), 1000);\n    });\n  } else {\n    setTimeout(() => window.UBAEnhancedLeads.init(), 1000);\n  }\n  \n  console.log('‚úÖ Enhanced Leads module loaded');\n  \n})();