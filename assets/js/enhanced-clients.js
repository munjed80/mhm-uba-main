// enhanced-clients.js ‚Äî Advanced client management with validation, custom fields, and cross-linking
(function() {
  'use strict';
  
  // Enhanced client management state
  let enhancedClientsState = {
    currentPage: 1,
    pageSize: 20,
    searchTerm: '',
    sortBy: 'name',
    sortOrder: 'asc',
    filteredClients: [],
    isEditing: false,
    editingId: null,
    customFields: [],
    showDuplicateWarning: false
  };
  
  /**
   * Initialize enhanced clients system
   */
  function initEnhancedClients() {
    console.log('üë• Initializing enhanced clients with advanced features');
    
    // Load custom fields configuration
    loadCustomFields();
    
    // Setup enhanced form validation
    setupEnhancedValidation();
    
    // Setup pagination and search
    setupAdvancedPagination();
    
    // Setup cross-linking features
    setupCrossLinking();
    
    // Initial render
    renderEnhancedClientsPage();
    
    console.log('‚úì Enhanced clients system initialized');
  }
  
  /**
   * Load custom fields configuration
   */
  function loadCustomFields() {\n    const saved = localStorage.getItem('uba-client-custom-fields');\n    enhancedClientsState.customFields = saved ? JSON.parse(saved) : getDefaultCustomFields();\n  }\n  \n  /**\n   * Get default custom fields\n   */\n  function getDefaultCustomFields() {\n    return [\n      { id: 'industry', label: 'Industry', type: 'select', options: ['Technology', 'Healthcare', 'Finance', 'Education', 'Other'], required: false },\n      { id: 'priority', label: 'Priority', type: 'select', options: ['High', 'Medium', 'Low'], required: false },\n      { id: 'source', label: 'Lead Source', type: 'select', options: ['Website', 'Referral', 'Social Media', 'Direct', 'Other'], required: false },\n      { id: 'budget', label: 'Budget Range', type: 'select', options: ['< ‚Ç¨1K', '‚Ç¨1K - ‚Ç¨5K', '‚Ç¨5K - ‚Ç¨10K', '‚Ç¨10K+'], required: false },\n      { id: 'website', label: 'Website', type: 'url', required: false },\n      { id: 'linkedin', label: 'LinkedIn', type: 'url', required: false }\n    ];\n  }\n  \n  /**\n   * Setup enhanced form validation with real-time feedback\n   */\n  function setupEnhancedValidation() {\n    const form = document.getElementById('clients-page-form');\n    if (!form) return;\n    \n    // Real-time validation on input\n    const inputs = form.querySelectorAll('input, textarea, select');\n    inputs.forEach(input => {\n      input.addEventListener('blur', () => {\n        validateClientField(input);\n      });\n      \n      input.addEventListener('input', () => {\n        // Clear previous errors on input\n        window.UBAValidation.clearFieldError(input.id);\n        \n        // Real-time duplicate detection for name, email, phone\n        if (['clients-name', 'clients-email', 'clients-phone'].includes(input.id)) {\n          setTimeout(() => checkForDuplicates(), 500);\n        }\n      });\n    });\n    \n    // Enhanced form submission\n    form.addEventListener('submit', handleEnhancedSubmit);\n  }\n  \n  /**\n   * Validate individual client field\n   */\n  function validateClientField(field) {\n    const clientData = getCurrentFormData();\n    const existingClients = window.ubaStore?.clients?.getAll() || [];\n    \n    if (window.UBAValidation && window.UBAValidation.validateClient) {\n      const validation = window.UBAValidation.validateClient(\n        clientData, \n        existingClients, \n        enhancedClientsState.editingId\n      );\n      \n      // Show field-specific errors\n      const fieldName = field.id.replace('clients-', '');\n      if (validation.errors[fieldName]) {\n        window.UBAValidation.showFieldError(field.id, validation.errors[fieldName]);\n      }\n      \n      // Show warnings\n      if (validation.warnings.length > 0) {\n        showValidationWarnings(validation.warnings);\n      }\n    }\n  }\n  \n  /**\n   * Check for duplicates in real-time\n   */\n  function checkForDuplicates() {\n    const clientData = getCurrentFormData();\n    const existingClients = window.ubaStore?.clients?.getAll() || [];\n    \n    if (window.UBAValidation && window.UBAValidation.findClientDuplicates) {\n      const duplicates = window.UBAValidation.findClientDuplicates(\n        clientData, \n        existingClients, \n        enhancedClientsState.editingId\n      );\n      \n      if (duplicates.length > 0) {\n        showDuplicateWarning(duplicates[0]);\n      } else {\n        hideDuplicateWarning();\n      }\n    }\n  }\n  \n  /**\n   * Show duplicate warning\n   */\n  function showDuplicateWarning(duplicate) {\n    enhancedClientsState.showDuplicateWarning = true;\n    \n    // Create warning element if it doesn't exist\n    let warningEl = document.getElementById('duplicate-warning');\n    if (!warningEl) {\n      warningEl = document.createElement('div');\n      warningEl.id = 'duplicate-warning';\n      warningEl.className = 'uba-warning-banner';\n      \n      const form = document.getElementById('clients-page-form');\n      if (form) {\n        form.insertBefore(warningEl, form.firstChild);\n      }\n    }\n    \n    warningEl.innerHTML = `\n      <div class=\"uba-warning-content\">\n        <span class=\"uba-warning-icon\">‚ö†Ô∏è</span>\n        <div>\n          <strong>Potential Duplicate Client</strong>\n          <p>Similar client found: ${duplicate.name} (${duplicate.email || duplicate.phone || 'no contact info'})</p>\n        </div>\n        <button type=\"button\" class=\"uba-btn-sm uba-btn-ghost\" onclick=\"viewSimilarClient('${duplicate.id}')\">\n          View Similar\n        </button>\n      </div>\n    `;\n    \n    warningEl.style.display = 'block';\n  }\n  \n  /**\n   * Hide duplicate warning\n   */\n  function hideDuplicateWarning() {\n    enhancedClientsState.showDuplicateWarning = false;\n    const warningEl = document.getElementById('duplicate-warning');\n    if (warningEl) {\n      warningEl.style.display = 'none';\n    }\n  }\n  \n  /**\n   * View similar client\n   */\n  function viewSimilarClient(clientId) {\n    const clients = window.ubaStore?.clients?.getAll() || [];\n    const client = clients.find(c => c.id === clientId);\n    \n    if (client) {\n      // Show client details in a modal or sidebar\n      showClientDetails(client);\n    }\n  }\n  \n  /**\n   * Get current form data\n   */\n  function getCurrentFormData() {\n    const form = document.getElementById('clients-page-form');\n    if (!form) return {};\n    \n    const formData = new FormData(form);\n    const data = {};\n    \n    // Standard fields\n    data.name = document.getElementById('clients-name')?.value?.trim() || '';\n    data.email = document.getElementById('clients-email')?.value?.trim() || '';\n    data.company = document.getElementById('clients-company')?.value?.trim() || '';\n    data.phone = document.getElementById('clients-phone')?.value?.trim() || '';\n    data.notes = document.getElementById('clients-notes')?.value?.trim() || '';\n    \n    // Custom fields\n    enhancedClientsState.customFields.forEach(field => {\n      const fieldEl = document.getElementById(`custom-${field.id}`);\n      if (fieldEl) {\n        data[field.id] = fieldEl.value?.trim() || '';\n      }\n    });\n    \n    return data;\n  }\n  \n  /**\n   * Setup advanced pagination with better UX\n   */\n  function setupAdvancedPagination() {\n    // Search functionality\n    const searchInput = document.getElementById('clients-search');\n    if (searchInput) {\n      searchInput.addEventListener('input', (e) => {\n        enhancedClientsState.searchTerm = e.target.value;\n        enhancedClientsState.currentPage = 1;\n        applyFiltersAndRender();\n      });\n    }\n    \n    // Sort functionality\n    const sortSelect = document.getElementById('clients-sort');\n    if (sortSelect) {\n      sortSelect.addEventListener('change', (e) => {\n        const [sortBy, sortOrder] = e.target.value.split('_');\n        enhancedClientsState.sortBy = sortBy;\n        enhancedClientsState.sortOrder = sortOrder;\n        applyFiltersAndRender();\n      });\n    }\n    \n    // Page size selector\n    const pageSizeSelect = document.getElementById('clients-page-size');\n    if (pageSizeSelect) {\n      pageSizeSelect.addEventListener('change', (e) => {\n        enhancedClientsState.pageSize = parseInt(e.target.value);\n        enhancedClientsState.currentPage = 1;\n        applyFiltersAndRender();\n      });\n    }\n  }\n  \n  /**\n   * Setup cross-linking with projects and invoices\n   */\n  function setupCrossLinking() {\n    // This will be implemented to show related projects and invoices\n    // when viewing or editing a client\n  }\n  \n  /**\n   * Apply filters and re-render\n   */\n  function applyFiltersAndRender() {\n    const allClients = window.ubaStore?.clients?.getAll() || [];\n    \n    // Apply search filter\n    let filtered = allClients.filter(client => {\n      if (!enhancedClientsState.searchTerm) return true;\n      \n      const searchLower = enhancedClientsState.searchTerm.toLowerCase();\n      return (\n        client.name?.toLowerCase().includes(searchLower) ||\n        client.email?.toLowerCase().includes(searchLower) ||\n        client.company?.toLowerCase().includes(searchLower) ||\n        client.phone?.toLowerCase().includes(searchLower)\n      );\n    });\n    \n    // Apply sorting\n    filtered.sort((a, b) => {\n      const aVal = a[enhancedClientsState.sortBy] || '';\n      const bVal = b[enhancedClientsState.sortBy] || '';\n      \n      if (enhancedClientsState.sortOrder === 'asc') {\n        return aVal.toString().localeCompare(bVal.toString());\n      } else {\n        return bVal.toString().localeCompare(aVal.toString());\n      }\n    });\n    \n    enhancedClientsState.filteredClients = filtered;\n    renderEnhancedClientsPage();\n  }\n  \n  /**\n   * Render enhanced clients page\n   */\n  function renderEnhancedClientsPage() {\n    renderClientsToolbar();\n    renderClientsTable();\n    renderPaginationControls();\n  }\n  \n  /**\n   * Render clients toolbar with search and filters\n   */\n  function renderClientsToolbar() {\n    // Implementation will be added to render the enhanced toolbar\n  }\n  \n  /**\n   * Enhanced form submission handler\n   */\n  function handleEnhancedSubmit(e) {\n    e.preventDefault();\n    \n    const clientData = getCurrentFormData();\n    const existingClients = window.ubaStore?.clients?.getAll() || [];\n    \n    // Comprehensive validation\n    if (window.UBAValidation && window.UBAValidation.validateClient) {\n      const validation = window.UBAValidation.validateClient(\n        clientData, \n        existingClients, \n        enhancedClientsState.editingId\n      );\n      \n      if (!validation.isValid) {\n        // Show all errors\n        Object.keys(validation.errors).forEach(field => {\n          const fieldId = field === 'name' ? 'clients-name' : \n                         field === 'email' ? 'clients-email' :\n                         field === 'phone' ? 'clients-phone' :\n                         field === 'company' ? 'clients-company' :\n                         field === 'notes' ? 'clients-notes' : \n                         `custom-${field}`;\n          \n          if (fieldId !== 'duplicate') {\n            window.UBAValidation.showFieldError(fieldId, validation.errors[field]);\n          }\n        });\n        \n        // Handle duplicate error specially\n        if (validation.errors.duplicate) {\n          showDuplicateError(validation.errors.duplicate);\n        }\n        \n        return;\n      }\n      \n      // Show warnings but allow submission\n      if (validation.warnings.length > 0) {\n        showValidationWarnings(validation.warnings);\n      }\n    }\n    \n    // Proceed with saving\n    saveEnhancedClient(clientData);\n  }\n  \n  /**\n   * Save enhanced client with custom fields\n   */\n  function saveEnhancedClient(clientData) {\n    try {\n      const store = window.ubaStore;\n      if (!store || !store.clients) {\n        throw new Error('Client store not available');\n      }\n      \n      if (enhancedClientsState.isEditing && enhancedClientsState.editingId) {\n        // Update existing client\n        store.clients.update(enhancedClientsState.editingId, clientData);\n        console.log('‚úì Client updated successfully');\n      } else {\n        // Create new client\n        const newClient = {\n          ...clientData,\n          id: generateClientId(),\n          created_at: new Date().toISOString(),\n          updated_at: new Date().toISOString()\n        };\n        \n        store.clients.add(newClient);\n        console.log('‚úì New client created successfully');\n      }\n      \n      // Reset form and state\n      resetClientForm();\n      applyFiltersAndRender();\n      \n      // Show success message\n      showSuccessMessage(enhancedClientsState.isEditing ? 'Client updated successfully' : 'Client created successfully');\n      \n    } catch (error) {\n      console.error('Error saving client:', error);\n      showErrorMessage('Failed to save client. Please try again.');\n    }\n  }\n  \n  /**\n   * Generate unique client ID\n   */\n  function generateClientId() {\n    return 'client_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);\n  }\n  \n  /**\n   * Reset client form and editing state\n   */\n  function resetClientForm() {\n    enhancedClientsState.isEditing = false;\n    enhancedClientsState.editingId = null;\n    \n    const form = document.getElementById('clients-page-form');\n    if (form) {\n      form.reset();\n    }\n    \n    // Clear all validation errors\n    const errorElements = document.querySelectorAll('.uba-field-error');\n    errorElements.forEach(el => el.remove());\n    \n    const inputElements = document.querySelectorAll('.uba-input-error');\n    inputElements.forEach(el => el.classList.remove('uba-input-error'));\n    \n    hideDuplicateWarning();\n  }\n  \n  /**\n   * Show success message\n   */\n  function showSuccessMessage(message) {\n    // Implementation to show success notification\n    if (window.UBANotifications) {\n      window.UBANotifications.show(message, 'success');\n    }\n  }\n  \n  /**\n   * Show error message\n   */\n  function showErrorMessage(message) {\n    // Implementation to show error notification\n    if (window.UBANotifications) {\n      window.UBANotifications.show(message, 'error');\n    }\n  }\n  \n  /**\n   * Show validation warnings\n   */\n  function showValidationWarnings(warnings) {\n    warnings.forEach(warning => {\n      if (window.UBANotifications) {\n        window.UBANotifications.show(warning, 'warning');\n      }\n    });\n  }\n  \n  /**\n   * Show duplicate error\n   */\n  function showDuplicateError(message) {\n    const form = document.getElementById('clients-page-form');\n    if (form) {\n      let errorEl = document.getElementById('duplicate-error');\n      if (!errorEl) {\n        errorEl = document.createElement('div');\n        errorEl.id = 'duplicate-error';\n        errorEl.className = 'uba-error-banner';\n        form.insertBefore(errorEl, form.firstChild);\n      }\n      \n      errorEl.innerHTML = `\n        <span class=\"uba-error-icon\">‚ùå</span>\n        <span>${message}</span>\n        <button type=\"button\" onclick=\"this.parentElement.style.display='none'\">√ó</button>\n      `;\n      errorEl.style.display = 'block';\n    }\n  }\n  \n  // Expose enhanced clients API\n  window.UBAEnhancedClients = {\n    init: initEnhancedClients,\n    viewSimilarClient: viewSimilarClient,\n    resetForm: resetClientForm\n  };\n  \n  // Auto-initialize if on clients page\n  if (document.readyState === 'loading') {\n    document.addEventListener('DOMContentLoaded', () => {\n      if (document.getElementById('clients-page-form')) {\n        initEnhancedClients();\n      }\n    });\n  } else if (document.getElementById('clients-page-form')) {\n    initEnhancedClients();\n  }\n  \n  console.log('‚úì Enhanced Clients module loaded');\n  \n})();